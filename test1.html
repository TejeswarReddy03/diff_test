<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Analysis - Extension Analysis Machine</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="/static/css/analysis.css">
     <style>
        /* here1 */
        .whois-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 1rem;
}

.whois-section {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.nameservers-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .whois-grid {
        grid-template-columns: 1fr;
    }
    
    .nameservers-list {
        grid-template-columns: 1fr;
    }
}
        /* Google Maps integration styles */
.map-view-button {
    transition: all 0.2s ease;
}

.map-view-button:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.developer-map-container {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
        
    .details-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }
    
    .details-popup-container {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        max-height: 80vh;
        width: 90%;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: popupSlideIn 0.3s ease-out;
    }
    
    @keyframes popupSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    .details-popup-header {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8fafc;
        border-radius: 12px 12px 0 0;
    }
    
    .details-popup-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .details-popup-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .details-popup-close:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    .details-popup-body {
        padding: 24px;
        line-height: 1.6;
        color: #374151;
    }
    
    .details-popup-body pre {
        background: #f3f4f6;
        padding: 16px;
        border-radius: 8px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.9rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .details-click-link {
        color: #3b82f6;
        text-decoration: none;
        cursor: pointer;
        font-weight: 500;
        transition: color 0.2s ease;
    }
    
    .details-click-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }
                        /* Code Diff Table Styles */
#code_diff .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 2rem;
    color: #6b7280;
}

#code_diff .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #342e7c;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
                           </style>
    
    <!-- Monaco Editor - Official VS Code Editor with Fast Loading -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <!-- JSZip with AMD conflict resolution -->
    <script>
        // AMD Conflict Management for Monaco Editor + JSZip
        window.JSZipAMDManager = {
            originalDefine: window.define,
            originalRequire: window.require,
            
            disableAMD: function() {
                window.define = undefined;
                window.require = undefined;
                console.log('üîß AMD disabled for JSZip loading (Monaco conflict resolution)');
            },
            
            restoreAMD: function() {
                window.define = this.originalDefine;
                window.require = this.originalRequire;
                console.log('‚úÖ AMD restored after JSZip loading');
            }
        };
        
        function loadJSZipWithAMDHandling() {
            console.log('üîß Loading JSZip with AMD conflict resolution...');
            
            // Disable AMD to prevent Monaco Editor conflicts
            window.JSZipAMDManager.disableAMD();
            
            // Try primary CDN first
            const script1 = document.createElement('script');
            script1.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
            script1.onload = function() {
                console.log('üì¶ JSZip script loaded from primary CDN');
                setTimeout(() => {
                    if (typeof JSZip !== 'undefined') {
                        window.JSZip = JSZip;
                        window.JSZipLoaded = true;
                        console.log('‚úÖ JSZip loaded successfully and assigned to window');
                        window.JSZipAMDManager.restoreAMD();
                    } else {
                        console.log('‚ùå JSZip not available after primary load, trying fallback...');
                        loadJSZipFallbackWithAMD();
                    }
                }, 300);
            };
            script1.onerror = function() {
                console.error('‚ùå Primary JSZip CDN failed, trying fallback...');
                loadJSZipFallbackWithAMD();
            };
            document.head.appendChild(script1);
        }
        
        function loadJSZipFallbackWithAMD() {
            console.log('üîÑ Trying fallback CDN with AMD disabled...');
            
            const script2 = document.createElement('script');
            script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script2.onload = function() {
                console.log('üì¶ JSZip script loaded from fallback CDN');
                setTimeout(() => {
                    if (typeof JSZip !== 'undefined') {
                        window.JSZip = JSZip;
                        window.JSZipLoaded = true;
                        console.log('‚úÖ JSZip loaded successfully from fallback');
                        window.JSZipAMDManager.restoreAMD();
                    } else {
                        console.error('‚ùå JSZip failed to load from both CDNs');
                        window.JSZipLoaded = false;
                        window.JSZipAMDManager.restoreAMD();
                    }
                }, 300);
            };
            script2.onerror = function() {
                console.error('‚ùå Fallback JSZip CDN also failed');
                window.JSZipLoaded = false;
                window.JSZipAMDManager.restoreAMD();
            };
            document.head.appendChild(script2);
        }
        
        // Load JSZip with AMD handling
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadJSZipWithAMDHandling);
        } else {
            loadJSZipWithAMDHandling();
        }
    </script>
    
    <!-- External JavaScript Modules -->
    <script src="/static/js/file-viewer.js"></script>
</head>

<body>
    <!-- Header - Same as home page -->
    <div class="header">
        <div class="header-inner">
            <div class="header-left">
                <h1><a href="/">Extension Analysis Machine</a></h1>
                <img src="/static/images/powered-by-squarex-svg.svg" alt="Powered by SquareX" class="powered-by">
            </div>
            <div class="header-right">
                <a href="/extensions" class="extension-list-btn" id="extensionListBtn" style="display: none;">Extension List</a>
                <a href="/semantic-search" class="extension-list-btn">Semantic Search</a>
                <div id="userInfo" class="user-info" style="display: none;">
                    <span class="user-email" id="userEmail"></span>
                    <a href="/logout" class="logout-btn">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Extension Header -->
        <div class="extension-header">
            <img id="extensionIcon" src="" alt="Extension Icon" class="extension-icon">
            <div class="extension-info">
                <h1 id="extensionName">Loading...</h1>
                <div class="extension-meta">
    <span>Version: <strong id="extensionVersion">-</strong></span>
    <span class="rating">‚òÖ <span id="extensionRating">-</span> (<span id="ratingCount">-</span> reviews)</span>
    <span><span id="userCount">-</span> users</span>
    <span>Size: <strong id="extensionSize">-</strong></span>
    
</div>
                <div class="extension-badges" id="extensionBadges">
                    <!-- Dynamic badges will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="overview">Overview</button>
                <button class="tab-button" data-tab="vulnerabilities">Vulnerabilities</button>
                <button class="tab-button" data-tab="code-analysis">Code Analysis</button>
                <button class="tab-button" data-tab="dynamic-analysis">Dynamic Analysis</button>
                <button class="tab-button" data-tab="file-viewer">üìÑ View Files</button>
                <button class="tab-button" data-tab="code_diff">Code Diff</button>
                <button class="tab-button" data-tab="file-analyzer">üîç File Analyzer</button>

            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Overview Tab -->
                <div id="overview" class="tab-pane active">
                    <!-- Extension Description -->
                    <div class="info-card-wrapper" id="descriptionWrapper" style="margin-bottom: 2rem; display: none;">
                        <div class="card-shadow"></div>
                        <div class="info-card">
                            <h3>üìù Description</h3>
                            <div id="extensionDescription" style="line-height: 1.6; color: #495057;">
                                <!-- Description will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="overview-grid">
                        <!-- Store Information -->
                        <div class="info-card-wrapper">
                            <div class="card-shadow"></div>
                            <div class="info-card">
                                <h3>üìä Store Information</h3>
                                <div id="storeInfo">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        Loading store information...
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- here2 -->
  <div style="margin-top: 0.5rem;">
        <span>Developer Address:</span>
        <div id="developer_address" style="margin-top: 0.25rem;">-</div>
    </div>
                        <!-- Manifest Information -->
                        <div class="info-card-wrapper">
                            <div class="card-shadow"></div>
                            <div class="info-card">
                                <h3>üìã Manifest Information</h3>
                                <div id="manifestInfo">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        Loading manifest data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
           
                    <!-- Permissions -->
                    <div class="info-card-wrapper">
                        <div class="card-shadow"></div>
                        <div class="info-card">
                            <h3>üîê Permissions Analysis</h3>
                            <div id="permissionsInfo">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Loading permissions...
                                </div>
                            </div>
                        </div>
                    </div>
       
                </div>

                <!-- Vulnerabilities Tab -->
                <div id="vulnerabilities" class="tab-pane">
                    <!-- Single Line Block Header -->
                    <div style="padding: 1.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; margin: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span id="vulnCount" style="font-size: 1.75rem; font-weight: bold; color: #dc2626;">-</span>
                                <span style="font-size: 1.25rem; font-weight: 600; color: #111827;">Security Vulnerabilities Detected</span>
                                <span style="font-size: 0.95rem; color: #6b7280;">Critical security issues found in extension libraries - RetireJS: 0, Semgrep: 0, Bearer: 0, ESLint: 0</span>
                            </div>
                            <div id="uniqueFilesCount" style="font-size: 0.9rem; color: #059669; font-weight: 500;"></div>
                        </div>
                    </div>
                    
                    <!-- Full Width Table -->
                    <div style="width: 100%; background: #fff;">
                        <div id="vulnList" style="width: 100%;">
                            <div class="loading" style="text-align: center; padding: 3rem;">
                                <div class="spinner"></div>
                                Loading vulnerabilities...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Analysis Tab -->
                <div id="code-analysis" class="tab-pane">
                    <div class="metrics-grid" id="codeMetrics">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading code metrics...
                        </div>
                    </div>
                    
                    <div class="info-card-wrapper" id="filesCardWrapper">
                        <div class="card-shadow"></div>
                        <div class="info-card">
                            <h3>üìÅ Analyzed Files</h3>
                            <div class="files-list-wrapper" id="filesListWrapper">
                                <div id="filesList" class="files-list">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        Loading file analysis...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Placeholder for dynamically inserted content -->
                    <div id="gitleaksPlaceholder"></div>
                    <div id="iocPlaceholder"></div>
                    
                    <!-- Obfuscation Detection Section -->
                    <div class="info-card-wrapper" id="obfuscationCardWrapper" style="display: none; margin-top: 2rem;">
                        <div class="card-shadow"></div>
                        <div class="info-card">
                            <h3>‚ö†Ô∏è Obfuscated Code Detected</h3>
                            <div id="obfuscationContent">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dynamic-analysis" class="tab-pane">
    <div id="dynamicMetrics" style="display: none;"></div>
    <div style="background: #f1f5f9; border-bottom: 1px solid #e2e8f0; padding: 0; margin: 0;">
        <div style="display: flex; gap: 0;">
            <div id="sim-tab-no" class="sim-tab-btn" onclick="switchSimulationTab('no')" 
                 style="padding: 12px 24px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; flex: 1; text-align: center;">
                No Simulation
            </div>
            <div id="sim-tab-static" class="sim-tab-btn" onclick="switchSimulationTab('static')" 
                 style="padding: 12px 24px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; flex: 1; text-align: center;">
                Static Simulation
            </div>
            <div id="sim-tab-adaptive" class="sim-tab-btn" onclick="switchSimulationTab('adaptive')" 
                 style="padding: 12px 24px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; flex: 1; text-align: center;">
                Adaptive Simulation
            </div>
        </div>
    </div>
    <div id="simulationContent" style="padding: 0; background: white; margin: 0;">
        <div class="loading" style="text-align: center; padding: 3rem;">
            <div class="spinner"></div>
            Loading dynamic analysis...
        </div>
    </div>
</div>
                 <div id="code_diff" class="tab-pane">
                    <div style="padding: 1.5rem; background: #F8FAFC; border: 2px solid #E2E8F0; border-radius: 8px; margin: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.75rem; font-weight: bold; color: #342E7C;"></span>
                                <span style="font-size: 1.25rem; font-weight: 600; color: #111827;">Code Diff Analysis</span>
                                <span style="font-size: 0.95rem; color: #6B7280;">Track code changes and version differences</span>
                            </div>
                        </div>
                    </div>
                    <!-- Code Diff Table -->
                    <div style="width: 100%; background: #fff;">
                        <div id="codeDiffList" style="width: 100%;">
                            <div class="loading" style="text-align: center; padding: 3rem;">
                                <div class="spinner"></div>
                                Loading code diff data...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Analyzer Tab -->
<div id="file-analyzer" class="tab-pane">
    <div style="padding: 1.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; margin: 1rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="fileAnalyzerCount" style="font-size: 1.75rem; font-weight: bold; color: #342e7c;">-</span>
                <span style="font-size: 1.25rem; font-weight: 600; color: #111827;">Files Analyzed</span>
                <span id="fileAnalyzerSummary" style="font-size: 0.95rem; color: #6b7280;">Loading security analysis...</span>
            </div>
            <div id="maliciousFilesCount" style="font-size: 0.9rem; color: #dc2626; font-weight: 500;"></div>
        </div>
    </div>
    
    <!-- File Analyzer Table -->
    <div style="width: 100%; background: #fff;">
        <div id="fileAnalyzerList" style="width: 100%;">
            <div class="loading" style="text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                Loading file security analysis...
            </div>
        </div>
    </div>
</div>


                <!-- File Viewer Tab -->
                <div id="file-viewer" class="tab-pane">
                      
                    <div style="display: flex; height: 600px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow: hidden;">
                        <!-- File List Panel (Left) -->
                        <div style="width: 350px; border-right: 1px solid #e5e7eb; background: #f9fafb;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: white;">
                                <h3 id="fileViewerTitle" style="margin: 0; color: #342e7c; font-size: 1.2rem; font-weight: 600;">Extension Files</h3>
                                <p style="margin: 0.5rem 0 1rem 0; color: #6b7280; font-size: 0.9rem;">Click any file to view its source code</p>
                                <div style="position: relative;">
                                    <input type="text" id="fileSearchInput" placeholder="Search for files..." 
                                           style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; color: #374151; background: white; transition: border-color 0.2s ease; box-sizing: border-box;"
                                           onkeyup="filterFiles(this.value)"
                                           onfocus="this.style.borderColor='#342e7c'; this.style.boxShadow='0 0 0 1px #342e7c';"
                                           onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'; hideClearButtonIfEmpty();">
                                    <button id="clearSearchBtn" onclick="clearSearch()" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; font-size: 1rem; cursor: pointer; display: none; padding: 0.25rem; border-radius: 50%; transition: all 0.2s ease; width: 20px; height: 20px; align-items: center; justify-content: center;"
                                           onmouseenter="this.style.backgroundColor='#f3f4f6'; this.style.color='#6b7280';"
                                           onmouseleave="this.style.backgroundColor='transparent'; this.style.color='#9ca3af';">
                                        √ó
                                    </button>
                                </div>
                            </div>
                            <div id="viewerFilesList" style="padding: 1rem; max-height: 500px; overflow-y: auto;">
                                <div class="loading" style="text-align: center; padding: 2rem;">
                                    <div class="spinner"></div>
                                    Loading files...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Code Viewer Panel (Right) -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div id="codeHeader" style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 id="codeFileName" style="margin: 0; color: #1f2937; font-size: 1.1rem; font-weight: 600;"></h4>
                                        <p id="codeFileSize" style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.9rem;"></p>
                                    </div>
                                    <button id="copyCodeBtn" onclick="copyCodeToClipboard()" style="padding: 0.5rem 1rem; background: #342e7c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                        üìã Copy Code
                                    </button>
                                </div>
                            </div>
                            <div id="codeViewer" style="flex: 1; overflow: hidden; background: white;">
                                <div id="codeWelcome" style="display: flex; align-items: center; justify-content: center; height: 100%; background: white;">
                                    <div style="text-align: center; padding: 3rem; max-width: 500px;">
                                        <div style="background: linear-gradient(135deg, #342e7c 0%, #4c46a8 100%); color: white; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem; font-size: 2rem; box-shadow: 0 8px 25px rgba(52, 46, 124, 0.3);">
                                            üìÑ
                                        </div>
                                        <h3 style="color: #342e7c; font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; line-height: 1.4;">
                                            Source Code Viewer
                                        </h3>
                                        <p style="color: #6b7280; font-size: 1rem; line-height: 1.6; margin-bottom: 2rem;">
                                            Select any file from the left panel to view its source code with beautiful syntax highlighting and line numbers
                                        </p>
                                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #342e7c; font-size: 0.9rem; font-weight: 500;">
                                                <span style="width: 12px; height: 12px; background: #22AA22; border-radius: 50%; display: inline-block;"></span>
                                                Comments
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #342e7c; font-size: 0.9rem; font-weight: 500;">
                                                <span style="width: 12px; height: 12px; background: #0000DD; border-radius: 50%; display: inline-block;"></span>
                                                Keywords
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #342e7c; font-size: 0.9rem; font-weight: 500;">
                                                <span style="width: 12px; height: 12px; background: #DD6600; border-radius: 50%; display: inline-block;"></span>
                                                Strings
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #342e7c; font-size: 0.9rem; font-weight: 500;">
                                                <span style="width: 12px; height: 12px; background: #AA00AA; border-radius: 50%; display: inline-block;"></span>
                                                Functions
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="codeEditor" style="display: none; height: 100%; width: 100%; position: relative; max-height: 470px; overflow: hidden;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Get extension ID from URL
        const extensionId = window.location.pathname.split('/').pop();
function escapeForJS(text) {
    if (!text) return '';
    
    try {
        return text
            .replace(/\\/g, '\\\\')    // Escape backslashes first
            .replace(/'/g, "\\'")      // Escape single quotes
            .replace(/"/g, '\\"')      // Escape double quotes
            .replace(/`/g, '\\`')      // Escape backticks
            .replace(/\n/g, '\\n')     // Escape newlines
            .replace(/\r/g, '\\r')     // Escape carriage returns
            .replace(/\t/g, '\\t')     // Escape tabs
            .replace(/\f/g, '\\f')     // Escape form feeds
            .replace(/\v/g, '\\v')     // Escape vertical tabs
            .replace(/\0/g, '\\0')     // Escape null characters
            .replace(/\u2028/g, '\\u2028')  // Escape line separator
            .replace(/\u2029/g, '\\u2029')  // Escape paragraph separator
            .replace(/\u0000-\u001F/g, ''); // Remove control characters
    } catch (error) {
        console.error('Error escaping text for JS:', error);
        return 'Error: Could not process text';
    }
}
        
        // Tab switching functionality with height reset for Monaco Editor
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                const targetPane = document.getElementById(tabId);
                targetPane.classList.add('active');
                
                // Reset heights when switching to file viewer
                if (tabId === 'file-viewer') {
                    console.log('üîß Resetting file viewer heights...');
                    
                    // Reset file viewer container height to fixed 600px
                    const fileViewerContainer = targetPane.querySelector('div[style*="height: 600px"]');
                    if (fileViewerContainer) {
                        fileViewerContainer.style.height = '600px';
                        fileViewerContainer.style.maxHeight = '600px';
                        console.log('üîß File viewer container reset to 600px');
                    }
                    
                    // Reset Monaco editor container
                    const codeEditor = document.getElementById('codeEditor');
                    if (codeEditor) {
                        codeEditor.style.height = '100%';
                        codeEditor.style.maxHeight = '470px';
                        console.log('üîß Monaco editor container reset to 470px max');
                    }
                    
                    // Force Monaco editor layout recalculation with proper dimensions
                    setTimeout(() => {
                        if (window.currentMonacoEditor) {
                            console.log('üîß Forcing Monaco layout recalculation after height reset...');
                            window.currentMonacoEditor.layout();
                        }
                    }, 100);
                }
                
                // Obfuscation data is now handled in updateCodeAnalysisTab function
            });
        });

        // Load extension data
        async function loadExtensionData() {
            try {
                // Load basic extension info
                const response = await fetch(`/api/extension/${extensionId}?t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    // Store extension data globally for file details
                    window.extensionAnalysisData = data;
                    
                    updateExtensionHeader(data.extension);
                    generateExtensionBadges(data.extension, data.obfuscation);
                    updateOverviewTab(data.extension, data.permissions, data.obfuscation);
                    updateVulnerabilitiesTab(data.vulnerabilities_grouped || data.vulnerabilities, data.total_unique_files, data.semgrep_vulnerabilities_grouped || [], data.total_semgrep_unique_files, data.bearer_vulnerabilities_grouped || [], data.total_bearer_unique_files, data.eslint_security_grouped || [], data.total_eslint_unique_files);
                    updateCodeAnalysisTab(data.analysis, data.obfuscation, data.gitleaks, data.ioc_analysis);
                    // updateDynamicAnalysisTab(data.dynamic_analysis);
                    // updateFileViewerTab(data.analysis);
                    await loadCodeDiffData();
                    // Add this line inside the loadExtensionData function after updateCodeAnalysisTab
await loadFileAnalyzerData();
                } else {
                    showError('Failed to load extension data');
                }
            } catch (error) {
                showError('Error loading extension data');
            }
        }

          async function loadCodeDiffData() {
    try {
        const response = await fetch(`/api/extension/${extensionId}/diff-analysis`);
        const data = await response.json();
        
        if (data.success) {
            updateCodeDiffTab(data);
        } else {
            updateCodeDiffTab({ analyses: [], summary: {} });
        }
    } catch (error) {
        console.error('Error loading code diff data:', error);
        updateCodeDiffTab({ analyses: [], summary: {} });
    }
}
async function loadFileAnalyzerData() {
    try {
        const response = await fetch(`/api/extension/${extensionId}/security-analysis`);
        const data = await response.json();
        
        if (data.success) {
            updateFileAnalyzerTab(data);
        } else {
            updateFileAnalyzerTab({ files: [], total_files: 0, malicious_files: 0 });
        }
    } catch (error) {
        console.error('Error loading file analyzer data:', error);
        updateFileAnalyzerTab({ files: [], total_files: 0, malicious_files: 0 });
    }
}

        function updateExtensionHeader(extension) {
            document.getElementById('extensionName').textContent = extension.name;
            document.getElementById('extensionVersion').textContent = extension.version;
            document.getElementById('extensionRating').textContent = extension.rating.toFixed(1);
            document.getElementById('ratingCount').textContent = extension.rating_count.toLocaleString();
            document.getElementById('userCount').textContent = extension.users_count.toLocaleString();
            document.getElementById('extensionSize').textContent = extension.size_display;
            // document.getElementById('developer_address').textContent = extension.developer_address;
            // Replace the address text with Google Maps iframe
// Replace the address text with Interactive Google Maps
    const developerAddressElement = document.getElementById('developer_address');
    const address = extension.developer_address;

    if (address && address.trim() !== '' && address !== '-') {
        // Store address globally
        window.currentDeveloperAddress = address;
        
        // Create map interface immediately
        createDeveloperMapInterface(address);
        
        // Load Google Maps API with hardcoded key
        loadDeveloperMapsAPI();
    } else {
        developerAddressElement.textContent = 'Address not available';
    }


            
            // Update file viewer title with extension name
            const fileViewerTitle = document.getElementById('fileViewerTitle');
            if (fileViewerTitle) {
                fileViewerTitle.textContent = `${extension.name} - Files`;
            }
            
            // Set extension icon with error handling
            const iconElement = document.getElementById('extensionIcon');
            if (extension.logo_url) {
                iconElement.src = extension.logo_url;
                iconElement.onerror = function() {
                    // Fallback to a default icon
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%23f0f0f0"/><text x="32" y="40" text-anchor="middle" font-family="Arial" font-size="24" fill="%23666">?</text></svg>';
                };
                iconElement.onload = function() {
                };
            } else {
                iconElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%23f0f0f0"/><text x="32" y="40" text-anchor="middle" font-family="Arial" font-size="24" fill="%23666">?</text></svg>';
            }
        }


        const GOOGLE_MAPS_API_KEY = 'AIzaSyBxjvqFmf1B2HfIwwbAck3eHj84UXQDo_4';

// Google Maps variables
let developerMap;
let developerStreetViewService;
let developerStreetViewPanorama;
let developerGeocoder;
let developerCurrentView = 'map';
let developerMapsLoaded = false;

function createDeveloperMapInterface(address) {
    const developerAddressElement = document.getElementById('developer_address');
    
    // Create the complete map interface
    const mapContainer = document.createElement('div');
    mapContainer.style.cssText = `
        width: 100%;
        max-width: 450px;
        margin-top: 0.5rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    `;

    // Address display
    const addressDisplay = document.createElement('div');
    addressDisplay.style.cssText = `
        font-size: 12px;
        color: #666;
        margin-bottom: 10px;
        font-weight: 500;
    `;
    addressDisplay.textContent = `üìç ${address}`;

    // View toggle buttons
    const viewToggle = document.createElement('div');
    viewToggle.style.cssText = `
        margin-bottom: 12px;
        display: flex;
        gap: 6px;
    `;

    const mapViewBtn = document.createElement('button');
    mapViewBtn.id = 'mapViewBtn';
    mapViewBtn.textContent = ' Map';
    mapViewBtn.onclick = () => switchDeveloperMapView('map');
    mapViewBtn.style.cssText = `
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #1a73e8;
        color: white;
        font-weight: 500;
    `;

    const satelliteViewBtn = document.createElement('button');
    satelliteViewBtn.id = 'satelliteViewBtn';
    satelliteViewBtn.textContent = ' Satellite';
    satelliteViewBtn.onclick = () => switchDeveloperMapView('satellite');
    satelliteViewBtn.style.cssText = `
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #f1f1f1;
        color: #333;
        font-weight: 500;
    `;

    const streetViewBtn = document.createElement('button');
    streetViewBtn.id = 'streetViewBtn';
    streetViewBtn.textContent = ' Street View';
    streetViewBtn.onclick = () => switchDeveloperMapView('street');
    streetViewBtn.style.cssText = `
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: #f1f1f1;
        color: #333;
        font-weight: 500;
    `;

    // Map container
    const mapDiv = document.createElement('div');
    mapDiv.style.cssText = `
        width: 100%;
        height: 250px;
        border: 2px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    `;

    const mapElement = document.createElement('div');
    mapElement.id = 'developerMap';
    mapElement.style.cssText = 'width: 100%; height: 100%;';

    const streetViewElement = document.createElement('div');
    streetViewElement.id = 'developerStreetView';
    streetViewElement.style.cssText = 'width: 100%; height: 100%; display: none;';

    // Assemble components
    viewToggle.appendChild(mapViewBtn);
    viewToggle.appendChild(satelliteViewBtn);
    viewToggle.appendChild(streetViewBtn);
    
    mapDiv.appendChild(mapElement);
    mapDiv.appendChild(streetViewElement);
    
    mapContainer.appendChild(addressDisplay);
    mapContainer.appendChild(viewToggle);
    mapContainer.appendChild(mapDiv);

    // Clear existing content and add new interface
    developerAddressElement.innerHTML = '';
    developerAddressElement.appendChild(mapContainer);
}

function loadDeveloperMapsAPI() {
    // Load Google Maps API with hardcoded key
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initDeveloperMap&libraries=geometry`;
    script.async = true;
    script.defer = true;
    
    script.onerror = function() {
        console.error('Failed to load Google Maps API');
        // Show fallback
        document.getElementById('developerMap').innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6b7280; text-align: center; font-size: 14px;">
                <div>
                    <div style="margin-bottom: 10px;">üìç</div>
                    <div>Map failed to load</div>
                    <div style="font-size: 12px; margin-top: 5px;">${window.currentDeveloperAddress}</div>
                </div>
            </div>
        `;
    };
    
    document.head.appendChild(script);
}

function initDeveloperMap() {
    // Initialize map
    developerMap = new google.maps.Map(document.getElementById('developerMap'), {
        center: { lat: 40.7580, lng: -73.9855 }, // Default to Times Square
        zoom: 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    
    // Initialize services
    developerGeocoder = new google.maps.Geocoder();
    developerStreetViewService = new google.maps.StreetViewService();
    
    // Initialize Street View
    developerStreetViewPanorama = new google.maps.StreetViewPanorama(
        document.getElementById('developerStreetView'),
        {
            position: { lat: 40.7580, lng: -73.9855 },
            pov: { heading: 0, pitch: 0 },
            zoom: 1
        }
    );
    
    // Set Street View for the map
    developerMap.setStreetView(developerStreetViewPanorama);
    
    developerMapsLoaded = true;
    
    // Load the developer address immediately
    updateDeveloperLocation();
}

function updateDeveloperLocation() {
    if (!developerMapsLoaded) {
        return;
    }
    
    const address = window.currentDeveloperAddress;
    
    if (!address) {
        console.error('No developer address available');
        return;
    }
    
    // Geocode the address
    developerGeocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK') {
            const location = results[0].geometry.location;
            
            // Update map center
            developerMap.setCenter(location);
            
            // Add marker
            new google.maps.Marker({
                position: location,
                map: developerMap,
                title: address,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="18" fill="#4285f4" stroke="white" stroke-width="2"/>
                            <circle cx="20" cy="20" r="8" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40),
                    anchor: new google.maps.Point(20, 20)
                }
            });
            
            // Check if Street View is available
            developerStreetViewService.getPanorama(
                { location: location, radius: 50 },
                (data, status) => {
                    if (status === 'OK') {
                        // Street View is available
                        developerStreetViewPanorama.setPano(data.location.pano);
                        developerStreetViewPanorama.setPov({
                            heading: 0,
                            pitch: 0
                        });
                        developerStreetViewPanorama.setZoom(1);
                    } else {
                        console.log('Street View not available for this location');
                        // Disable street view button if not available
                        const streetBtn = document.getElementById('streetViewBtn');
                        if (streetBtn) {
                            streetBtn.style.opacity = '0.5';
                            streetBtn.style.cursor = 'not-allowed';
                            streetBtn.title = 'Street View not available for this location';
                        }
                    }
                }
            );
        } else {
            console.error('Geocoding failed: ' + status);
            // Show fallback in map
            document.getElementById('developerMap').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6b7280; text-align: center; font-size: 14px;">
                    <div>
                        <div style="margin-bottom: 10px;">üìç</div>
                        <div>Could not locate address</div>
                        <div style="font-size: 12px; margin-top: 5px;">${address}</div>
                    </div>
                </div>
            `;
        }
    });
}

function switchDeveloperMapView(view) {
    if (!developerMapsLoaded) {
        return;
    }
    
    developerCurrentView = view;
    
    // Update button styles
    const buttons = ['mapViewBtn', 'satelliteViewBtn', 'streetViewBtn'];
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.style.backgroundColor = '#f1f1f1';
            btn.style.color = '#333';
        }
    });
    
    // Toggle visibility and update active button
    if (view === 'map') {
        document.getElementById('developerMap').style.display = 'block';
        document.getElementById('developerStreetView').style.display = 'none';
        document.getElementById('mapViewBtn').style.backgroundColor = '#1a73e8';
        document.getElementById('mapViewBtn').style.color = 'white';
        developerMap.setMapTypeId(google.maps.MapTypeId.ROADMAP);
    } else if (view === 'satellite') {
        document.getElementById('developerMap').style.display = 'block';
        document.getElementById('developerStreetView').style.display = 'none';
        document.getElementById('satelliteViewBtn').style.backgroundColor = '#1a73e8';
        document.getElementById('satelliteViewBtn').style.color = 'white';
        developerMap.setMapTypeId(google.maps.MapTypeId.SATELLITE);
    } else if (view === 'street') {
        const streetBtn = document.getElementById('streetViewBtn');
        if (streetBtn.style.opacity === '0.5') {
            // Street view not available
            return;
        }
        
        document.getElementById('developerMap').style.display = 'none';
        document.getElementById('developerStreetView').style.display = 'block';
        document.getElementById('streetViewBtn').style.backgroundColor = '#1a73e8';
        document.getElementById('streetViewBtn').style.color = 'white';
    }
}


        function generateExtensionBadges(extension, obfuscation) {
            try {
                const badges = [];
                let manifest = {};
                
                // Safely parse manifest data
                try {
                    manifest = typeof extension.manifest_data === 'string' 
                        ? JSON.parse(extension.manifest_data) 
                        : extension.manifest_data || {};
                } catch (e) {
                    manifest = {};
                }

                // Browser Badge - Determine from database/manifest data
                // Since this data comes from Chrome Web Store, it's for Chromium-based browsers
                // But we check the data to make it data-driven rather than hardcoded
                if (extension.category || manifest.manifest_version) {
                    badges.push({
                        class: 'badge-chromium',
                        text: 'Chromium',
                        emoji: 'üîó'
                    });
                }

                // Manifest V3 Badge - Check for both manifest_version 3 and version "3"
                if (manifest.manifest_version === 3 || manifest.manifest_version === "3") {
                    badges.push({
                        class: 'badge-manifest-v3',
                        text: 'Manifest V3',
                        emoji: 'üìã'
                    });
                }

                // Obfuscated Code Badge
                if (obfuscation && obfuscation.total_obfuscated_files > 0) {
                    badges.push({
                        class: 'badge-obfuscated',
                        text: `Obfuscated Code Detected (${obfuscation.total_obfuscated_files} files)`,
                        emoji: '‚ö†Ô∏è'
                    });
                }

                // Has Popup UI Badge - Check both action.default_popup and browser_action.default_popup
                const hasPopup = (manifest.action && manifest.action.default_popup) || 
                                 (manifest.browser_action && manifest.browser_action.default_popup);
                                 
                if (hasPopup) {
                    badges.push({
                        class: 'badge-popup',
                        text: 'Has Popup UI',
                        emoji: 'üî≤'
                    });
                }

                // Generate HTML for badges
                const badgesHtml = badges.map(badge => `
                    <div class="extension-badge ${badge.class}">
                        ${badge.emoji ? `<span class="badge-emoji">${badge.emoji}</span>` : ''}
                        <span>${badge.text}</span>
                    </div>
                `).join('');

                document.getElementById('extensionBadges').innerHTML = badgesHtml;
            } catch (error) {
                // Show at least the Chromium badge as fallback
                document.getElementById('extensionBadges').innerHTML = `
                    <div class="extension-badge badge-chromium">
                        <span class="badge-emoji">üîó</span>
                        <span>Chromium</span>
                    </div>
                `;
            }
        }

        // Helper functions for enhanced risk assessment UI
        function generateHostPermissionsHtml(hostPermissions) {
            if (!hostPermissions || hostPermissions.length === 0) {
                return `
                    <div class="host-permission-item safe">
                        <span class="permission-value">None</span>
                        <span class="permission-warning">‚úÖ NO WEBSITE ACCESS</span>
                    </div>
                    <div class="permission-explanation">Extension cannot access any websites</div>
                `;
            }

            const hostPermsHtml = hostPermissions.map(permission => {
                let riskLevel = 'medium';
                let warningText = '‚ö° SPECIFIC ACCESS';
                let explanation = `Extension can access ${permission}`;

                // Determine risk level based on permission pattern
                if (permission === '<all_urls>' || permission === '*://*/*') {
                    riskLevel = 'critical';
                    warningText = '‚ö†Ô∏è ALL WEBSITES';
                    explanation = 'Extension can access ANY website you visit including banking, social media, and private sites';
                } else if (permission === 'http://*/*' || permission === 'https://*/*') {
                    riskLevel = 'critical';
                    warningText = '‚ö†Ô∏è ALL HTTP/HTTPS SITES';
                    explanation = `Extension can access all ${permission.includes('https') ? 'HTTPS' : 'HTTP'} websites`;
                } else if (permission.includes('file://')) {
                    riskLevel = 'critical';
                    warningText = '‚ö†Ô∏è FILE SYSTEM ACCESS';
                    explanation = 'Extension can access local files on your computer';
                } else if (permission.includes('localhost') || permission.includes('127.0.0.1')) {
                    riskLevel = 'medium';
                    warningText = '‚ö° LOCAL SERVER ACCESS';
                    explanation = 'Extension can access local development servers';
                }

                return `
                    <div class="host-permission-item ${riskLevel}">
                        <span class="permission-value">${permission}</span>
                        <span class="permission-warning">${warningText}</span>
                    </div>
                    <div class="permission-explanation">${explanation}</div>
                `;
            }).join('');

            return hostPermsHtml;
        }

        function generateRiskFactorsHtml(riskFactors) {
            if (!riskFactors || riskFactors.length === 0) {
                return '<div class="risk-text" style="color: #6b7280; font-style: italic;">No specific risk factors detected</div>';
            }

            const getIconForRiskFactor = (factor) => {
                const lowerFactor = factor.toLowerCase();
                if (lowerFactor.includes('host permission') || lowerFactor.includes('<all_urls>')) return 'üåç';
                if (lowerFactor.includes('content script') && lowerFactor.includes('http://')) return 'üìÑ';
                if (lowerFactor.includes('content script') && lowerFactor.includes('https://')) return 'üîê';
                if (lowerFactor.includes('content script') && lowerFactor.includes('broad')) return 'üìÑ';
                if (lowerFactor.includes('update url')) return 'üîÑ';
                if (lowerFactor.includes('permission: privacy')) return 'üîí';
                if (lowerFactor.includes('permission: webrequest')) return 'üåê';
                if (lowerFactor.includes('permission: browsing')) return 'üóëÔ∏è';
                if (lowerFactor.includes('permission: tabs')) return 'üóÇÔ∏è';
                if (lowerFactor.includes('permission: storage')) return 'üíæ';
                if (lowerFactor.includes('permission: cookies')) return 'üç™';
                if (lowerFactor.includes('permission: management')) return '‚öôÔ∏è';
                if (lowerFactor.includes('permission: history')) return 'üìú';
                if (lowerFactor.includes('permission: downloads')) return '‚¨áÔ∏è';
                if (lowerFactor.includes('permission: desktop')) return 'üì∏';
                if (lowerFactor.includes('permission: system')) return 'üñ•Ô∏è';
                if (lowerFactor.includes('all frames')) return 'üñºÔ∏è';
                if (lowerFactor.includes('document_start')) return '‚ö°';
                if (lowerFactor.includes('externally connectable')) return 'üîó';
                if (lowerFactor.includes('wildcard')) return 'üéØ';
                return '‚ö†Ô∏è'; // Default warning icon
            };

            const riskFactorsHtml = riskFactors.map(factor => `
                <div class="risk-factor-item">
                    <span class="risk-icon">${getIconForRiskFactor(factor)}</span>
                    <span class="risk-text">${factor}</span>
                </div>
            `).join('');

            return riskFactorsHtml;
        }

        // Compact functions for space-efficient display
        function generateCompactHostPermissions(hostPermissions) {
            if (!hostPermissions || hostPermissions.length === 0) {
                return `<div style="margin-bottom: 0.5rem;"><strong>Host Permissions:</strong> <span style="color: #16a34a;">None</span></div>`;
            }

            const maxShow = 2;
            const hasMore = hostPermissions.length > maxShow;
            const visiblePerms = hostPermissions.slice(0, maxShow);
            
            const validPerms = visiblePerms.filter(perm => perm && perm.trim() !== '');
            
            // If no valid permissions after filtering, show as "None"
            if (validPerms.length === 0) {
                return `<div style="margin-bottom: 0.5rem;"><strong>Host Permissions:</strong> <span style="color: #16a34a;">None</span></div>`;
            }
            
            const permsHtml = validPerms.map(perm => {
                let color = '#d97706';
                
                if (perm === '<all_urls>' || perm === '*://*/*') {
                    color = '#dc2626';
                } else if (perm.includes('file://')) {
                    color = '#dc2626';
                }
                
                // HTML escape the permission to prevent rendering issues
                const escapedPerm = perm.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<span style="color: ${color}; font-weight: 600;">${escapedPerm}</span>`;
            }).join(', ');
            
            const moreText = hasMore ? ` <span style="color: #6b7280; cursor: pointer;" onclick="toggleHostPermissions(this)">+${hostPermissions.length - maxShow} more</span>` : '';
            
            return `<div style="margin-bottom: 0.5rem;"><strong>Host Permissions:</strong> ${permsHtml}${moreText}</div>`;
        }

        function generateCompactRiskFactors(riskFactors) {
            if (!riskFactors || riskFactors.length === 0) {
                return '';
            }

            const maxShow = 3;
            const hasMore = riskFactors.length > maxShow;
            const visibleFactors = riskFactors.slice(0, maxShow);
            
            const factorsHtml = visibleFactors.map(factor => {
                // Inline icon detection for compact view
                const lowerFactor = factor.toLowerCase();
                let icon = '‚ö†Ô∏è';
                if (lowerFactor.includes('host permission') || lowerFactor.includes('<all_urls>')) icon = 'üåç';
                else if (lowerFactor.includes('content script') && lowerFactor.includes('http://')) icon = 'üìÑ';
                else if (lowerFactor.includes('content script') && lowerFactor.includes('https://')) icon = 'üîê';
                else if (lowerFactor.includes('update url')) icon = 'üîÑ';
                else if (lowerFactor.includes('permission: privacy')) icon = 'üîí';
                else if (lowerFactor.includes('permission: webrequest')) icon = 'üåê';
                else if (lowerFactor.includes('permission: storage')) icon = 'üíæ';
                
                const shortText = factor.length > 50 ? factor.substring(0, 47) + '...' : factor;
                return `<span style="margin-right: 0.5rem;">${icon} ${shortText}</span>`;
            }).join(' ');
            
            const moreText = hasMore ? ` <span style="color: #6b7280; cursor: pointer;" onclick="toggleRiskFactors(this)">+${riskFactors.length - maxShow} more</span>` : '';
            
            return `<div style="margin-bottom: 0.5rem;"><strong>Risk Factors:</strong> ${factorsHtml}${moreText}</div>`;
        }

        // Global storage for toggle data
        window.fullHostPermissions = [];
        window.fullRiskFactors = [];

        // Toggle functions for expandable content
        function toggleHostPermissions(element) {
            const parent = element.parentElement;
            const hostPermissions = window.fullHostPermissions;
            
            if (hostPermissions.length === 0) return;
            
            // Generate full list in compact box format, filtering out empty values
            const allPermsHtml = hostPermissions.filter(perm => perm && perm.trim() !== '').map(perm => {
                let riskClass = 'medium';
                let color = '#d97706';
                
                if (perm === '<all_urls>' || perm === '*://*/*') {
                    riskClass = 'high';
                    color = '#dc2626';
                } else if (perm.includes('file://')) {
                    riskClass = 'high';
                    color = '#dc2626';
                } else if (perm.includes('localhost')) {
                    riskClass = 'medium';
                    color = '#d97706';
                } else if (perm.includes('https://')) {
                    riskClass = 'low';
                    color = '#059669';
                } else if (perm.includes('http://')) {
                    riskClass = 'medium';
                    color = '#d97706';
                }
                
                // Check if permission is empty
                if (!perm || perm.trim() === '') {
                    return ''; // Skip empty permissions in expanded view
                }
                
                // Shorten long URLs
                let displayPerm = perm;
                if (perm.length > 30 && !['<all_urls>', '*://*/*'].includes(perm)) {
                    displayPerm = perm.substring(0, 27) + '...';
                }
                
                // HTML escape the permission to prevent rendering issues
                const escapedDisplayPerm = displayPerm.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                return `
                    <div class="permission-item-wrapper" style="display: inline-block;">
                        <div class="permission-shadow"></div>
                        <div class="permission-item ${riskClass}" style="padding: 0.5rem 0.75rem; margin: 0.25rem; border: 1px solid ${color}; background: rgba(${color === '#dc2626' ? '220,38,38' : color === '#d97706' ? '217,119,6' : '5,150,105'}, 0.1);">
                            <span style="font-size: 0.85rem; color: ${color}; font-weight: 600;">${escapedDisplayPerm}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Replace the entire parent div to avoid duplication
            const newContent = document.createElement('div');
            newContent.style.marginBottom = '0.5rem';
            newContent.innerHTML = `
                <div>
                    <strong>Host Permissions:</strong> 
                    <span style="color: #6b7280; cursor: pointer; margin-left: 0.5rem;" onclick="collapseHostPermissions(this)">show less</span>
                </div>
                <div class="permissions-grid" style="margin-top: 0.5rem;">
                    ${allPermsHtml}
                </div>
            `;
            parent.replaceWith(newContent);
        }

        function toggleRiskFactors(element) {
            const parent = element.parentElement;
            const riskFactors = window.fullRiskFactors;
            
            if (riskFactors.length === 0) return;
            
            // Generate full list with icons in a grid layout like permissions
            const allFactorsHtml = riskFactors.map(factor => {
                // Inline icon detection
                const lowerFactor = factor.toLowerCase();
                let icon = '‚ö†Ô∏è';
                if (lowerFactor.includes('host permission') || lowerFactor.includes('<all_urls>')) icon = 'üåç';
                else if (lowerFactor.includes('content script') && lowerFactor.includes('http://')) icon = 'üìÑ';
                else if (lowerFactor.includes('content script') && lowerFactor.includes('https://')) icon = 'üîê';
                else if (lowerFactor.includes('update url')) icon = 'üîÑ';
                else if (lowerFactor.includes('permission: privacy')) icon = 'üîí';
                else if (lowerFactor.includes('permission: webrequest')) icon = 'üåê';
                else if (lowerFactor.includes('permission: storage')) icon = 'üíæ';
                else if (lowerFactor.includes('permission: tabs')) icon = 'üóÇÔ∏è';
                else if (lowerFactor.includes('permission: alarms')) icon = '‚è∞';
                else if (lowerFactor.includes('permission: downloads')) icon = '‚¨áÔ∏è';
                else if (lowerFactor.includes('permission: cookies')) icon = 'üç™';
                else if (lowerFactor.includes('permission: management')) icon = '‚öôÔ∏è';
                else if (lowerFactor.includes('permission: history')) icon = 'üìú';
                else if (lowerFactor.includes('permission: contextmenus')) icon = 'üìã';
                else if (lowerFactor.includes('runs in all frames')) icon = 'üñºÔ∏è';
                else if (lowerFactor.includes('runs at document_start')) icon = '‚ö°';
                else if (lowerFactor.includes('wildcard')) icon = 'üéØ';
                
                // Shorten the text for compact display
                let shortText = factor;
                if (factor.includes('Sensitive permission:')) {
                    shortText = factor.replace('Sensitive permission: ', '');
                } else if (factor.includes('Content script')) {
                    const match = factor.match(/Content script (\d+) (.+)/);
                    if (match && match[2] && match[2].trim()) {
                        shortText = `Script ${match[1]}: ${match[2]}`;
                    } else {
                        // If regex doesn't match properly, show the original factor
                        shortText = factor;
                    }
                } else if (factor.includes('Broad host permission:')) {
                    // Keep the risk context - this explains WHY it's dangerous
                    shortText = factor; // Show full context: "Broad host permission: <all_urls>"
                } else if (factor.includes('Wildcard host permission:')) {
                    // Keep the risk context - this explains WHY it's dangerous  
                    shortText = factor; // Show full context: "Wildcard host permission: https://..."
                } else if (factor.includes('Custom update URL:')) {
                    shortText = 'Custom update URL';
                }
                
                // Skip empty or invalid shortText
                if (!shortText || shortText.trim() === '') {
                    return '';
                }
                
                // HTML escape the shortText to prevent rendering issues
                const escapedText = shortText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // Return as a permission-style box
                return `
                    <div class="permission-item-wrapper" style="display: inline-block;">
                        <div class="permission-shadow"></div>
                        <div class="permission-item" style="padding: 0.5rem 0.75rem; margin: 0.25rem;">
                            <div class="permission-icon" style="display: inline; margin-right: 0.25rem;">${icon}</div>
                            <span style="font-size: 0.85rem;">${escapedText}</span>
                        </div>
                    </div>
                `;
            }).filter(html => html && html.trim() !== '').join('');
            
            // Replace the entire parent div to avoid duplication
            const newContent = document.createElement('div');
            newContent.style.marginBottom = '0.5rem';
            newContent.innerHTML = `
                <div>
                    <strong>Risk Factors:</strong> 
                    <span style="color: #6b7280; cursor: pointer; margin-left: 0.5rem;" onclick="collapseRiskFactors(this)">show less</span>
                </div>
                <div class="permissions-grid" style="margin-top: 0.5rem;">
                    ${allFactorsHtml}
                </div>
            `;
            parent.replaceWith(newContent);
        }

        function collapseHostPermissions(element) {
            // Find the container that holds the expanded content
            const container = element.closest('div').parentElement;
            const hostPermissions = window.fullHostPermissions;
            
            // Regenerate compact view and replace the entire container
            const compactHostPermissions = generateCompactHostPermissions(hostPermissions);
            container.outerHTML = compactHostPermissions;
        }

        function collapseRiskFactors(element) {
            // Find the container that holds the expanded content
            const container = element.closest('div').parentElement;
            const riskFactors = window.fullRiskFactors;
            
            // Regenerate compact view and replace the entire container
            const compactRiskFactors = generateCompactRiskFactors(riskFactors);
            container.outerHTML = compactRiskFactors;
        }


        let currentWhoisData = null;

const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'];

function getDomain(url) {
    return url.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
}

function getEmailDomain(email) {
    return email.split('@')[1];
}

function formatDate(dateString) {
    if (!dateString) return 'Not Available';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return dateString;
    }
}

function createWhoisSection() {
    // Only create section if we have whois data
    if (!currentWhoisData) {
        return null;
    }

    const whoisRecord = currentWhoisData.WhoisRecord;
    if (!whoisRecord) return null;

    const registrant = whoisRecord.registrant || {};
    const admin = whoisRecord.administrativeContact || {};
    const tech = whoisRecord.technicalContact || {};
    const registryData = whoisRecord.registryData || {};

    return `
        <!-- WHOIS Information Card -->
        <div class="info-card-wrapper">
            <div class="card-shadow"></div>
            <div class="info-card">
                <h3>üåê Domain WHOIS Information</h3>
                <div class="whois-grid">
                    <div class="whois-section">
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.9rem; font-weight: 600;">Domain Details</h4>
                        <div class="info-item">
                            <span class="info-label">Domain</span>
                            <span class="info-value">${whoisRecord.domainName || 'Not Available'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Registrar</span>
                            <span class="info-value">${whoisRecord.registrarName || 'Not Available'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Created</span>
                            <span class="info-value">${formatDate(registryData.createdDate || whoisRecord.createdDate)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Updated</span>
                            <span class="info-value">${formatDate(registryData.updatedDate || whoisRecord.updatedDate)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Expires</span>
                            <span class="info-value">${formatDate(registryData.expiresDate || whoisRecord.expiresDate)}</span>
                        </div>
                    </div>
                    
                    <div class="whois-section">
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.9rem; font-weight: 600;">Registrant Information</h4>
                        <div class="info-item">
                            <span class="info-label">Name</span>
                            <span class="info-value">${registrant.name === 'REDACTED' ? 'REDACTED' : (registrant.name || 'Not Available')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Organization</span>
                            <span class="info-value">${registrant.organization === 'REDACTED' ? 'REDACTED' : (registrant.organization || 'Not Available')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Country</span>
                            <span class="info-value">${registrant.country === 'REDACTED' ? 'REDACTED' : (registrant.country || 'Not Available')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">${registrant.email === 'REDACTED' ? 'REDACTED' : (registrant.email || 'Not Available')}</span>
                        </div>
                    </div>
                    
                    ${admin.name || admin.organization ? `
                    <div class="whois-section">
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.9rem; font-weight: 600;">Administrative Contact</h4>
                        <div class="info-item">
                            <span class="info-label">Name</span>
                            <span class="info-value">${admin.name === 'REDACTED' ? 'REDACTED' : (admin.name || 'Not Available')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Organization</span>
                            <span class="info-value">${admin.organization === 'REDACTED' ? 'REDACTED' : (admin.organization || 'Not Available')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">${admin.email === 'REDACTED' ? 'REDACTED' : (admin.email || 'Not Available')}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${whoisRecord.nameServers?.hostNames?.length > 0 ? `
                    <div class="whois-section" style="grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.9rem; font-weight: 600;">Name Servers</h4>
                        <div class="nameservers-list">
                            ${whoisRecord.nameServers.hostNames.map(ns => `
                                <div style="background: #f1f5f9; padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; color: #6b7280;">${ns}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

async function doWhoisAnalysis(extension) {
    const emailDomain = getEmailDomain(extension.developer_email);

    // Skip if personal email
    if (personalDomains.includes(emailDomain)) {
        return;
    }

    const websiteDomain = getDomain(extension.website_url);
    console.log('Website domain:', websiteDomain);
    console.log('Email domain:', emailDomain);

    // Only proceed if domains match
    if (emailDomain === websiteDomain) {
        try {
            const response = await fetch(`https://www.whoisxmlapi.com/whoisserver/WhoisService?apiKey=at_p4RLVUkygGJlPa1H7IvYHbc8BVgjf&domainName=${websiteDomain}&outputFormat=JSON`);
            const data = await response.json();

            // Store whois data globally
            currentWhoisData = data;

            console.log("WHOIS Data received:", data);

            // Add whois section to overview tab
            addWhoisToOverview();
        } catch (error) {
            console.error('WHOIS API error:', error);
        }
    }
}

function addWhoisToOverview() {
    // Only update if we're on the overview tab
    const overviewTab = document.getElementById('overview');
    if (!overviewTab || !overviewTab.classList.contains('active')) {
        return;
    }

    // Check if whois section already exists and remove it
    const existingWhoisSection = document.querySelector('.info-card-wrapper h3');
    if (existingWhoisSection) {
        const whoisCards = Array.from(document.querySelectorAll('.info-card-wrapper')).filter(card => {
            const h3 = card.querySelector('h3');
            return h3 && h3.textContent.includes('Domain WHOIS Information');
        });
        whoisCards.forEach(card => card.remove());
    }

    // Create and insert new whois section
    const whoisSection = createWhoisSection();
    if (whoisSection) {
        const overviewGrid = document.querySelector('.overview-grid');
        overviewGrid.insertAdjacentHTML('beforeend', whoisSection);
    }
}


        function updateOverviewTab(extension, permissions, obfuscation) {
            // Show description if available
           if (extension.description || extension.full_description) {
        const descriptionWrapper = document.getElementById('descriptionWrapper');
        const extensionDescription = document.getElementById('extensionDescription');

        // Use full_description if available, otherwise use description
        const descText = extension.full_description || extension.description;
        extensionDescription.innerHTML = escapeHtml(descText).replace(/\n/g, '<br>');
        descriptionWrapper.style.display = 'block';
    }

    // Store Information
    const storeInfo = document.getElementById('storeInfo');
    storeInfo.innerHTML = `
        <div class="info-item"><span class="info-label">Store</span><span class="info-value">Chrome Web Store</span></div>
        <div class="info-item"><span class="info-label">Developer</span><span class="info-value">${escapeHtml(extension.developer_email || 'Not Available')}</span></div>
        <div class="info-item"><span class="info-label">Category</span><span class="info-value">${escapeHtml(extension.category || 'Not Available')}</span></div>
        <div class="info-item"><span class="info-label">Website</span><span class="info-value">${escapeHtml(extension.website_url || 'Not Available')}</span></div>
        <div class="info-item"><span class="info-label">Verified</span><span class="info-value">${extension.website_is_verified ? 'Yes' : 'No'}</span></div>
    `;

    // Run WHOIS analysis
    doWhoisAnalysis(extension);
            // Manifest Information
            const manifestInfo = document.getElementById('manifestInfo');
            let manifest;
            try {
                manifest = typeof extension.manifest_data === 'string' 
                    ? JSON.parse(extension.manifest_data) 
                    : extension.manifest_data;
            } catch (e) {
                manifest = {};
            }
            manifestInfo.innerHTML = `
                <div class="info-item"><span class="info-label">Manifest Version</span><span class="info-value">${manifest.manifest_version || 'Not Available'}</span></div>
                <div class="info-item"><span class="info-label">Update URL</span><span class="info-value" style="word-break: break-all;">${manifest.update_url ? manifest.update_url : 'Not Available'}</span></div>
                <div class="info-item"><span class="info-label">Permissions</span><span class="info-value">${manifest.permissions ? manifest.permissions.length : 0}</span></div>
                <div class="info-item"><span class="info-label">Host Permissions</span><span class="info-value">${manifest.host_permissions ? manifest.host_permissions.length : 0}</span></div>
                <div class="info-item"><span class="info-label">Risk Level</span><span class="info-value" style="color: ${permissions.risk_level === 'critical' ? '#dc2626' : permissions.risk_level === 'high' ? '#ea580c' : permissions.risk_level === 'medium' ? '#d97706' : '#16a34a'}; font-weight: bold; text-transform: uppercase;">${permissions.risk_level || 'Not Available'}</span></div>
            `;

            // Permissions Analysis
            const permissionsInfo = document.getElementById('permissionsInfo');
            const sensitivePerms = permissions.sensitive_permissions; // Show all permissions
            
            const getPermissionRisk = (perm) => {
                const highRisk = ['desktopCapture', 'proxy', 'management', 'privacy', 'webRequest', 'browsingData', '<all_urls>'];
                const mediumRisk = ['tabs', 'storage', 'cookies', 'downloads', 'geolocation'];
                if (highRisk.some(risk => perm.includes(risk))) return 'high';
                if (mediumRisk.some(risk => perm.includes(risk))) return 'medium';
                return 'low';
            };

            const getPermissionEmoji = (perm) => {
                const emojiMap = {
                    'alarms': '‚è∞',
                    'tabs': 'üóÇÔ∏è',
                    'storage': 'üíæ',
                    'unlimitedStorage': 'üóÑÔ∏è',
                    'webRequest': 'üåê',
                    'webNavigation': 'üß≠',
                    'management': '‚öôÔ∏è',
                    'browsingData': 'üóëÔ∏è',
                    'cookies': 'üç™',
                    'geolocation': 'üìç',
                    'notifications': 'üîî',
                    'desktopCapture': 'üì∏',
                    'proxy': 'üîÄ',
                    'system.cpu': 'üñ•Ô∏è',
                    'system.memory': 'üß†',
                    'system.storage': 'üíø',
                    'system.display': 'üñ•Ô∏è',
                    'downloads': '‚¨áÔ∏è',
                    'power': 'üîã',
                    'privacy': 'üîí',
                    'history': 'üìú',
                    'bookmarks': 'üîñ',
                    'identity': 'üÜî',
                    'idle': 'üò¥',
                    'contextMenus': 'üìã',
                    'clipboardRead': 'üìã',
                    'clipboardWrite': '‚úÇÔ∏è',
                    'declarativeNetRequest': 'üõ°Ô∏è',
                    'activeTab': 'üìå',
                    '<all_urls>': 'üåç',
                    'http://*/*': 'üåê',
                    'https://*/*': 'üîê',
                    '*://*/*': 'üåè'
                };
                
                // Check for exact match first
                if (emojiMap[perm]) return emojiMap[perm];
                
                // Check for partial matches
                for (const [key, emoji] of Object.entries(emojiMap)) {
                    if (perm.includes(key)) return emoji;
                }
                
                // Default emoji based on risk level
                const risk = getPermissionRisk(perm);
                if (risk === 'high') return '‚ö†Ô∏è';
                if (risk === 'medium') return '‚ö°';
                return '‚úì';
            };

            const permissionsHtml = sensitivePerms.map(perm => {
                const risk = getPermissionRisk(perm);
                const emoji = getPermissionEmoji(perm);
                return `
                    <div class="permission-item-wrapper">
                        <div class="permission-shadow"></div>
                        <div class="permission-item">
                            <div class="permission-icon ${risk}">${emoji}</div>
                            <span>${perm}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Store data globally for toggle functions
            window.fullHostPermissions = manifest.host_permissions || [];
            window.fullRiskFactors = permissions.risk_factors || [];
            
            // Generate compact host permissions and risk factors
            const compactHostPermissions = generateCompactHostPermissions(manifest.host_permissions);
            const compactRiskFactors = generateCompactRiskFactors(permissions.risk_factors);
            
            permissionsInfo.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Risk Assessment:</strong> ${permissions.risk_level.toUpperCase()} 
                    <span style="color: #6b7280;">(${permissions.risk_factors ? permissions.risk_factors.length : 0} risk factors detected)</span>
                </div>
                
                ${compactHostPermissions}
                ${compactRiskFactors}
                
                <div style="margin-top: 1rem;">
                    <strong>Sensitive Permissions:</strong> 
                    <span style="color: #6b7280;">(${permissions.sensitive_permissions.length} detected)</span>
                </div>
                <div class="permissions-grid">${permissionsHtml}</div>
            `;
            
            // Obfuscation detection moved to Code Analysis tab for better organization
        }

        function getSeverityOrder(severity) {
            const severityOrder = {
                'critical': 1,
                'high': 2,
                'medium': 3,
                'low': 4,
                'unknown': 3  // Default unknown to medium
            };
            return severityOrder[severity.toLowerCase()] || 3;
        }

        function getSeverityBackground(severity) {
            const severityBg = {
                'critical': 'background: #dc2626; color: white;',
                'high': 'background: #ea580c; color: white;', 
                'medium': 'background: #ca8a04; color: white;',
                'low': 'background: #6b7280; color: white;',
                'unknown': 'background: #ca8a04; color: white;'
            };
            return severityBg[severity.toLowerCase()] || severityBg['medium'];
        }

        function updateVulnerabilitiesTab(vulnerabilities, totalUniqueFiles, semgrepVulnerabilities, totalSemgrepUniqueFiles, bearerVulnerabilities, totalBearerUniqueFiles, eslintVulnerabilities, totalEslintUniqueFiles) {
            // Create unified vulnerability list from all tools
            const allVulnerabilities = [];
            
            // Add RetireJS vulnerabilities (using grouped data)
            (vulnerabilities || []).forEach(vuln => {
                const severity = vuln.severity && vuln.severity !== 'unknown' ? vuln.severity : 'medium';
                // Use full description with version instead of just library name
                const vulnerabilityText = vuln.description || vuln.library || 'Unknown Vulnerability';
                const files = vuln.files || [];
                
                allVulnerabilities.push({
                    tool: 'RetireJS',
                    severity: severity,
                    name: vulnerabilityText,
                    fileCount: files.length,
                    files: files,
                    sortOrder: getSeverityOrder(severity)
                });
            });
            
            // Add Semgrep vulnerabilities (using grouped data)
            (semgrepVulnerabilities || []).forEach(vuln => {
                const severity = vuln.severity || 'medium';
                const vulnName = vuln.library || 'Security Issue';
                const files = vuln.files || [];
                
                allVulnerabilities.push({
                    tool: 'Semgrep',
                    severity: severity,
                    name: vulnName,
                    fileCount: files.length,
                    files: files,
                    sortOrder: getSeverityOrder(severity)
                });
            });
            
            // Add Bearer vulnerabilities (using grouped data)
            (bearerVulnerabilities || []).forEach(vuln => {
                const severity = vuln.severity || 'low';
                // Use full description instead of just category name
                const vulnName = vuln.description || vuln.library || 'Security Issue';
                const files = vuln.files || [];
                
                allVulnerabilities.push({
                    tool: 'Bearer',
                    severity: severity,
                    name: vulnName,
                    fileCount: files.length,
                    files: files,
                    sortOrder: getSeverityOrder(severity)
                });
            });
            
            // Add ESLint vulnerabilities (group by vulnerability type)
            if (eslintVulnerabilities) {
                Object.keys(eslintVulnerabilities).forEach(severity => {
                    const issues = eslintVulnerabilities[severity] || [];
                    if (issues.length > 0) {
                        // First deduplicate by file+line+rule+vulnerability to remove exact duplicates
                        const uniqueIssues = [];
                        const seenIssues = new Set();
                        
                        issues.forEach(issue => {
                            const key = `${issue.filename}:${issue.line_number}:${issue.rule_id}:${issue.vulnerability}`;
                            if (!seenIssues.has(key)) {
                                seenIssues.add(key);
                                uniqueIssues.push(issue);
                            }
                        });
                        
                        // Group by vulnerability type with semantic consolidation
                        const vulnGroups = {};
                        uniqueIssues.forEach(issue => {
                            let vulnType = issue.vulnerability || 'Security Issue';
                            
                            // Clean up Unicode bidirectional characters and truncate very long descriptions
                            vulnType = vulnType.replace(/[\u202E\u202D\u200E\u200F]/g, ''); // Remove bidi characters
                            if (vulnType.length > 150) {
                                // For very long descriptions, extract the key information
                                if (vulnType.toLowerCase().includes('trojan source') || vulnType.toLowerCase().includes('unicode bidi')) {
                                    vulnType = 'Detected potential trojan source attack with unicode bidirectional characters';
                                } else if (vulnType.toLowerCase().includes('html entity')) {
                                    vulnType = 'Detected embedded HTML entity mappings that may indicate obfuscation';
                                } else {
                                    vulnType = vulnType.substring(0, 147) + '...';
                                }
                            }
                            
                            // Consolidate similar vulnerability types
                            if (vulnType.toLowerCase().includes('eval')) {
                                vulnType = 'Dangerous eval() usage detected';
                            } else if (vulnType.toLowerCase().includes('prototype pollution')) {
                                vulnType = 'Potential prototype pollution vulnerability detected';
                            } else if (vulnType.toLowerCase().includes('unsafe regular expression') || vulnType.toLowerCase().includes('new regexp')) {
                                vulnType = 'Unsafe Regular Expression';
                            } else if (vulnType.toLowerCase().includes('window.location') || vulnType.toLowerCase().includes('location assignment')) {
                                vulnType = 'Unsafe location assignment detected';
                            } else if (vulnType.toLowerCase().includes('math.random') || vulnType.toLowerCase().includes('cryptographically secure')) {
                                vulnType = 'Insecure random number generation';
                            } else if (vulnType.toLowerCase().includes('control character') || vulnType.toLowerCase().includes('regular expression')) {
                                vulnType = 'Suspicious regular expression pattern';
                            } else if (vulnType.toLowerCase().includes('http url') || vulnType.toLowerCase().includes('https instead')) {
                                vulnType = 'Insecure HTTP URL detected. Use HTTPS instead';
                            } else if (vulnType.toLowerCase().includes('definition for rule') || vulnType.toLowerCase().includes('was not found')) {
                                vulnType = 'ESLint rule configuration issue';
                            } else if (vulnType.toLowerCase().includes('innerHTML') || vulnType.toLowerCase().includes('xss') || vulnType.toLowerCase().includes('unsanitized')) {
                                vulnType = 'Unsafe assignment to innerHTML. This can lead to XSS vulnerabilities';
                            } else if (vulnType.toLowerCase().includes('script url') || vulnType.toLowerCase().includes('form of eval')) {
                                vulnType = 'Script URL is a form of eval';
                            } else if (vulnType.toLowerCase().includes('function constructor')) {
                                vulnType = 'The Function constructor is eval';
                            } else if (vulnType.toLowerCase().includes('non-literal regexp') || vulnType.toLowerCase().includes('regexp constructor')) {
                                vulnType = 'Found non-literal argument to RegExp Constructor';
                            } else if (vulnType.toLowerCase().includes('redirect') && vulnType.toLowerCase().includes('user-controlled')) {
                                vulnType = 'Potentially unsafe redirect with user-controlled input';
                            }
                            
                            if (!vulnGroups[vulnType]) {
                                vulnGroups[vulnType] = [];
                            }
                            vulnGroups[vulnType].push(issue);
                        });
                        
                        // Create separate entries for each vulnerability type
                        Object.keys(vulnGroups).forEach(vulnType => {
                            const vulnIssues = vulnGroups[vulnType];
                            
                            // Further deduplicate by file+line combination within the vulnerability type
                            const uniqueFileLineIssues = [];
                            const seenFileLines = new Set();
                            
                            vulnIssues.forEach(issue => {
                                const fileLineKey = `${issue.filename}:${issue.line_number}`;
                                if (!seenFileLines.has(fileLineKey)) {
                                    seenFileLines.add(fileLineKey);
                                    uniqueFileLineIssues.push(issue);
                                }
                            });
                            
                            const files = uniqueFileLineIssues.map(issue => {
                                if (!issue.filename) return 'Unknown file';
                                // Extract just the file name from the path
                                let path = issue.filename;
                                if (path.startsWith('./')) path = path.substring(2);
                                if (path.startsWith('build/')) path = path.substring(6);
                                // Get only the file name (after last slash)
                                return path.split('/').pop();
                            });
                            const uniqueFiles = [...new Set(files)];
                            
                            allVulnerabilities.push({
                                tool: 'ESLint',
                                severity: severity,
                                name: vulnType,
                                fileCount: uniqueFileLineIssues.length, // Use deduplicated count
                                files: uniqueFiles,
                                sortOrder: getSeverityOrder(severity)
                            });
                        });
                    }
                });
            }
            
            // Sort by severity order (CRITICAL > HIGH > MEDIUM > LOW)
            allVulnerabilities.sort((a, b) => a.sortOrder - b.sortOrder);
            
            // Calculate totals and individual counts
            const retireJSCount = (vulnerabilities || []).length;
            const semgrepCount = (semgrepVulnerabilities || []).length;
            const bearerCount = (bearerVulnerabilities || []).length;
            // Calculate deduplicated ESLint count
            let eslintCount = 0;
            if (eslintVulnerabilities) {
                Object.keys(eslintVulnerabilities).forEach(severity => {
                    const issues = eslintVulnerabilities[severity] || [];
                    if (issues.length > 0) {
                        // Deduplicate by file+line+rule+vulnerability
                        const seenIssues = new Set();
                        issues.forEach(issue => {
                            const key = `${issue.filename}:${issue.line_number}:${issue.rule_id}:${issue.vulnerability}`;
                            if (!seenIssues.has(key)) {
                                seenIssues.add(key);
                                eslintCount++;
                            }
                        });
                    }
                });
            }
            
            const totalVulnCount = retireJSCount + semgrepCount + bearerCount + eslintCount;
            const totalFiles = (totalUniqueFiles || 0) + (totalSemgrepUniqueFiles || 0) + (totalBearerUniqueFiles || 0) + (totalEslintUniqueFiles || 0);
            
            // Update counts in header with individual tool counts
            document.getElementById('vulnCount').textContent = totalVulnCount;
            
            // Update the description to show individual counts
            const descriptionElement = document.querySelector('#vulnerabilities span[style*="color: #6b7280"]');
            if (descriptionElement) {
                descriptionElement.innerHTML = `Critical security issues found in extension libraries - RetireJS: ${retireJSCount}, Semgrep: ${semgrepCount}, Bearer: ${bearerCount}, ESLint: ${eslintCount}`;
            }
            
            if (totalFiles > 0) {
                document.getElementById('uniqueFilesCount').textContent = `${totalFiles} unique files affected`;
            }
            
            const vulnList = document.getElementById('vulnList');
            if (totalVulnCount === 0) {
                vulnList.innerHTML = '<p>No vulnerabilities detected.</p>';
                document.getElementById('uniqueFilesCount').textContent = '';
                return;
            }

            // Create proper table with sortable headers
            const tableHeader = `
                <div style="display: grid; grid-template-columns: 100px 100px 350px 100px 2fr; gap: 0.5rem; align-items: center; padding: 1rem; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-weight: 600; font-size: 0.85rem; color: #374151;">
                    <div class="sortable-header" data-sort="severity" style="padding-right: 0.5rem; border-right: 1px solid #d1d5db; cursor: pointer; user-select: none;">SEVERITY <span class="sort-arrow">‚Üï</span></div>
                    <div class="sortable-header" data-sort="tool" style="padding-right: 0.5rem; border-right: 1px solid #d1d5db; cursor: pointer; user-select: none;">TOOL <span class="sort-arrow">‚Üï</span></div>
                    <div class="sortable-header" data-sort="vulnerability" style="padding-right: 0.5rem; border-right: 1px solid #d1d5db; cursor: pointer; user-select: none;">VULNERABILITY <span class="sort-arrow">‚Üï</span></div>
                    <div class="sortable-header" data-sort="files" style="padding-right: 0.5rem; border-right: 1px solid #d1d5db; cursor: pointer; user-select: none;">FILES <span class="sort-arrow">‚Üï</span></div>
                    <div class="sortable-header" data-sort="affected" style="cursor: pointer; user-select: none;">AFFECTED FILES <span class="sort-arrow">‚Üï</span></div>
                </div>
            `;
            
            const vulnRows = allVulnerabilities.map(vuln => {
                const severityStyle = getSeverityBackground(vuln.severity);
                
                // Show files with expandable functionality - escape file names for security
                let filesList;
                if (vuln.files.length <= 10) {
                    // Make each file name clickable
                    const clickableFiles = vuln.files.map(file => {
                        const escapedFile = escapeHtml(file);
                        return `<a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${escapedFile}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #6b7280;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#6b7280'">${escapedFile}</a>`;
                    });
                    filesList = clickableFiles.join(', ');
                } else {
                    const visibleFiles = vuln.files.slice(0, 8);
                    const hiddenFiles = vuln.files.slice(8);
                    const expandId = `expand-${vuln.tool}-${vuln.severity}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Make file names clickable
                    const clickableVisibleFiles = visibleFiles.map(file => {
                        const escapedFile = escapeHtml(file);
                        return `<a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${escapedFile}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #6b7280;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#6b7280'">${escapedFile}</a>`;
                    });
                    const clickableHiddenFiles = hiddenFiles.map(file => {
                        const escapedFile = escapeHtml(file);
                        return `<a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${escapedFile}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #6b7280;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#6b7280'">${escapedFile}</a>`;
                    });
                    
                    filesList = `
                        <span>${clickableVisibleFiles.join(', ')}</span>
                        <span id="${expandId}-hidden" style="display: none;">, ${clickableHiddenFiles.join(', ')}</span>
                        <span id="${expandId}-toggle" onclick="toggleVulnFiles('${expandId}')" style="color: #1d4ed8; cursor: pointer; text-decoration: underline; margin-left: 4px;">(+${hiddenFiles.length} more files)</span>
                        <span id="${expandId}-collapse" onclick="toggleVulnFiles('${expandId}')" style="display: none; color: #dc2626; cursor: pointer; text-decoration: underline; margin-left: 4px;">(show less)</span>
                    `;
                }
                
                return `
                <div class="vuln-item-unified" 
                     data-severity="${vuln.severity}" 
                     data-tool="${vuln.tool}" 
                     data-vulnerability="${vuln.name}" 
                     data-files="${vuln.fileCount}" 
                     data-affected="${vuln.files.join(', ')}"
                     style="display: grid; grid-template-columns: 100px 100px 350px 100px 2fr; gap: 0.5rem; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem;">
                    <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; font-size: 0.75rem; text-align: center; ${severityStyle}">
                            ${vuln.severity.toUpperCase()}
                        </span>
                    </div>
                    <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; font-weight: 600; color: #374151;">
                        ${vuln.tool}
                    </div>
                    <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; font-weight: 500; color: #111827;">
                        ${escapeHtml(vuln.name)}
                    </div>
                    <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #6b7280;">
                        ${vuln.fileCount} file${vuln.fileCount !== 1 ? 's' : ''}
                    </div>
                    <div style="color: #374151; font-family: monospace; font-size: 0.8rem; word-wrap: break-word;">
                        ${filesList}
                    </div>
                </div>
                `;
            }).join('');
            
            const vulnHtml = tableHeader + vulnRows;

            vulnList.innerHTML = vulnHtml;
            
            // Add sorting functionality
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.dataset.sort;
                    sortVulnerabilitiesTable(sortBy);
                });
            });
            
            // Remove any existing separate sections (we now use unified table)
            const existingSemgrep = document.querySelector('[data-section="semgrep"]');
            if (existingSemgrep) {
                existingSemgrep.remove();
            }
            const existingBearer = document.querySelector('[data-section="bearer"]');
            if (existingBearer) {
                existingBearer.remove();
            }
        }
           function updateCodeDiffTab(diffData) {
    const codeDiffList = document.getElementById('codeDiffList');
    
    if (!diffData.analyses || diffData.analyses.length === 0) {
        codeDiffList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No code diff analysis available.</p>';
        return;
    }
    
    // Sort analyses by date (newest first)
    const sortedAnalyses = diffData.analyses.sort((a, b) => 
        new Date(b.raw_date || b.date) - new Date(a.raw_date || a.date)
    );
    
    // Create table header
    const tableHeader = `
        <div style="display: grid; grid-template-columns: 180px 120px 100px 150px 120px 120px 1fr; gap: 0.5rem; align-items: center; padding: 1rem; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-weight: 600; font-size: 0.85rem; color: #374151;">
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">VERSION</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">DATE</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">VERDICT</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">CHANGES</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">FILES</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">DETAILS</div>
            <div>Code Diff</div>
        </div>
    `;
    
    // Create table rows
    const diffRows = sortedAnalyses.map(analysis => {
        const stats = analysis.stats || {};
        const isNotMalicious = analysis.verdict === 'Not Malicious' || !analysis.malicious_detected;
        
       const verdictStyle = isNotMalicious 
    ? 'background: #10b981; color: white;' 
    : 'background: #dc2626; color: white;';

const maliciousStyle = analysis.malicious_detected 
    ? 'background: #dc2626; color: white;' 
    : 'background: #6b7280; color: white;';
        
        return `
            <div style="display: grid; grid-template-columns: 180px 120px 100px 150px 120px 120px 1fr; gap: 0.5rem; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem;">
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; font-weight: 600; color: #1e293b;">
                    <div>${analysis.curr_version || 'Unknown'}</div>
                </div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #6b7280; font-size: 0.8rem;">
                    ${analysis.date || 'Unknown'}
                </div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; text-align: center;">
    <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 8px; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.025em; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); ${verdictStyle}">
        
        <span>${analysis.verdict || 'Unknown'}</span>
    </div>
</div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #374151; font-size: 0.8rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #10b981;">+${stats.total_additions || 0}</span>
                            <span style="color: #dc2626;">-${stats.total_deletions || 0}</span>
                        </div>
                        <div style="color: #6b7280; font-size: 0.7rem;">
                            ${stats.added_files || 0} added, ${stats.removed_files || 0} removed
                        </div>
                    </div>
                </div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #374151; text-align: center;">
                    <div style="font-weight: 600;">${stats.total_files || 0}</div>
                    <div style="font-size: 0.7rem; color: #6b7280;">
                        ${stats.changed_files || 0} changed
                    </div>
                </div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; text-align: center;">
<span class="details-click-link" onclick="showAnalysisDetails(this.dataset.summary, this.dataset.prevVersion, this.dataset.currVersion)" data-summary="${analysis.summary.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}" data-prev-version="${analysis.prev_version}" data-curr-version="${analysis.curr_version}">
        Click to view
</span>
</div>
                <div style="color: #374151;">
                    <a href="${analysis.code_diff_link}" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       style="display: inline-flex; align-items: center; gap: 0.5rem; color: #3b82f6; text-decoration: none; padding: 0.5rem 1rem; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.8rem; font-weight: 500; transition: all 0.2s ease;"
                       onmouseover="this.style.background='#3b82f6'; this.style.color='white';"
                       onmouseout="this.style.background='transparent'; this.style.color='#3b82f6';">
                        <span>üìÑ</span>
                        View code differences
                    </a>
                </div>
            </div>
        `;
    }).join('');
    
    // Update summary in header if available
    if (diffData.summary) {
        const summaryText = document.querySelector('#code_diff span[style*="color: #6B7280"]');
        if (summaryText) {
            summaryText.innerHTML = `Track code changes and version differences - ${diffData.summary.total_analyses || 0} analyses available`;
        }
    }
    
    codeDiffList.innerHTML = tableHeader + diffRows;
}


function updateFileAnalyzerTab(data) {
    const fileAnalyzerList = document.getElementById('fileAnalyzerList');
    const fileAnalyzerCount = document.getElementById('fileAnalyzerCount');
    const fileAnalyzerSummary = document.getElementById('fileAnalyzerSummary');
    const maliciousFilesCount = document.getElementById('maliciousFilesCount');
    
    // Update counts
    fileAnalyzerCount.textContent = data.total_files || 0;
    fileAnalyzerSummary.textContent = `${data.malicious_files || 0} malicious files detected`;
    maliciousFilesCount.textContent = data.malicious_files > 0 ? `${data.malicious_files} malicious files` : 'No malicious files';
    
    if (!data.files || data.files.length === 0) {
        fileAnalyzerList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No file security analysis available.</p>';
        return;
    }
    
    // Sort files by risk level and malicious status
    const sortedFiles = data.files.sort((a, b) => {
        // Malicious files first
        if (a.is_malicious && !b.is_malicious) return -1;
        if (!a.is_malicious && b.is_malicious) return 1;
        
        // Then by risk level
        const riskOrder = { 'critical': 1, 'high': 2, 'medium': 3, 'low': 4 };
        return (riskOrder[a.risk_level] || 4) - (riskOrder[b.risk_level] || 4);
    });
    
    // Create table header
    const tableHeader = `
        <div style="display: grid; grid-template-columns: 200px 100px 120px 100px 150px 1fr; gap: 0.5rem; align-items: center; padding: 1rem; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-weight: 600; font-size: 0.85rem; color: #374151;">
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">FILENAME</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">TYPE</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">RISK LEVEL</div>
            <div style="padding-right: 0.5rem; border-right: 1px solid #d1d5db;">ANALYZED</div>
            <div>SECURITY SUMMARY</div>
        </div>
    `;
    
    // Create table rows
    const fileRows = sortedFiles.map(file => {
        const riskStyle = getRiskLevelStyle(file.risk_level);
        const verdictStyle = file.is_malicious ? 
            'background: #dc2626; color: white;' : 
            'background: #059669; color: white;';
        
        // Truncate long summaries
        let summaryDisplay = file.summary || 'No summary available';
        if (summaryDisplay.length > 100) {
            const summaryId = `summary-${Math.random().toString(36).substr(2, 9)}`;
            const truncated = summaryDisplay.substring(0, 100);
            const remaining = summaryDisplay.substring(100);
            
            summaryDisplay = `
                <div>
                    <span id="${summaryId}-truncated">${escapeHtml(truncated)}</span>
                    <span id="${summaryId}-toggle" 
                          style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                          onclick="toggleSummary('${summaryId}')" 
                          onmouseover="this.style.color='#2a2563'" 
                          onmouseout="this.style.color='#342e7c'">
                        ...show more
                    </span>
                    <span id="${summaryId}-hidden" style="display: none;">${escapeHtml(remaining)}</span>
                    <div id="${summaryId}-collapse" style="display: none; margin-top: 0.5rem;">
                        <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                              onclick="toggleSummary('${summaryId}')" 
                              onmouseover="this.style.color='#b91c1c'" 
                              onmouseout="this.style.color='#dc2626'">
                            ‚Üë Show less
                        </span>
                    </div>
                </div>
            `;
        } else {
            summaryDisplay = escapeHtml(summaryDisplay);
        }
        
        return `
            <div style="display: grid; grid-template-columns: 200px 100px 120px 100px 2fr; gap: 0.5rem; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; font-size: 0.9rem;">
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; font-weight: 600; color: #374151;">
                    <a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${file.filename}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #6b7280;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#6b7280'">${escapeHtml(file.filename)}</a>
                </div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #6b7280; text-transform: uppercase; font-size: 0.8rem;">
                    ${escapeHtml(file.file_type)}
                </div>
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; text-align: center;">
                    <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; font-size: 0.75rem; text-align: center; ${riskStyle}">
                        ${file.risk_level.toUpperCase()}
                    </span>
                </div>
             
                <div style="padding-right: 0.5rem; border-right: 1px solid #e5e7eb; color: #6b7280; font-size: 0.8rem;">
                    ${file.date}
                </div>
                <div style="color: #374151; font-size: 0.85rem; line-height: 1.4;">
                    ${summaryDisplay}
                </div>
            </div>
        `;
    }).join('');
    
    fileAnalyzerList.innerHTML = tableHeader + fileRows;
}

function getRiskLevelStyle(riskLevel) {
    const styles = {
        'critical': 'background: #7f1d1d; color: white;',
        'high': 'background: #dc2626; color: white;',
        'medium': 'background: #ea580c; color: white;',
        'low': 'background: #059669; color: white;'
    };
    return styles[riskLevel] || styles['low'];
}

function toggleSummary(summaryId) {
    const truncated = document.getElementById(`${summaryId}-truncated`);
    const toggle = document.getElementById(`${summaryId}-toggle`);
    const hidden = document.getElementById(`${summaryId}-hidden`);
    const collapse = document.getElementById(`${summaryId}-collapse`);
    
    if (hidden && toggle && collapse) {
        if (hidden.style.display === 'none') {
            // Show full summary
            hidden.style.display = 'inline';
            toggle.style.display = 'none';
            collapse.style.display = 'block';
        } else {
            // Show truncated summary
            hidden.style.display = 'none';
            toggle.style.display = 'inline';
            collapse.style.display = 'none';
        }
    }
}

        function toggleFiles(element) {
            const parent = element.parentElement;
            const hiddenFiles = parent.querySelector('.hidden-files');
            
            if (hiddenFiles.style.display === 'none') {
                // Show hidden files
                hiddenFiles.style.display = 'inline';
                element.textContent = '[-less]';
            } else {
                // Hide files
                hiddenFiles.style.display = 'none';
                const fileCount = hiddenFiles.textContent.split(',').filter(f => f.trim().length > 0).length;
                element.textContent = `[+${fileCount} more]`;
            }
        }

        function toggleVulnFiles(expandId) {
            const hiddenSpan = document.getElementById(`${expandId}-hidden`);
            const toggleSpan = document.getElementById(`${expandId}-toggle`);
            const collapseSpan = document.getElementById(`${expandId}-collapse`);
            
            if (hiddenSpan && toggleSpan && collapseSpan) {
                // Check if hidden span is currently visible
                const isHidden = hiddenSpan.style.display === 'none' || window.getComputedStyle(hiddenSpan).display === 'none';
                
                if (isHidden) {
                    // Show all files
                    hiddenSpan.style.display = 'inline';
                    toggleSpan.style.display = 'none';
                    collapseSpan.style.display = 'inline';
                } else {
                    // Hide extra files
                    hiddenSpan.style.display = 'none';
                    toggleSpan.style.display = 'inline';
                    collapseSpan.style.display = 'none';
                }
            }
        }

        // Global sorting state
        let currentSortColumn = 'severity';
        let currentSortDirection = 'asc';

        function sortVulnerabilitiesTable(column) {
            const vulnList = document.getElementById('vulnList');
            const rows = Array.from(vulnList.querySelectorAll('.vuln-item-unified'));
            
            // Toggle sort direction if same column clicked
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = column;
            }
            
            // Update sort arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.textContent = '‚Üï';
            });
            
            const activeHeader = document.querySelector(`[data-sort="${column}"] .sort-arrow`);
            if (activeHeader) {
                activeHeader.textContent = currentSortDirection === 'asc' ? '‚Üë' : '‚Üì';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'severity':
                        const severityOrder = { 'critical': 1, 'high': 2, 'medium': 3, 'low': 4 };
                        aValue = severityOrder[a.dataset.severity.toLowerCase()] || 5;
                        bValue = severityOrder[b.dataset.severity.toLowerCase()] || 5;
                        break;
                    case 'tool':
                        aValue = a.dataset.tool.toLowerCase();
                        bValue = b.dataset.tool.toLowerCase();
                        break;
                    case 'vulnerability':
                        aValue = a.dataset.vulnerability.toLowerCase();
                        bValue = b.dataset.vulnerability.toLowerCase();
                        break;
                    case 'files':
                        aValue = parseInt(a.dataset.files) || 0;
                        bValue = parseInt(b.dataset.files) || 0;
                        break;
                    case 'affected':
                        aValue = a.dataset.affected.toLowerCase();
                        bValue = b.dataset.affected.toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // Re-append sorted rows
            const tableHeader = vulnList.querySelector('[style*="background: #f8fafc"]');
            vulnList.innerHTML = '';
            vulnList.appendChild(tableHeader);
            rows.forEach(row => vulnList.appendChild(row));
        }

        function createSemgrepVulnerabilitiesSection(semgrepVulnerabilities, totalSemgrepUniqueFiles) {
            // Create grouped display for Semgrep vulnerabilities - EXACT same format as above
            const semgrepHtml = semgrepVulnerabilities.map(vuln => {
                const severity = vuln.severity && vuln.severity !== 'unknown' ? vuln.severity : 'medium';
                const fileCount = vuln.files ? vuln.files.length : 0;
                
                // Create scrollable files list - SAME format as RetireJS
                const filesListHtml = vuln.files && vuln.files.length > 0 
                    ? vuln.files.map(file => {
                        const fileName = typeof file === 'string' ? file : (file.filename || file);
                        return `<span style="display: inline-block; margin: 2px 4px; padding: 2px 6px; background: #f3f4f6; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">${fileName}</span>`;
                    }).join('')
                    : '<span style="color: #9ca3af;">No files</span>';
                
                return `
                <div class="vuln-item" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1.25rem 1.5rem;">
                    <div style="flex-shrink: 0; width: 250px;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <span class="vuln-severity ${severity.toLowerCase()}">${severity.toUpperCase()}</span>
                            <strong style="font-size: 1rem;">${vuln.library || vuln.title}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 0.85rem;">${vuln.description || 'Semgrep security vulnerability'}</div>
                        <div style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem;">${fileCount} file${fileCount !== 1 ? 's' : ''} affected</div>
                    </div>
                    <div style="flex: 1; background: #f9fafb; border-radius: 8px; padding: 0.75rem; max-height: 120px; overflow-y: auto; border: 1px solid #e5e7eb;">
                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">Affected Files:</div>
                        <div style="line-height: 1.6;">
                            ${filesListHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            return `
                <div data-section="semgrep" style="margin-top: 2rem;">
                    <div class="vuln-tab-container">
                        <div class="vuln-summary-wrapper">
                            <div class="vuln-summary">
                                <div class="vuln-count">${semgrepVulnerabilities.length}</div>
                                <h2>Semgrep Security Analysis</h2>
                                <p>Static analysis vulnerabilities detected</p>
                                <p style="font-size: 0.65rem !important; color: #b91c1c !important; margin-top: 0.2rem !important; font-weight: 700 !important; max-width: 100px; line-height: 1 !important; padding: 0 5px;">${totalSemgrepUniqueFiles || 0} unique files affected</p>
                            </div>
                        </div>
                        
                        <div class="vuln-list-wrapper">
                            <div class="vuln-list-shadow" style="background: white;"></div>
                            <div class="vuln-list" style="border: 1px solid rgb(200, 200, 200);">
                                ${semgrepHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBearerVulnerabilitiesSection(bearerVulnerabilities, totalBearerUniqueFiles) {
            // Create grouped display for Bearer vulnerabilities - EXACT same format as Semgrep
            const bearerHtml = bearerVulnerabilities.map(vuln => {
                const severity = vuln.severity && vuln.severity !== 'unknown' ? vuln.severity : 'medium';
                const fileCount = vuln.files ? vuln.files.length : 0;
                
                // Create scrollable files list - SAME format as RetireJS and Semgrep
                const filesListHtml = vuln.files && vuln.files.length > 0 
                    ? vuln.files.map(file => {
                        const fileName = typeof file === 'string' ? file : (file.filename || file);
                        return `<span style="display: inline-block; margin: 2px 4px; padding: 2px 6px; background: #f3f4f6; border-radius: 4px; font-family: monospace; font-size: 0.8rem;">${fileName}</span>`;
                    }).join('')
                    : '<span style="color: #9ca3af;">No files</span>';
                
                return `
                <div class="vuln-item" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1.25rem 1.5rem;">
                    <div style="flex-shrink: 0; width: 250px;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <span class="vuln-severity ${severity.toLowerCase()}">${severity.toUpperCase()}</span>
                            <strong style="font-size: 1rem;">${vuln.library || vuln.title}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 0.85rem;">${vuln.description || 'Bearer security vulnerability'}</div>
                        <div style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem;">${fileCount} file${fileCount !== 1 ? 's' : ''} affected</div>
                    </div>
                    <div style="flex: 1; background: #f9fafb; border-radius: 8px; padding: 0.75rem; max-height: 120px; overflow-y: auto; border: 1px solid #e5e7eb;">
                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">Affected Files:</div>
                        <div style="line-height: 1.6;">
                            ${filesListHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            return `
                <div data-section="bearer" style="margin-top: 2rem;">
                    <div class="vuln-tab-container">
                        <div class="vuln-summary-wrapper">
                            <div class="vuln-summary">
                                <div class="vuln-count">${bearerVulnerabilities.length}</div>
                                <h2>Bearer Security Analysis</h2>
                                <p>Static code analysis vulnerabilities detected</p>
                                <p style="font-size: 0.65rem !important; color: #b91c1c !important; margin-top: 0.2rem !important; font-weight: 700 !important; max-width: 100px; line-height: 1 !important; padding: 0 5px;">${totalBearerUniqueFiles || 0} unique files affected</p>
                            </div>
                        </div>
                        
                        <div class="vuln-list-wrapper">
                            <div class="vuln-list-shadow" style="background: white;"></div>
                            <div class="vuln-list" style="border: 1px solid rgb(200, 200, 200);">
                                ${bearerHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCodeAnalysisTab(analysis, obfuscation, gitleaks, iocAnalysis) {
            // Code metrics with Attack Vault style
            const metricsHtml = `
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${analysis.total_files}</div>
                        <div class="metric-label">JS Files</div>
                    </div>
                </div>
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${analysis.total_functions.toLocaleString()}</div>
                        <div class="metric-label">Functions</div>
                    </div>
                </div>
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${analysis.total_api_calls.toLocaleString()}</div>
                        <div class="metric-label">API Calls</div>
                    </div>
                </div>
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${analysis.total_variables.toLocaleString()}</div>
                        <div class="metric-label">Variables</div>
                    </div>
                </div>
                ${obfuscation && obfuscation.total_obfuscated_files > 0 ? `
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${obfuscation.total_obfuscated_files}</div>
                        <div class="metric-label">Obfuscated</div>
                    </div>
                </div>
                ` : ''}
                ${gitleaks && gitleaks.total_secrets > 0 ? `
                <div class="metric-card-wrapper">
                    <div class="metric-shadow"></div>
                    <div class="metric-card">
                        <div class="metric-number">${gitleaks.total_secrets}</div>
                        <div class="metric-label">Secrets</div>
                    </div>
                </div>
                ` : ''}
            `;
            document.getElementById('codeMetrics').innerHTML = metricsHtml;

            // Files list with click functionality
            // Create a map of obfuscated files for easy lookup
            const obfuscatedFileMap = {};
            if (obfuscation && obfuscation.obfuscated_files) {
                obfuscation.obfuscated_files.forEach(file => {
                    // Store both the relative path and filename for matching
                    obfuscatedFileMap[file.relative_path || file.filename] = true;
                    // Also store just the filename without path for additional matching
                    const filename = (file.relative_path || file.filename).split('/').pop();
                    obfuscatedFileMap[filename] = true;
                });
            }
            
            const filesHtml = analysis.files.map(file => {
                // Check if file is obfuscated by trying different path formats
                let isObfuscated = false;
                if (obfuscatedFileMap) {
                    // Try full path
                    isObfuscated = obfuscatedFileMap[file.full_path] || false;
                    // Try extracting the relative path (remove ../input/extension_id/ prefix)
                    if (!isObfuscated && file.full_path) {
                        const match = file.full_path.match(/\/([^\/]+\/[^\/]+)$/);
                        if (match) {
                            const relativePath = match[0].substring(1); // Remove leading slash
                            isObfuscated = obfuscatedFileMap[relativePath] || false;
                        }
                        // Also try the path after the extension ID
                        const parts = file.full_path.split('/');
                        const extIdIndex = parts.findIndex(p => p === extensionId);
                        if (extIdIndex >= 0 && extIdIndex < parts.length - 1) {
                            const pathAfterExtId = parts.slice(extIdIndex + 1).join('/');
                            isObfuscated = isObfuscated || obfuscatedFileMap[pathAfterExtId] || false;
                        }
                    }
                    // Try just the filename
                    if (!isObfuscated) {
                        isObfuscated = obfuscatedFileMap[file.filename] || false;
                    }
                }
                return `
                <div class="file-item clickable" onclick="showFileDetails('${file.full_path || file.filename}', '${file.filename}')">
                    <div class="file-info">
                        <a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${file.filename}" target="_blank" class="file-name" style="text-decoration: none; color: inherit;" onclick="event.stopPropagation();">${file.filename}</a>
                        ${isObfuscated ? '<span class="obfuscated-badge">OBFUSCATED</span>' : '<span class="obfuscated-spacer"></span>'}
                    </div>
                    <div class="file-stats">
                        <span><i class="fas fa-code"></i> ${file.function_count} functions</span>
                        <span><i class="fas fa-link"></i> ${file.api_call_count} API calls</span>
                        <span><i class="fas fa-variable"></i> ${file.variable_count} variables</span>
                    </div>
                    <div class="file-hover-hint">Click to view details</div>
                </div>
            `}).join('');
            document.getElementById('filesList').innerHTML = filesHtml;
            
            // Add gitleaks section if data exists
            
            if (gitleaks && gitleaks.total_secrets && gitleaks.total_secrets > 0) {
                const gitleaksSection = createGitleaksSection(gitleaks);
                
                // Insert after the files card wrapper
                const filesCard = document.querySelector('#filesCardWrapper');
                
                // Insert gitleaks content into placeholder instead of after filesCard
                const gitleaksPlaceholder = document.getElementById('gitleaksPlaceholder');
                if (gitleaksPlaceholder) {
                    gitleaksPlaceholder.innerHTML = gitleaksSection;
                }
            }
            
            // Add IOC Analysis section if data exists
            if (iocAnalysis && iocAnalysis.total_iocs > 0) {
                // Store IOC data globally for tab switching
                currentIOCData = iocAnalysis;
                const iocSection = createIOCSection(iocAnalysis);
                
                // Find where to insert - after gitleaks if it exists, otherwise after files
                let insertAfter = null;
                const allCards = document.querySelectorAll('.info-card-wrapper');
                allCards.forEach(card => {
                    const h3 = card.querySelector('h3');
                    if (h3 && h3.textContent.includes('Secret Detections')) {
                        insertAfter = card;
                    }
                });
                
                if (!insertAfter) {
                    insertAfter = document.querySelector('#filesCardWrapper');
                }
                
                // Insert IOC content into placeholder instead of after other elements
                const iocPlaceholder = document.getElementById('iocPlaceholder');
                if (iocPlaceholder) {
                    iocPlaceholder.innerHTML = iocSection;
                    // Initialize the IOC tabs (all tab is default)
                    setTimeout(() => {
                        updateIOCContent(iocAnalysis, 'all');
                    }, 100);
                }
            }
            
            // Add obfuscation detection details if data exists
            if (obfuscation && obfuscation.total_obfuscated_files > 0) {
                const obfuscationWrapper = document.getElementById('obfuscationCardWrapper');
                const obfuscationContent = document.getElementById('obfuscationContent');
                
                obfuscationContent.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #dc2626; font-size: 1.2rem;">${obfuscation.total_obfuscated_files} files</strong> contain obfuscated code
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${obfuscation.obfuscated_files.map(file => `
                            <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="background: #dc2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 0.75rem;">OBFUSCATED</span>
                                    <strong style="font-family: monospace; font-size: 0.9rem;"><a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${file.filename.startsWith('./') ? file.filename.substring(2) : file.filename}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #374151;" onmouseover="this.style.borderBottomColor='#dc2626'" onmouseout="this.style.borderBottomColor='#374151'">${file.filename.startsWith('./') ? file.filename.substring(2) : file.filename}</a></strong>
                                </div>
                                <div style="color: #7f1d1d; font-size: 0.85rem;">
                                    <strong>Detection Methods:</strong> ${file.obfuscation_types.join(', ')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Show the obfuscation section
                obfuscationWrapper.style.display = 'block';
            }
        }

        function createGitleaksSection(gitleaks) {
            // Group findings by file
            const findingsByFile = {};
            gitleaks.findings.forEach(finding => {
                // Extract only the filename from the full path
                const fullPath = finding.filename || 'Unknown file';
                const filename = fullPath.includes('/') ? 
                    fullPath.split('/').pop() : 
                    (fullPath.startsWith('./') ? fullPath.substring(2) : fullPath);
                    
                if (!findingsByFile[filename]) {
                    findingsByFile[filename] = [];
                }
                findingsByFile[filename].push(finding);
            });
            
            // Create findings HTML
            const findingsHtml = Object.entries(findingsByFile).map(([filename, findings]) => {
                return findings.map(finding => `
                    <div class="vuln-item">
                        <span class="vuln-severity ${finding.severity || 'high'}">${(finding.severity || 'high').toUpperCase()}</span>
                        <div>
                            <strong><a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${filename}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #374151;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#374151'">${filename}</a>: ${finding.secret_type || 'Secret'}</strong>
                            <div style="color: #6b7280; font-size: 0.9rem;">
                                ${finding.rule_id || 'Unknown rule'} - Line ${finding.line_number || 'N/A'}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.8rem; font-family: monospace; margin-top: 0.25rem; word-break: break-all;">
                                ${(() => {
                                    // Extract full credential from finding_context if available
                                    if (finding.finding_context) {
                                        const cleanContext = finding.finding_context.replace(/\x1b\[[0-9;]*m/g, '');
                                        const match = cleanContext.match(/[A-Z0-9]{20,}/);
                                        return match ? match[0] : (finding.secret_preview ? finding.secret_preview.replace(/\x1b\[[0-9;]*m/g, '') : 'Secret redacted');
                                    }
                                    return finding.secret_preview ? finding.secret_preview.replace(/\x1b\[[0-9;]*m/g, '') : 'Secret redacted';
                                })()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }).join('');
            
            return `
                <div class="info-card-wrapper" style="margin-top: 2rem;">
                    <div class="card-shadow"></div>
                    <div class="info-card">
                        <h3>üîë Secret Detections</h3>
                        <div class="vuln-tab-container">
                            <div class="vuln-summary-wrapper">
                                <div class="vuln-summary">
                                    <div class="vuln-count">${gitleaks.total_secrets}</div>
                                    <h2>Gitleaks Secret Detections</h2>
                                    <p>Hardcoded API keys and credentials found by gitleaks</p>
                                    <p id="gitleaksUniqueFilesCount">${Object.keys(findingsByFile).length} unique files affected</p>
                                </div>
                            </div>
                            
                            <div class="vuln-list-wrapper">
                                <div class="vuln-list-shadow"></div>
                                <div class="vuln-list">
                                    ${findingsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create styled badges for different IOC types (moved to global scope)
        function createIOCBadge(type, count) {
                const colors = {
                    'URLs': { color: '#7c3aed', icon: 'üîó' },
                    'Domains': { color: '#059669', icon: 'üåê' },
                    'Emails': { color: '#2563eb', icon: 'üìß' },
                    'IPs': { color: '#ea580c', icon: 'üî¢' },
                    'API Calls': { color: '#dc2626', icon: 'üì°' }
                };
                const colorConfig = colors[type] || { color: '#6b7280', icon: 'üìå' };
                
                return count > 0 ? `
                    <div class="extension-badge ioc-badge-${type.toLowerCase().replace(' ', '-')}" 
                         data-original-color="${colorConfig.color}"
                         style="
                        padding: 0.5rem 1rem;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        border: 2px solid ${colorConfig.color};
                        position: relative;
                        overflow: hidden;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        cursor: pointer;
                        color: ${colorConfig.color};
                        background: transparent;
                        margin: 0.25rem;
                    " onmouseover="if(!this.classList.contains('selected') && !this.classList.contains('dimmed')) { this.style.background='${colorConfig.color}'; this.style.color='white'; this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 4px 12px ${colorConfig.color}40'; this.style.opacity='1'; }" 
                       onmouseout="if(!this.classList.contains('selected') && !this.classList.contains('dimmed')) { this.style.background='transparent'; this.style.color='${colorConfig.color}'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='none'; this.style.opacity='1'; }" 
                       onclick="filterIOCByType('${type}')">
                        <span class="badge-emoji" style="font-size: 1rem; filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));">${colorConfig.icon}</span>
                        ${count.toLocaleString()} ${type}
                    </div>
                ` : '';
        }
        
        // Create IOC items grouped by type (moved to global scope)
        function createIOCItems(iocList, type, color) {
                if (!iocList || iocList.length === 0) return '';
                
                // Group by value to avoid duplicates
                const uniqueIOCs = {};
                iocList.forEach(ioc => {
                    if (!uniqueIOCs[ioc.value]) {
                        uniqueIOCs[ioc.value] = [];
                    }
                    uniqueIOCs[ioc.value].push(ioc.filename);
                });
                
                return Object.entries(uniqueIOCs).map(([value, files], index) => {
                    // Deduplicate and limit files shown
                    const uniqueFiles = [...new Set(files)];
                    const maxFiles = 3;
                    const fileId = `files-${type.toLowerCase().replace(' ', '-')}-${index}`;
                    
                    // Create file display with expandable functionality
                    let fileDisplay = '';
                    if (uniqueFiles.length <= maxFiles) {
                        fileDisplay = uniqueFiles.join(', ');
                    } else {
                        const visibleFiles = uniqueFiles.slice(0, maxFiles).join(', ');
                        const hiddenFiles = uniqueFiles.slice(maxFiles).join(', ');
                        const moreCount = uniqueFiles.length - maxFiles;
                        
                        fileDisplay = `
                            <div>
                                ${visibleFiles}
                                <span id="${fileId}-toggle" 
                                      style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                      onclick="toggleFileList('${fileId}')" 
                                      onmouseover="this.style.color='#2a2563'" 
                                      onmouseout="this.style.color='#342e7c'">
                                    +${moreCount} more
                                </span>
                                <div id="${fileId}-hidden" style="display: none;">
                                    ${hiddenFiles}
                                </div>
                                <div id="${fileId}-collapse" style="display: none; margin-top: 0.5rem;">
                                    <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                          onclick="toggleFileList('${fileId}')" 
                                          onmouseover="this.style.color='#b91c1c'" 
                                          onmouseout="this.style.color='#dc2626'">
                                        ‚Üë Show less
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Truncate long URLs/values
                    let displayValue = value;
                    if (value.length > 60) {
                        displayValue = value.substring(0, 57) + '...';
                    }
                    
                    // Highlight suspicious patterns
                    let suspiciousClass = '';
                    let suspiciousLabel = '';
                    if (type === 'URLs' || type === 'Domains') {
                        if (value.includes('telemetry') || value.includes('analytics') || value.includes('tracking')) {
                            suspiciousClass = 'suspicious-tracking';
                            suspiciousLabel = '<span style="background: #dc2626; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">TRACKING</span>';
                        } else if (!value.includes('https://') && value.includes('http://')) {
                            suspiciousClass = 'suspicious-http';
                            suspiciousLabel = '<span style="background: #ea580c; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">INSECURE</span>';
                        }
                    } else if (type === 'IPs') {
                        if (value.includes('127.0.0.1') || value.includes('localhost')) {
                            suspiciousClass = 'local-ip';
                            suspiciousLabel = '<span style="background: #6b7280; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">LOCAL</span>';
                        } else if (value.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
                            // IPv4 address - add geolocation
                            suspiciousLabel = '<span id="geo-' + Math.random().toString(36).substr(2, 9) + '" style="background: #059669; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;" onclick="lookupIPLocation(\'' + value + '\', this)">üìç Locate</span>';
                        }
                    }
                    
                    return `
                        <div class="ioc-item ${suspiciousClass}" style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1; margin-right: 1rem;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                                    ${suspiciousLabel}
                                    <span style="background: #f3f4f6; color: #6b7280; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: ${suspiciousLabel ? '0.5rem' : '0'};">
                                        ${uniqueFiles.length} file${uniqueFiles.length !== 1 ? 's' : ''}
                                    </span>
                                </div>
                                <div style="font-family: 'Monaco', 'Consolas', monospace; font-size: 0.85rem; color: #374151; word-break: break-all; line-height: 1.4; margin-bottom: 0.5rem;">
                                    ${escapeHtml(displayValue)}
                                </div>
                                <div style="color: #6b7280; font-size: 0.75rem;">
                                    ${escapeHtml(fileDisplay)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function createIOCSection(iocAnalysis) {
            // Professional table-based IOC display
            return `
                <div class="info-card-wrapper" style="margin-top: 2rem;">
                    <div class="card-shadow"></div>
                    <div class="info-card">
                        <h3>üéØ IOC Analysis</h3>
                        
                        <!-- Search Box -->
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="ioc-search" placeholder="Search IOCs (value, type, filename, risk)..." 
                                   style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; 
                                          background: #ffffff; transition: border-color 0.2s ease; font-family: 'Monaco', 'Consolas', monospace;"
                                   onkeyup="searchIOCTable()" 
                                   onfocus="this.style.borderColor='#342e7c'; this.style.outline='none'; this.style.boxShadow='0 0 0 3px rgba(52, 46, 124, 0.1)'"
                                   onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'">
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem;">
                            <div style="display: flex; gap: 0;">
                                <div id="ioc-tab-all" class="ioc-tab active" onclick="switchIOCTab('all')" 
                                     style="padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; 
                                            border-bottom: 3px solid #342e7c; color: #342e7c; background: #f8fafc; 
                                            transition: all 0.2s ease; position: relative; top: 2px;">
                                    All
                                </div>
                                <div id="ioc-tab-unique" class="ioc-tab" onclick="switchIOCTab('unique')" 
                                     style="padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; 
                                            border-bottom: 3px solid transparent; color: #6b7280; background: transparent; 
                                            transition: all 0.2s ease;">
                                    Unique
                                </div>
                            </div>
                        </div>
                        
                        <!-- Professional IOC Table -->
                        <div class="vuln-list-wrapper" style="width: 100%;">
                            <div class="vuln-list-shadow"></div>
                            <div class="vuln-list" style="max-height: 500px; overflow-y: auto; padding: 0;">
                                <table id="ioc-table" style="width: 100%; border-collapse: collapse; font-family: 'Monaco', 'Consolas', monospace; font-size: 0.85rem;">
                                    <thead style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                                        <tr>
                                            <th onclick="sortIOCTable('files')" style="cursor: pointer; padding: 0.75rem 1rem; text-align: left; border-right: 1px solid #e5e7eb; border-bottom: 2px solid #d1d5db; font-weight: 600; color: #374151; user-select: none; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='#f8fafc'">
                                                File <span style="color: #9ca3af; font-size: 0.7rem;">‚ñº</span>
                                            </th>
                                            <th onclick="sortIOCTable('value')" style="cursor: pointer; padding: 0.75rem 1rem; text-align: left; border-right: 1px solid #e5e7eb; border-bottom: 2px solid #d1d5db; font-weight: 600; color: #374151; user-select: none; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='#f8fafc'">
                                                Value <span style="color: #9ca3af; font-size: 0.7rem;">‚ñº</span>
                                            </th>
                                            <th onclick="sortIOCTable('type')" style="cursor: pointer; padding: 0.75rem 1rem; text-align: left; border-right: 1px solid #e5e7eb; border-bottom: 2px solid #d1d5db; font-weight: 600; color: #374151; user-select: none; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='#f8fafc'">
                                                Type <span style="color: #9ca3af; font-size: 0.7rem;">‚ñº</span>
                                            </th>
                                            <th onclick="sortIOCTable('risk')" style="cursor: pointer; padding: 0.75rem 1rem; text-align: center; border-bottom: 2px solid #d1d5db; font-weight: 600; color: #374151; user-select: none; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f1f5f9'" onmouseout="this.style.backgroundColor='#f8fafc'">
                                                Risk <span style="color: #9ca3af; font-size: 0.7rem;">‚ñº</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="ioc-table-body">
                                        <!-- Table rows will be populated by tab logic -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Global variable to store IOC data for tab switching
        let currentIOCData = null;
        let currentActiveTab = 'all';

        function switchIOCTab(tabType) {
            if (!currentIOCData) return;
            
            currentActiveTab = tabType;
            
            // Update tab styles for proper tabbed UI
            const uniqueTab = document.getElementById('ioc-tab-unique');
            const allTab = document.getElementById('ioc-tab-all');
            
            if (tabType === 'unique') {
                // Active unique tab
                uniqueTab.style.borderBottom = '3px solid #342e7c';
                uniqueTab.style.color = '#342e7c';
                uniqueTab.style.background = '#f8fafc';
                uniqueTab.style.fontWeight = '600';
                uniqueTab.style.position = 'relative';
                uniqueTab.style.top = '2px';
                
                // Inactive all tab
                allTab.style.borderBottom = '3px solid transparent';
                allTab.style.color = '#6b7280';
                allTab.style.background = 'transparent';
                allTab.style.fontWeight = '500';
                allTab.style.position = 'static';
                allTab.style.top = '0';
            } else {
                // Active all tab
                allTab.style.borderBottom = '3px solid #342e7c';
                allTab.style.color = '#342e7c';
                allTab.style.background = '#f8fafc';
                allTab.style.fontWeight = '600';
                allTab.style.position = 'relative';
                allTab.style.top = '2px';
                
                // Inactive unique tab
                uniqueTab.style.borderBottom = '3px solid transparent';
                uniqueTab.style.color = '#6b7280';
                uniqueTab.style.background = 'transparent';
                uniqueTab.style.fontWeight = '500';
                uniqueTab.style.position = 'static';
                uniqueTab.style.top = '0';
            }
            
            // Check if there's an active filter and preserve it
            if (currentIOCFilter) {
                // Apply the current filter to the new tab view without toggling
                applyIOCFilter(currentIOCFilter, tabType);
            } else {
                // No filter active, show all content for the new tab
                updateIOCContent(currentIOCData, tabType);
                // Ensure badges maintain their original colors after tab switch
                setTimeout(() => {
                    updateIOCBadgeAppearance(null);
                }, 100);
            }
        }

        // Debug function to check badge colors
        function debugBadgeColors() {
        }

        // Apply IOC filter without toggling (used when switching tabs)
        function applyIOCFilter(filterType, tabType) {
            // Get IOC analysis data from the current extension
            const iocAnalysis = currentIOCData || window.extensionAnalysisData?.ioc_analysis;
            if (!iocAnalysis) return;
            
            // Filter IOC data based on selected type
            let filteredIOC = {
                urls: [],
                domains: [],
                api_calls: [],
                emails: [],
                ipv4s: [],
                ipv6s: []
            };
            
            // Only populate the selected type
            switch (filterType) {
                case 'URLs':
                    filteredIOC.urls = iocAnalysis.urls || [];
                    break;
                case 'Domains':
                    filteredIOC.domains = iocAnalysis.domains || [];
                    break;
                case 'API Calls':
                    filteredIOC.api_calls = iocAnalysis.api_calls || [];
                    break;
                case 'Emails':
                    filteredIOC.emails = iocAnalysis.emails || [];
                    break;
                case 'IPs':
                    filteredIOC.ipv4s = iocAnalysis.ipv4s || [];
                    filteredIOC.ipv6s = iocAnalysis.ipv6s || [];
                    break;
            }
            
            // Update only the content, not the badges
            updateIOCContentOnly(filteredIOC, tabType);
            
            // Update badge appearance to maintain the active filter highlight
            updateIOCBadgeAppearance(currentIOCFilter);
        }

        function updateIOCContent(iocAnalysis, tabType) {
            const tableBody = document.getElementById('ioc-table-body');
            
            if (!tableBody) {
                return;
            }
            
            if (tabType === 'all') {
                // Show ALL instances - the raw data without deduplication
                const allIOCRows = createIOCTableRows(iocAnalysis, 'all');
                
                tableBody.innerHTML = allIOCRows || '<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">No IOCs detected</td></tr>';
                
            } else {
                // Show UNIQUE IOCs - deduplicated values
                const uniqueIOCRows = createIOCTableRows(iocAnalysis, 'unique');
                
                tableBody.innerHTML = uniqueIOCRows || '<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 2rem;">No IOCs detected</td></tr>';
            }
        }

        function updateIOCContentOnly(iocAnalysis, tabType) {
            const contentContainer = document.getElementById('ioc-content');
            
            if (!contentContainer) {
                return;
            }
            
            if (tabType === 'all') {
                // Show ALL instances - the raw data without deduplication
                const allIOCItems = createRawIOCItems(iocAnalysis.urls, 'URLs', '#7c3aed') +
                                   createRawIOCItems(iocAnalysis.domains, 'Domains', '#059669') +
                                   createRawIOCItems(iocAnalysis.api_calls, 'API Calls', '#dc2626') +
                                   createRawIOCItems(iocAnalysis.emails, 'Emails', '#2563eb') +
                                   createRawIOCItems([...iocAnalysis.ipv4s, ...iocAnalysis.ipv6s], 'IPs', '#ea580c');
                
                contentContainer.innerHTML = allIOCItems || '<p style="text-align: center; color: #6b7280; padding: 2rem;">No IOCs detected</p>';
                
            } else {
                // Show UNIQUE IOCs - deduplicated values
                const uniqueIOCItems = createIOCItems(iocAnalysis.urls, 'URLs', '#7c3aed') +
                                     createIOCItems(iocAnalysis.domains, 'Domains', '#059669') +
                                     createIOCItems(iocAnalysis.api_calls, 'API Calls', '#dc2626') +
                                     createIOCItems(iocAnalysis.emails, 'Emails', '#2563eb') +
                                     createIOCItems([...iocAnalysis.ipv4s, ...iocAnalysis.ipv6s], 'IPs', '#ea580c');
                
                contentContainer.innerHTML = uniqueIOCItems || '<p style="text-align: center; color: #6b7280; padding: 2rem;">No IOCs detected</p>';
            }
        }

        function createRawIOCItems(iocList, type, color) {
            // Show raw instances without deduplication
            if (!iocList || iocList.length === 0) return '';
            
            return iocList.map(ioc => {
                const value = ioc.value || ioc;
                const filename = ioc.filename || 'Unknown';
                const shortFilename = filename.split('/').pop();
                
                // Apply same suspicious pattern detection
                let suspiciousLabel = '';
                if (type === 'URLs' || type === 'Domains') {
                    if (value.includes('telemetry') || value.includes('analytics') || value.includes('tracking')) {
                        suspiciousLabel = '<span style="background: #dc2626; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">TRACKING</span>';
                    } else if (!value.includes('https://') && value.includes('http://')) {
                        suspiciousLabel = '<span style="background: #ea580c; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">INSECURE</span>';
                    }
                } else if (type === 'IPs') {
                    if (value.includes('127.0.0.1') || value.includes('localhost')) {
                        suspiciousLabel = '<span style="background: #6b7280; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">LOCAL</span>';
                    } else if (value.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
                        suspiciousLabel = '<span style="background: #059669; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;" onclick="lookupIPLocation(\'' + value + '\', this)">üìç Locate</span>';
                    }
                }
                
                // Truncate long values
                let displayValue = value;
                if (value.length > 60) {
                    displayValue = value.substring(0, 57) + '...';
                }
                
                return `
                    <div class="ioc-item" style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1; margin-right: 1rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                                ${suspiciousLabel}
                            </div>
                            <div style="font-family: 'Monaco', 'Consolas', monospace; font-size: 0.85rem; color: #374151; word-break: break-all; line-height: 1.4; margin-bottom: 0.5rem;">
                                ${escapeHtml(displayValue)}
                            </div>
                            <div style="color: #6b7280; font-size: 0.75rem;">
                                <a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${escapeHtml(shortFilename)}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #9ca3af;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#9ca3af'">${escapeHtml(shortFilename)}</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createAllIOCInstances(iocAnalysis) {
            // Create individual instances for each file occurrence
            let allInstances = '';
            
            // Helper function to create individual IOC instances
            const createIOCInstance = (iocList, type, color) => {
                return iocList.map(ioc => {
                    const files = ioc.files || [ioc.filename];
                    return files.map(filename => {
                        const shortFilename = filename ? filename.split('/').pop() : 'Unknown';
                        
                        // Apply same suspicious pattern detection
                        let suspiciousLabel = '';
                        const value = ioc.value || ioc;
                        
                        if (type === 'URLs' || type === 'Domains') {
                            if (value.includes('telemetry') || value.includes('analytics') || value.includes('tracking')) {
                                suspiciousLabel = '<span style="background: #dc2626; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">TRACKING</span>';
                            } else if (!value.includes('https://') && value.includes('http://')) {
                                suspiciousLabel = '<span style="background: #ea580c; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">INSECURE</span>';
                            }
                        } else if (type === 'IPs') {
                            if (value.includes('127.0.0.1') || value.includes('localhost')) {
                                suspiciousLabel = '<span style="background: #6b7280; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">LOCAL</span>';
                            } else if (value.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
                                suspiciousLabel = '<span style="background: #059669; color: white; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;" onclick="lookupIPLocation(\'' + value + '\', this)">üìç Locate</span>';
                            }
                        }
                        
                        // Truncate long values
                        let displayValue = value;
                        if (value.length > 60) {
                            displayValue = value.substring(0, 57) + '...';
                        }
                        
                        return `
                            <div class="ioc-item" style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1; margin-right: 1rem;">
                                    <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                                        ${suspiciousLabel}
                                    </div>
                                    <div style="font-family: 'Monaco', 'Consolas', monospace; font-size: 0.85rem; color: #374151; word-break: break-all; line-height: 1.4; margin-bottom: 0.5rem;">
                                        ${displayValue}
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.75rem;">
                                        <a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${shortFilename}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #9ca3af;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#9ca3af'">${shortFilename}</a>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }).join('');
            };
            
            // Create all instances
            allInstances += createIOCInstance(iocAnalysis.urls, 'URLs', '#7c3aed');
            allInstances += createIOCInstance(iocAnalysis.domains, 'Domains', '#059669');
            allInstances += createIOCInstance(iocAnalysis.api_calls, 'API Calls', '#dc2626');
            allInstances += createIOCInstance(iocAnalysis.emails, 'Emails', '#2563eb');
            allInstances += createIOCInstance([...iocAnalysis.ipv4s, ...iocAnalysis.ipv6s], 'IPs', '#ea580c');
            
            return allInstances;
        }

        
        // IOC filtering functionality
        let currentIOCFilter = null;
        
        function filterIOCByType(type) {
            currentIOCFilter = currentIOCFilter === type ? null : type;
            
            // Use the global currentActiveTab variable instead of unreliable style detection
            const currentTab = currentActiveTab || 'all';
            
            // Get IOC analysis data from the current extension
            const iocAnalysis = currentIOCData || window.extensionAnalysisData?.ioc_analysis;
            if (!iocAnalysis) return;
            
            // Filter IOC data based on selected type
            let filteredIOC = {...iocAnalysis};
            if (currentIOCFilter) {
                // Reset all arrays to empty
                filteredIOC = {
                    urls: [],
                    domains: [],
                    api_calls: [],
                    emails: [],
                    ipv4s: [],
                    ipv6s: []
                };
                
                // Only populate the selected type
                switch (currentIOCFilter) {
                    case 'URLs':
                        filteredIOC.urls = iocAnalysis.urls || [];
                        break;
                    case 'Domains':
                        filteredIOC.domains = iocAnalysis.domains || [];
                        break;
                    case 'API Calls':
                        filteredIOC.api_calls = iocAnalysis.api_calls || [];
                        break;
                    case 'Emails':
                        filteredIOC.emails = iocAnalysis.emails || [];
                        break;
                    case 'IPs':
                        filteredIOC.ipv4s = iocAnalysis.ipv4s || [];
                        filteredIOC.ipv6s = iocAnalysis.ipv6s || [];
                        break;
                }
            }
            
            // Update only the content, not the badges
            updateIOCContentOnly(filteredIOC, currentTab);
            
            // Update badge appearance
            updateIOCBadgeAppearance(currentIOCFilter);
            
            // Debug: Check badge colors (remove in production)
            setTimeout(() => {
                debugBadgeColors();
            }, 100);
        }
        
        function updateIOCBadgeAppearance(activeFilter) {
            const badges = document.querySelectorAll('[class*="ioc-badge-"]');
            
            // Define color mapping for fallback
            const colorMap = {
                'URLs': '#7c3aed',
                'Domains': '#059669', 
                'Emails': '#2563eb',
                'IPs': '#ea580c',
                'API Calls': '#dc2626'
            };
            
            badges.forEach(badge => {
                const fullText = badge.textContent.trim();
                // Clean up the text by removing extra spaces and newlines, then extract type
                const cleanText = fullText.replace(/\s+/g, ' ').trim();
                const parts = cleanText.split(' ');
                // Skip the emoji and number (first 2 parts), get the rest as the type
                const badgeType = parts.slice(2).join(' ');
                let originalColor = badge.getAttribute('data-original-color');
                
                // Badge type extracted successfully
                
                // Fallback if data-original-color is missing
                if (!originalColor) {
                    originalColor = colorMap[badgeType] || '#6b7280';
                    badge.setAttribute('data-original-color', originalColor);
                }
                
                // Remove previous state classes
                badge.classList.remove('selected', 'dimmed');
                
                if (activeFilter === badgeType) {
                    // SELECTED - Strong solid color fill (no flashy animations)
                    badge.classList.add('selected');
                    badge.style.background = originalColor;
                    badge.style.color = '#ffffff';
                    badge.style.borderColor = originalColor;
                    badge.style.transform = 'translateY(-2px) scale(1.02)';
                    badge.style.boxShadow = `0 4px 12px ${originalColor}40`;
                    badge.style.fontWeight = '700';
                    badge.style.opacity = '1';
                    badge.style.zIndex = '10';
                    badge.style.animation = 'none';
                } else if (activeFilter) {
                    // DIMMED - Very light and barely visible
                    badge.classList.add('dimmed');
                    badge.style.background = '#f8f9fa';
                    badge.style.color = '#c0c4cc';
                    badge.style.borderColor = '#e5e7eb';
                    badge.style.transform = 'translateY(0) scale(0.92)';
                    badge.style.boxShadow = 'none';
                    badge.style.fontWeight = '400';
                    badge.style.opacity = '0.4';
                    badge.style.zIndex = '1';
                    badge.style.animation = 'none';
                } else {
                    // NORMAL - Original bright appearance
                    badge.style.background = 'transparent';
                    badge.style.color = originalColor;
                    badge.style.borderColor = originalColor;
                    badge.style.transform = 'translateY(0) scale(1)';
                    badge.style.boxShadow = `0 2px 8px ${originalColor}20`;
                    badge.style.fontWeight = '600';
                    badge.style.opacity = '1';
                    badge.style.zIndex = '5';
                    badge.style.animation = 'none';
                }
            });
        }

        // ======= IOC TABLE FUNCTIONS - PROFESSIONAL TABLE DISPLAY =======
        
        function createIOCTableRows(iocAnalysis, tabType) {
            const allIOCs = [];
            
            // Collect all IOCs with their type and metadata
            if (iocAnalysis.urls) {
                iocAnalysis.urls.forEach(ioc => {
                    allIOCs.push({
                        type: 'URL',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'URL'),
                        riskScore: getRiskScore(ioc.value, 'URL')
                    });
                });
            }
            
            if (iocAnalysis.domains) {
                iocAnalysis.domains.forEach(ioc => {
                    allIOCs.push({
                        type: 'Domain',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'Domain'),
                        riskScore: getRiskScore(ioc.value, 'Domain')
                    });
                });
            }
            
            if (iocAnalysis.api_calls) {
                iocAnalysis.api_calls.forEach(ioc => {
                    allIOCs.push({
                        type: 'API Call',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'API Call'),
                        riskScore: getRiskScore(ioc.value, 'API Call')
                    });
                });
            }
            
            if (iocAnalysis.emails) {
                iocAnalysis.emails.forEach(ioc => {
                    allIOCs.push({
                        type: 'Email',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'Email'),
                        riskScore: getRiskScore(ioc.value, 'Email')
                    });
                });
            }
            
            if (iocAnalysis.ipv4s) {
                iocAnalysis.ipv4s.forEach(ioc => {
                    allIOCs.push({
                        type: 'IPv4',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'IPv4'),
                        riskScore: getRiskScore(ioc.value, 'IPv4')
                    });
                });
            }
            
            if (iocAnalysis.ipv6s) {
                iocAnalysis.ipv6s.forEach(ioc => {
                    allIOCs.push({
                        type: 'IPv6',
                        value: ioc.value,
                        filename: ioc.filename,
                        risk: getRiskLevel(ioc.value, 'IPv6'),
                        riskScore: getRiskScore(ioc.value, 'IPv6')
                    });
                });
            }
            
            // Handle unique vs all display
            let displayIOCs = allIOCs;
            if (tabType === 'unique') {
                // Deduplicate by value, keeping the first occurrence
                const uniqueMap = new Map();
                allIOCs.forEach(ioc => {
                    const key = `${ioc.type}:${ioc.value}`;
                    if (!uniqueMap.has(key)) {
                        uniqueMap.set(key, ioc);
                    } else {
                        // Merge filenames for unique display
                        const existing = uniqueMap.get(key);
                        if (existing.filename !== ioc.filename) {
                            existing.filename = `${existing.filename}, ${ioc.filename}`;
                        }
                    }
                });
                displayIOCs = Array.from(uniqueMap.values());
            }
            
            // Sort by risk score (highest first), then by type
            displayIOCs.sort((a, b) => {
                if (a.riskScore !== b.riskScore) {
                    return b.riskScore - a.riskScore;
                }
                return a.type.localeCompare(b.type);
            });
            
            // Create table rows
            return displayIOCs.map(ioc => {
                const shortFilename = ioc.filename.length > 40 ? 
                    ioc.filename.substring(0, 37) + '...' : ioc.filename;
                
                const shortValue = ioc.value.length > 50 ? 
                    ioc.value.substring(0, 47) + '...' : ioc.value;
                
                const fileCount = tabType === 'unique' ? 
                    ioc.filename.split(', ').length : 1;
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.15s ease;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding: 0.75rem 1rem; border-right: 1px solid #e5e7eb; font-size: 0.8rem; color: #6b7280; max-width: 200px;" title="${escapeHtml(ioc.filename)}">
                            <a href="https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${escapeHtml(shortFilename)}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #9ca3af;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#9ca3af'">${escapeHtml(shortFilename)}</a>
                        </td>
                        <td style="padding: 0.75rem 1rem; border-right: 1px solid #e5e7eb; font-family: 'Monaco', 'Consolas', monospace; font-size: 0.8rem; word-break: break-all; max-width: 300px;" title="${escapeHtml(ioc.value)}">
                            ${escapeHtml(shortValue)}
                        </td>
                        <td style="padding: 0.75rem 1rem; border-right: 1px solid #e5e7eb; font-weight: 600; color: ${getTypeColor(ioc.type)};">
                            ${getTypeIcon(ioc.type)} ${ioc.type}
                        </td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">
                            ${getRiskBadge(ioc.risk)}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getRiskLevel(value, type) {
            // Comprehensive risk assessment based on IOC type and value
            const lowercaseValue = value.toLowerCase();
            
            if (type === 'URL') {
                if (value.startsWith('http://')) return 'HIGH';
                if (lowercaseValue.includes('telemetry') || lowercaseValue.includes('analytics') || 
                    lowercaseValue.includes('tracking') || lowercaseValue.includes('ads')) return 'MEDIUM';
                if (lowercaseValue.includes('localhost') || lowercaseValue.includes('127.0.0.1')) return 'LOW';
                return 'LOW';
            }
            
            if (type === 'Domain') {
                if (lowercaseValue.includes('analytics') || lowercaseValue.includes('tracking') || 
                    lowercaseValue.includes('ads') || lowercaseValue.includes('telemetry')) return 'MEDIUM';
                if (lowercaseValue.includes('malware') || lowercaseValue.includes('phishing')) return 'HIGH';
                return 'LOW';
            }
            
            if (type === 'API Call') {
                if (lowercaseValue.includes('eval') || lowercaseValue.includes('exec') || 
                    lowercaseValue.includes('settimeout') || lowercaseValue.includes('setinterval')) return 'MEDIUM';
                if (lowercaseValue.includes('document.write') || lowercaseValue.includes('innerhtml')) return 'MEDIUM';
                return 'LOW';
            }
            
            if (type === 'Email') {
                if (lowercaseValue.includes('temp') || lowercaseValue.includes('disposable') || 
                    lowercaseValue.includes('10minute')) return 'MEDIUM';
                return 'LOW';
            }
            
            if (type === 'IPv4' || type === 'IPv6') {
                if (lowercaseValue.includes('127.0.0.1') || lowercaseValue.includes('localhost')) return 'LOW';
                if (lowercaseValue.includes('192.168.') || lowercaseValue.includes('10.0.') || 
                    lowercaseValue.includes('172.16.')) return 'LOW';
                return 'MEDIUM';
            }
            
            return 'LOW';
        }
        
        function getRiskScore(value, type) {
            // Numerical risk score for sorting (higher = more risky)
            const risk = getRiskLevel(value, type);
            switch (risk) {
                case 'HIGH': return 3;
                case 'MEDIUM': return 2;
                case 'LOW': return 1;
                default: return 0;
            }
        }
        
        function getRiskBadge(risk) {
            const styles = {
                'HIGH': { bg: '#dc2626', text: '#ffffff' },
                'MEDIUM': { bg: '#ea580c', text: '#ffffff' },
                'LOW': { bg: '#059669', text: '#ffffff' }
            };
            
            const style = styles[risk] || styles['LOW'];
            return `
                <span style="background: ${style.bg}; color: ${style.text}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                    ${risk}
                </span>
            `;
        }
        
        function getTypeColor(type) {
            const colors = {
                'URL': '#7c3aed',
                'Domain': '#059669',
                'API Call': '#dc2626',
                'Email': '#2563eb',
                'IPv4': '#ea580c',
                'IPv6': '#ea580c'
            };
            return colors[type] || '#6b7280';
        }
        
        function getTypeIcon(type) {
            const icons = {
                'URL': 'üîó',
                'Domain': 'üåê',
                'API Call': 'üì°',
                'Email': 'üìß',
                'IPv4': 'üî¢',
                'IPv6': 'üî¢'
            };
            return icons[type] || 'üìã';
        }
        
        // HTML escape function for security
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // IOC Table sorting functionality
        let currentIOCSortColumn = 'risk';
        let currentIOCSortDirection = 'desc';
        
        function sortIOCTable(column) {
            const table = document.getElementById('ioc-table');
            const tbody = document.getElementById('ioc-table-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sort direction if same column
            if (currentIOCSortColumn === column) {
                currentIOCSortDirection = currentIOCSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentIOCSortDirection = 'desc';
                currentIOCSortColumn = column;
            }
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch (column) {
                    case 'files':
                        aValue = a.cells[0].textContent.trim();
                        bValue = b.cells[0].textContent.trim();
                        break;
                    case 'value':
                        aValue = a.cells[1].textContent.trim();
                        bValue = b.cells[1].textContent.trim();
                        break;
                    case 'type':
                        aValue = a.cells[2].textContent.trim();
                        bValue = b.cells[2].textContent.trim();
                        break;
                    case 'risk':
                        aValue = a.cells[3].textContent.trim();
                        bValue = b.cells[3].textContent.trim();
                        // Convert risk to sortable number
                        const riskOrder = { 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                        aValue = riskOrder[aValue] || 0;
                        bValue = riskOrder[bValue] || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return currentIOCSortDirection === 'asc' ? 
                        aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    return currentIOCSortDirection === 'asc' ? 
                        aValue - bValue : bValue - aValue;
                }
            });
            
            // Update table
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Update sort indicators
            updateSortIndicators(column);
        }
        
        function updateSortIndicators(activeColumn) {
            const headers = document.querySelectorAll('th[onclick^="sortIOCTable"]');
            headers.forEach(header => {
                const column = header.getAttribute('onclick').match(/'([^']+)'/)[1];
                const indicator = header.querySelector('span');
                
                if (column === activeColumn) {
                    indicator.textContent = currentIOCSortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                    indicator.style.color = '#342e7c';
                } else {
                    indicator.textContent = '‚ñº';
                    indicator.style.color = '#9ca3af';
                }
            });
        }
        
        // IOC Table Search Functionality
        function searchIOCTable() {
            const searchInput = document.getElementById('ioc-search');
            const tbody = document.getElementById('ioc-table-body');
            
            if (!searchInput || !tbody) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                if (searchTerm === '') {
                    // Show all rows if search is empty
                    row.style.display = '';
                } else {
                    // Get all text content from the row
                    const rowText = row.textContent.toLowerCase();
                    
                    // Show/hide based on search match
                    if (rowText.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Update visible row count
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            
            // Add search results indicator
            const searchResults = document.getElementById('ioc-search-results');
            if (searchResults) {
                searchResults.remove();
            }
            
            if (searchTerm !== '' && visibleRows.length > 0) {
                const resultsDiv = document.createElement('div');
                resultsDiv.id = 'ioc-search-results';
                resultsDiv.style.cssText = 'margin-bottom: 0.5rem; padding: 0.5rem; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 4px; font-size: 0.8rem; color: #0369a1;';
                resultsDiv.textContent = `Found ${visibleRows.length} IOC${visibleRows.length !== 1 ? 's' : ''} matching "${searchTerm}"`;
                
                searchInput.parentNode.appendChild(resultsDiv);
            } else if (searchTerm !== '' && visibleRows.length === 0) {
                const resultsDiv = document.createElement('div');
                resultsDiv.id = 'ioc-search-results';
                resultsDiv.style.cssText = 'margin-bottom: 0.5rem; padding: 0.5rem; background: #fef2f2; border: 1px solid #ef4444; border-radius: 4px; font-size: 0.8rem; color: #dc2626;';
                resultsDiv.textContent = `No IOCs found matching "${searchTerm}"`;
                
                searchInput.parentNode.appendChild(resultsDiv);
            }
        }

let currentSimulationData = null;
let currentSimulationType = 'no';

function updateDynamicAnalysisTab(dynamicAnalysis) {
    if (!dynamicAnalysis) {
        document.getElementById('dynamicMetrics').innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No dynamic analysis data available</p>';
        return;
    }
    
    // Store simulation data globally
    currentSimulationData = dynamicAnalysis;
    
    // Calculate metrics across all simulations
    const noSimApiLogs = dynamicAnalysis.no_activity_da_api_logs || [];
    const noSimNetworkLogs = dynamicAnalysis.no_activity_da_network_logs || [];
    
    const staticApiLogs = dynamicAnalysis.static_script_da_api_logs || [];
    const staticNetworkLogs = dynamicAnalysis.static_script_da_network_logs || [];
    const staticPlaywrightLogs = dynamicAnalysis.static_script_da_playwright_logs || [];
    
    const adaptiveApiLogs = dynamicAnalysis.dynamic_script_da_api_logs || [];
    const adaptiveNetworkLogs = dynamicAnalysis.dynamic_script_da_network_logs || [];
    const adaptivePlaywrightLogs = dynamicAnalysis.dynamic_script_da_playwright_logs || [];
    
    const totalApiCalls = noSimApiLogs.length + staticApiLogs.length + adaptiveApiLogs.length;
    const totalNetworkRequests = noSimNetworkLogs.length + staticNetworkLogs.length + adaptiveNetworkLogs.length;
    const totalAutomationSteps = staticPlaywrightLogs.length + adaptivePlaywrightLogs.length;
    const totalEvents = totalApiCalls + totalNetworkRequests + totalAutomationSteps;
    
    // Get unique API names and websites
    const apiNames = new Set();
    const websitesVisited = new Set();
    
    [...noSimApiLogs, ...staticApiLogs, ...adaptiveApiLogs].forEach(log => {
        if (log.api_name) apiNames.add(log.api_name);
    });
    
    [...staticPlaywrightLogs, ...adaptivePlaywrightLogs].forEach(log => {
        if (log.details) {
            const urlMatches = log.details.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9-]+\.[a-zA-Z]{2,})/g);
            if (urlMatches) {
                urlMatches.forEach(match => {
                    const domain = match.replace(/^https?:\/\//, '').replace(/^www\./, '').split('/')[0];
                    if (domain) websitesVisited.add(domain);
                });
            }
            const siteNames = ['GitHub', 'Google', 'Facebook', 'PayPal', 'Amazon', 'Stack Overflow', 'Blockchain', 'Box'];
            siteNames.forEach(site => {
                if (log.details.includes(site)) websitesVisited.add(site);
            });
        }
    });
    
    // Remove metric cards - just clear the dynamicMetrics div
    document.getElementById('dynamicMetrics').innerHTML = '';
    
    // Load default simulation tab (No Simulation)
    // First reset ALL tabs to ensure clean state
    const allTabs = document.querySelectorAll('[id^="sim-tab-"]');
    allTabs.forEach(tab => {
        tab.style.color = '#64748b';
        tab.style.borderBottom = '3px solid transparent';
        tab.style.background = 'transparent';
    });
    
    switchSimulationTab('no');
}

function switchSimulationTab(simulationType) {
    if (!currentSimulationData) return;
    
    currentSimulationType = simulationType;
    
    // Update tab styles - use more explicit selector
    const noTab = document.getElementById('sim-tab-no');
    const staticTab = document.getElementById('sim-tab-static');
    const adaptiveTab = document.getElementById('sim-tab-adaptive');
    
    // Reset ALL tabs explicitly
    if (noTab) {
        noTab.style.color = '#64748b';
        noTab.style.borderBottom = '3px solid transparent';
        noTab.style.background = 'transparent';
    }
    if (staticTab) {
        staticTab.style.color = '#64748b';
        staticTab.style.borderBottom = '3px solid transparent';
        staticTab.style.background = 'transparent';
    }
    if (adaptiveTab) {
        adaptiveTab.style.color = '#64748b';
        adaptiveTab.style.borderBottom = '3px solid transparent';
        adaptiveTab.style.background = 'transparent';
    }
    
    // Activate selected tab
    let activeTab;
    switch(simulationType) {
        case 'no':
            activeTab = noTab;
            break;
        case 'static':
            activeTab = staticTab;
            break;
        case 'adaptive':
            activeTab = adaptiveTab;
            break;
    }
    
    if (activeTab) {
        activeTab.style.color = '#1e293b';
        activeTab.style.borderBottom = '3px solid #342e7c';
        activeTab.style.background = 'white';
    }
    
    // Render simulation content
    renderSimulationContent(simulationType);
}

function renderSimulationContent(simulationType) {
    if (!currentSimulationData) return;
    
    let apiLogs = [];
    let networkLogs = [];
    let playwrightLogs = [];
    let uniqueApis = 0;
    let uniqueHosts = 0;
    let uniqueActions = 0;
    let title = '';
    let description = '';
    
    switch(simulationType) {
        case 'no':
            apiLogs = currentSimulationData.no_activity_da_api_logs || [];
            networkLogs = currentSimulationData.no_activity_da_network_logs || [];
            playwrightLogs = [];
            uniqueApis = currentSimulationData.no_activity_unique_apis || 0;
            uniqueHosts = currentSimulationData.no_activity_unique_hosts || 0;
            uniqueActions = 0;
            title = '';
            description = '';
            break;
        case 'static':
            apiLogs = currentSimulationData.static_script_da_api_logs || [];
            networkLogs = currentSimulationData.static_script_da_network_logs || [];
            playwrightLogs = currentSimulationData.static_script_da_playwright_logs || [];
            uniqueApis = currentSimulationData.static_script_unique_apis || 0;
            uniqueHosts = currentSimulationData.static_script_unique_hosts || 0;
            uniqueActions = currentSimulationData.static_script_unique_actions || 0;
            title = '';
            description = '';
            break;
        case 'adaptive':
            apiLogs = currentSimulationData.dynamic_script_da_api_logs || [];
            networkLogs = currentSimulationData.dynamic_script_da_network_logs || [];
            playwrightLogs = currentSimulationData.dynamic_script_da_playwright_logs || [];
            uniqueApis = currentSimulationData.dynamic_script_unique_apis || 0;
            uniqueHosts = currentSimulationData.dynamic_script_unique_hosts || 0;
            uniqueActions = currentSimulationData.dynamic_script_unique_actions || 0;
            title = '';
            description = '';
            break;
    }
    
    // Calculate baseline timestamp for timing calculations
    let baselineTimestamp = null;
    const allTimestamps = [];
    
    [...apiLogs, ...networkLogs, ...playwrightLogs].forEach(log => {
        if (log.timestamp) allTimestamps.push(new Date(log.timestamp).getTime());
    });
    
    if (allTimestamps.length > 0) {
        baselineTimestamp = Math.min(...allTimestamps);
    }
    
    function calculateTimestamp(timestamp) {
        if (!timestamp || !baselineTimestamp) return '-';
        const currentTime = new Date(timestamp).getTime();
        const diffMs = currentTime - baselineTimestamp;
        const minutes = Math.floor(diffMs / 60000);
        const seconds = Math.floor((diffMs % 60000) / 1000);
        const milliseconds = diffMs % 1000;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
    }
    
    // Get verdict for this simulation type
    let verdict = null;
    let verdictColor = '#6b7280'; // Default gray
    let verdictBg = '#f3f4f6'; // Default light gray
    
    if (simulationType === 'static' && currentSimulationData.static_verdict) {
        verdict = currentSimulationData.static_verdict;
    } else if (simulationType === 'adaptive' && currentSimulationData.dynamic_verdict) {
        verdict = currentSimulationData.dynamic_verdict;
    }
    
    // Set colors based on verdict
    if (verdict) {
        if (verdict.verdict === 'benign') {
            verdictColor = '#059669'; // Green text
            verdictBg = '#d1fae5'; // Light green background
        } else if (verdict.verdict === 'malicious') {
            verdictColor = '#dc2626'; // Red text
            verdictBg = '#fee2e2'; // Light red background
        }
    }

    const contentHtml = `
        <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <div style="display: flex; gap: 2rem; align-items: center;">
                <span id="api-summary-${simulationType}" style="color: #059669; font-weight: 600; font-size: 0.9rem;">üîå ${apiLogs.length} API Calls${uniqueApis > 0 ? ` (${uniqueApis} Unique)` : ''}</span>
                <span id="network-summary-${simulationType}" style="color: #059669; font-weight: 600; font-size: 0.9rem;">üåê ${networkLogs.length} Network Requests${uniqueHosts > 0 ? ` (${uniqueHosts} Unique Hosts)` : ''}</span>
                ${playwrightLogs.length > 0 ? `<span id="playwright-summary-${simulationType}" style="color: #059669; font-weight: 600; font-size: 0.9rem;">ü§ñ ${playwrightLogs.length} Automation Steps${uniqueActions > 0 ? ` (${uniqueActions} Unique Actions)` : ''}</span>` : ''}
                ${verdict ? `<span onclick="showVerdictModal(event, '${simulationType}', '${verdict.verdict}')" data-reasoning="${verdict.reasoning.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, '\\n')}" style="color: ${verdictColor}; background: ${verdictBg}; font-weight: 600; font-size: 0.9rem; padding: 4px 12px; border-radius: 16px; cursor: pointer; transition: all 0.2s ease; user-select: none;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">üîç Verdict: ${verdict.verdict.toUpperCase()}</span>` : ''}
            </div>
        </div>
        
        <!-- API Calls Section -->
        ${renderApiSection(apiLogs, calculateTimestamp, simulationType)}
        
        <!-- Network Logs Section -->
        ${renderNetworkSection(networkLogs, calculateTimestamp, simulationType, uniqueHosts)}
        
        <!-- Playwright Logs Section (only for static and adaptive) -->
        ${simulationType !== 'no' ? renderPlaywrightSection(playwrightLogs, calculateTimestamp, simulationType) : ''}
        
    `;
    
    document.getElementById('simulationContent').innerHTML = contentHtml;
}

function renderApiSection(apiLogs, calculateTimestamp, simulationType) {
    if (apiLogs.length === 0) {
        return `
            <div style="padding: 2rem; border-bottom: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">üîå Chrome Extension API Calls</h4>
                <p style="text-align: center; color: #6b7280; padding: 2rem; font-size: 1rem;">No API calls recorded</p>
            </div>
        `;
    }
    
    // Create unique API calls by deduplicating based on api_name + arguments (for Unique Calls with Arguments tab)
    const uniqueApiLogs = [];
    const seenApiCalls = new Set();
    
    apiLogs.forEach(log => {
        const key = `${log.api_name}:${log.arguments}`;
        if (!seenApiCalls.has(key)) {
            seenApiCalls.add(key);
            uniqueApiLogs.push(log);
        }
    });
    
    // Create unique API calls by deduplicating based on api_name only (for Unique Calls tab)
    const uniqueApiNameLogs = [];
    const seenApiNames = new Set();
    
    apiLogs.forEach(log => {
        if (!seenApiNames.has(log.api_name)) {
            seenApiNames.add(log.api_name);
            uniqueApiNameLogs.push(log);
        }
    });
    
    const sectionId = `api-section-${simulationType}`;
    const allTableId = `api-table-all-${simulationType}`;
    const uniqueTableId = `api-table-unique-${simulationType}`;
    const uniqueApiNamesTableId = `api-table-unique-names-${simulationType}`;
    
    return `
        <div style="padding: 0; border-bottom: 1px solid #e2e8f0;">
            <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h4 style="margin: 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">üîå Chrome Extension API Calls</h4>
                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">${apiLogs.length} calls recorded during ${simulationType} simulation</p>
            </div>
            
            <!-- Three-Tab Navigation -->
            <div style="background: #f1f5f9; border-bottom: 1px solid #e2e8f0; padding: 0; margin: 0;">
                <div style="display: flex; gap: 0;">
                    <div id="api-tab-all-${simulationType}" class="api-view-tab" onclick="switchApiView('all', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid #342e7c;">
                        All (${apiLogs.length})
                    </div>
                    <div id="api-tab-unique-${simulationType}" class="api-view-tab" onclick="switchApiView('unique', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid transparent;">
                        Unique Calls with Arguments (${uniqueApiLogs.length})
                    </div>
                    <div id="api-tab-unique-names-${simulationType}" class="api-view-tab" onclick="switchApiView('unique-names', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid transparent;">
                        Unique Calls (${uniqueApiNameLogs.length})
                    </div>
                </div>
            </div>
            
            <!-- All API Calls Table -->
            <div id="${allTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                ${generateApiTable(apiLogs, simulationType, 'all')}
            </div>
            
            <!-- Unique API Calls with Arguments Table -->
            <div id="${uniqueTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto; display: none;">
                ${generateApiTable(uniqueApiLogs, simulationType, 'unique')}
            </div>
            
            <!-- Unique API Names Table -->
            <div id="${uniqueApiNamesTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto; display: none;">
                ${generateApiTable(uniqueApiNameLogs, simulationType, 'unique-names')}
            </div>
        </div>
    `;
}

function generateApiTable(logs, simulationType, viewType) {
    // Sort logs chronologically (earliest first)
    const sortedApiLogs = [...logs].sort((a, b) => {
        if (!a.timestamp || !b.timestamp) return 0;
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    
    return `
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
            <thead style="position: sticky; top: 0; z-index: 10;">
                <tr style="background: rgb(52, 46, 124); color: white;">
                    ${viewType === 'all' ? '<th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">CALL TYPE</th>' : ''}
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">API NAME</th>
                    ${viewType !== 'unique-names' ? '<th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">ARGUMENTS</th>' : ''}
                    ${viewType === 'all' ? '<th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">FUNCTION BODY</th>' : ''}
                </tr>
            </thead>
            <tbody>
                ${sortedApiLogs.map((log, index) => {
                            const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('en-US', { 
                                hour12: false, 
                                hour: '2-digit', 
                                minute: '2-digit', 
                                second: '2-digit',
                                fractionalSecondDigits: 3
                            }) : 'N/A';
                            
                            // Handle long arguments with expandable functionality
                            const args = log.arguments || '-';
                            const maxLength = 100;
                            let argumentsDisplay = args;
                            
                            if (args && args !== '-' && args.length > maxLength) {
                                const argId = `api-arg-${simulationType}-${index}`;
                                const truncated = args.substring(0, maxLength);
                                const remaining = args.substring(maxLength);
                                
                                argumentsDisplay = `
                                    <div>
                                        <span id="${argId}-truncated">${escapeHtml(truncated)}</span>
                                        <span id="${argId}-toggle" 
                                              style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                              onclick="toggleContent('${argId}')" 
                                              onmouseover="this.style.color='#2a2563'" 
                                              onmouseout="this.style.color='#342e7c'">
                                            ...show more
                                        </span>
                                        <span id="${argId}-hidden" style="display: none;">${escapeHtml(remaining)}</span>
                                        <div id="${argId}-collapse" style="display: none; margin-top: 0.5rem;">
                                            <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                                  onclick="toggleContent('${argId}')" 
                                                  onmouseover="this.style.color='#b91c1c'" 
                                                  onmouseout="this.style.color='#dc2626'">
                                                ‚Üë Show less
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Handle function_body with expandable functionality
                            const funcBody = log.function_body || '-';
                            const funcMaxLength = 150;
                            let functionDisplay = funcBody;
                            
                            if (funcBody && funcBody !== '-' && funcBody.length > funcMaxLength) {
                                const funcId = `api-func-${simulationType}-${index}`;
                                const funcTruncated = funcBody.substring(0, funcMaxLength);
                                const funcRemaining = funcBody.substring(funcMaxLength);
                                
                                functionDisplay = `
                                    <div>
                                        <span id="${funcId}-truncated">${escapeHtml(funcTruncated)}</span>
                                        <span id="${funcId}-toggle" 
                                              style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                              onclick="toggleContent('${funcId}')" 
                                              onmouseover="this.style.color='#2a2563'" 
                                              onmouseout="this.style.color='#342e7c'">
                                            ...show more
                                        </span>
                                        <span id="${funcId}-hidden" style="display: none;">${escapeHtml(funcRemaining)}</span>
                                        <div id="${funcId}-collapse" style="display: none; margin-top: 0.5rem;">
                                            <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                                  onclick="toggleContent('${funcId}')" 
                                                  onmouseover="this.style.color='#b91c1c'" 
                                                  onmouseout="this.style.color='#dc2626'">
                                                ‚Üë Show less
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};" 
                                    onmouseover="this.style.background='#f1f5f9'" 
                                    onmouseout="this.style.background='${index % 2 === 0 ? '#f8f9fa' : 'white'}'">
                                    ${viewType === 'all' ? `<td style="padding: 12px 16px;"><span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${log.call_type || 'API CALL'}</span></td>` : ''}
                                    <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${log.api_name || '-'}</td>
                                    ${viewType !== 'unique-names' ? `<td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem; max-width: 250px; word-break: break-word;">${args.length <= maxLength ? escapeHtml(argumentsDisplay) : argumentsDisplay}</td>` : ''}
                                    ${viewType === 'all' ? `<td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem; max-width: 200px; word-break: break-word;">${funcBody.length <= funcMaxLength ? escapeHtml(functionDisplay) : functionDisplay}</td>` : ''}
                                </tr>
                            `;
                        }).join('')}
            </tbody>
        </table>
    `;
}

// Function to switch between All, Unique Calls with Arguments, and Unique Calls views for API calls
function switchApiView(viewType, simulationType) {
    const allTab = document.getElementById(`api-tab-all-${simulationType}`);
    const uniqueTab = document.getElementById(`api-tab-unique-${simulationType}`);
    const uniqueNamesTab = document.getElementById(`api-tab-unique-names-${simulationType}`);
    const allTable = document.getElementById(`api-table-all-${simulationType}`);
    const uniqueTable = document.getElementById(`api-table-unique-${simulationType}`);
    const uniqueNamesTable = document.getElementById(`api-table-unique-names-${simulationType}`);
    
    // Reset all tabs
    allTab.style.borderBottom = '3px solid transparent';
    uniqueTab.style.borderBottom = '3px solid transparent';
    uniqueNamesTab.style.borderBottom = '3px solid transparent';
    allTable.style.display = 'none';
    uniqueTable.style.display = 'none';
    uniqueNamesTable.style.display = 'none';
    
    // Show selected tab
    if (viewType === 'all') {
        allTab.style.borderBottom = '3px solid #342e7c';
        allTable.style.display = 'block';
    } else if (viewType === 'unique') {
        uniqueTab.style.borderBottom = '3px solid #342e7c';
        uniqueTable.style.display = 'block';
    } else if (viewType === 'unique-names') {
        uniqueNamesTab.style.borderBottom = '3px solid #342e7c';
        uniqueNamesTable.style.display = 'block';
    }
    
    // Update dynamic summary counts
    updateDynamicSummary(simulationType);
}

function renderNetworkSection(networkLogs, calculateTimestamp, simulationType, uniqueHosts = 0) {
    if (networkLogs.length === 0) {
        return `
            <div style="padding: 2rem; border-bottom: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">üåê Network Traffic Analysis</h4>
                <p style="text-align: center; color: #6b7280; padding: 2rem; font-size: 1rem;">No network requests recorded</p>
            </div>
        `;
    }
    
    // Note: Unique view shows domain summary, not individual request deduplication
    
    const allTableId = `network-table-all-${simulationType}`;
    const uniqueTableId = `network-table-unique-${simulationType}`;
    
    return `
        <div style="padding: 0; border-bottom: 1px solid #e2e8f0;">
            <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h4 style="margin: 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">üåê Network Traffic Analysis</h4>
                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">${networkLogs.length} requests recorded during ${simulationType} simulation</p>
            </div>
            
            <!-- All/Unique Tab Navigation -->
            <div style="background: #f1f5f9; border-bottom: 1px solid #e2e8f0; padding: 0; margin: 0;">
                <div style="display: flex; gap: 0;">
                    <div id="network-tab-all-${simulationType}" class="network-view-tab" onclick="switchNetworkView('all', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid #342e7c;">
                        All (${networkLogs.length})
                    </div>
                    <div id="network-tab-unique-${simulationType}" class="network-view-tab" onclick="switchNetworkView('unique', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid transparent;">
                        Unique (${uniqueHosts})
                    </div>
                </div>
            </div>
            
            <!-- All Network Requests Table -->
            <div id="${allTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                ${generateNetworkTable(networkLogs, simulationType, 'all')}
            </div>
            
            <!-- Unique Network Requests Table -->
            <div id="${uniqueTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto; display: none;">
                ${generateNetworkTable(networkLogs, simulationType, 'unique')}
            </div>
        </div>
    `;
}

function generateNetworkTable(logs, simulationType, viewType) {
    if (viewType === 'unique') {
        // Create domain-only view for unique tab
        const domainSummary = {};
        
        logs.forEach(log => {
            const domain = log.host || 'Unknown Domain';
            if (!domainSummary[domain]) {
                domainSummary[domain] = {
                    domain: domain,
                    requestCount: 0,
                    methods: new Set(),
                    paths: new Set(),
                    schemes: new Set(),
                    firstTimestamp: log.timestamp
                };
            }
            domainSummary[domain].requestCount++;
            if (log.method) domainSummary[domain].methods.add(log.method);
            if (log.path) domainSummary[domain].paths.add(log.path);
            if (log.scheme) domainSummary[domain].schemes.add(log.scheme);
        });
        
        const domainEntries = Object.values(domainSummary);
        
        return `
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr style="background: rgb(52, 46, 124); color: white;">
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">DOMAIN</th>
                        <th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 0.85rem;">REQUEST COUNT</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">METHODS USED</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">PATHS ACCESSED</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">SCHEMES</th>
                    </tr>
                </thead>
                <tbody>
                    ${domainEntries.map((domain, index) => {
                        const methods = Array.from(domain.methods).join(', ');
                        const paths = Array.from(domain.paths).slice(0, 3).join(', ') + 
                                     (domain.paths.size > 3 ? ` (+${domain.paths.size - 3} more)` : '');
                        const schemes = Array.from(domain.schemes).join(', ');
                        
                        return `
                            <tr style="border-bottom: 1px solid #e2e8f0; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};" 
                                onmouseover="this.style.background='#f1f5f9'" 
                                onmouseout="this.style.background='${index % 2 === 0 ? '#f8f9fa' : 'white'}'">
                                <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${domain.domain}</td>
                                <td style="padding: 12px 16px; color: #64748b; text-align: center;">
                                    <span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">
                                        ${domain.requestCount} request${domain.requestCount !== 1 ? 's' : ''}
                                    </span>
                                </td>
                                <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem;">${methods}</td>
                                <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem; max-width: 300px; word-break: break-word;">${paths}</td>
                                <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem;">${schemes}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Default view for "All" tab - full detailed table
    // Sort logs chronologically (earliest first)
    const sortedNetworkLogs = [...logs].sort((a, b) => {
        if (!a.timestamp || !b.timestamp) return 0;
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    
    return `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr style="background: rgb(52, 46, 124); color: white;">
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">TIMESTAMP</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">EXTENSION</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">HOST</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">PATH</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">METHOD</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">SCHEME</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">AUTHORITY</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">HTTP VERSION</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">HEADERS</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">CONTENT</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedNetworkLogs.map((log, index) => {
                            const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('en-US', { 
                                hour12: false, 
                                hour: '2-digit', 
                                minute: '2-digit', 
                                second: '2-digit',
                                fractionalSecondDigits: 3
                            }) : 'N/A';
                            
                            // Handle long headers with expandable functionality
                            const headers = log.headers || '-';
                            const maxLength = 100;
                            let headersDisplay = headers;
                            
                            if (headers && headers !== '-' && headers.length > maxLength) {
                                const headerId = `net-headers-${simulationType}-${index}`;
                                const truncated = headers.substring(0, maxLength);
                                const remaining = headers.substring(maxLength);
                                
                                headersDisplay = `
                                    <div>
                                        <span id="${headerId}-truncated">${truncated}</span>
                                        <span id="${headerId}-toggle" 
                                              style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                              onclick="toggleContent('${headerId}')" 
                                              onmouseover="this.style.color='#2a2563'" 
                                              onmouseout="this.style.color='#342e7c'">
                                            ...show more
                                        </span>
                                        <span id="${headerId}-hidden" style="display: none;">${remaining}</span>
                                        <div id="${headerId}-collapse" style="display: none; margin-top: 0.5rem;">
                                            <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                                  onclick="toggleContent('${headerId}')" 
                                                  onmouseover="this.style.color='#b91c1c'" 
                                                  onmouseout="this.style.color='#dc2626'">
                                                ‚Üë Show less
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Handle long content with expandable functionality
                            const content = log.content || '-';
                            let contentDisplay = content;
                            
                            if (content && content !== '-' && content.length > maxLength) {
                                const contentId = `net-content-${simulationType}-${index}`;
                                const truncated = content.substring(0, maxLength);
                                const remaining = content.substring(maxLength);
                                
                                contentDisplay = `
                                    <div>
                                        <span id="${contentId}-truncated">${truncated}</span>
                                        <span id="${contentId}-toggle" 
                                              style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                              onclick="toggleContent('${contentId}')" 
                                              onmouseover="this.style.color='#2a2563'" 
                                              onmouseout="this.style.color='#342e7c'">
                                            ...show more
                                        </span>
                                        <span id="${contentId}-hidden" style="display: none;">${remaining}</span>
                                        <div id="${contentId}-collapse" style="display: none; margin-top: 0.5rem;">
                                            <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                                  onclick="toggleContent('${contentId}')" 
                                                  onmouseover="this.style.color='#b91c1c'" 
                                                  onmouseout="this.style.color='#dc2626'">
                                                ‚Üë Show less
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};" 
                                    onmouseover="this.style.background='#f1f5f9'" 
                                    onmouseout="this.style.background='${index % 2 === 0 ? '#f8f9fa' : 'white'}'">
                                    <td style="padding: 12px 16px; color: #6b7280; font-family: 'Consolas', monospace; font-size: 0.8rem;">${timestamp}</td>
                                    <td style="padding: 12px 16px; color: #1e293b; font-weight: 500; max-width: 120px; word-break: break-word;">${log.extension || '-'}</td>
                                    <td style="padding: 12px 16px; font-weight: 600; color: #1e293b;">${log.host || '-'}</td>
                                    <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.8rem; max-width: 200px; word-break: break-word;">${log.path || '-'}</td>
                                    <td style="padding: 12px 16px;"><span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${log.method || '-'}</span></td>
                                    <td style="padding: 12px 16px; color: #64748b; font-weight: 500;">${log.scheme || '-'}</td>
                                    <td style="padding: 12px 16px; color: #64748b; font-weight: 500;">${log.authority || '-'}</td>
                                    <td style="padding: 12px 16px; color: #64748b; font-weight: 500;">${log.http_version || '-'}</td>
                                    <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.75rem; max-width: 150px; word-break: break-word;">${headersDisplay}</td>
                                    <td style="padding: 12px 16px; color: #64748b; font-family: 'Consolas', monospace; font-size: 0.75rem; max-width: 150px; word-break: break-word;">${contentDisplay}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
    `;
}

// Function to switch between All and Unique views for Network requests
function switchNetworkView(viewType, simulationType) {
    const allTab = document.getElementById(`network-tab-all-${simulationType}`);
    const uniqueTab = document.getElementById(`network-tab-unique-${simulationType}`);
    const allTable = document.getElementById(`network-table-all-${simulationType}`);
    const uniqueTable = document.getElementById(`network-table-unique-${simulationType}`);
    
    if (viewType === 'all') {
        allTab.style.borderBottom = '3px solid #342e7c';
        uniqueTab.style.borderBottom = '3px solid transparent';
        allTable.style.display = 'block';
        uniqueTable.style.display = 'none';
    } else {
        allTab.style.borderBottom = '3px solid transparent';
        uniqueTab.style.borderBottom = '3px solid #342e7c';
        allTable.style.display = 'none';
        uniqueTable.style.display = 'block';
    }
    
    // Update dynamic summary counts
    updateDynamicSummary(simulationType);
}

function renderPlaywrightSection(playwrightLogs, calculateTimestamp, simulationType) {
    if (playwrightLogs.length === 0) {
        return `
            <div style="padding: 2rem;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">ü§ñ Browser Automation Analysis</h4>
                <p style="text-align: center; color: #6b7280; padding: 2rem; font-size: 1rem;">No automation steps recorded</p>
            </div>
        `;
    }
    
    // Create unique playwright actions by deduplicating based on action only (to match database logic)
    const uniquePlaywrightLogs = [];
    const seenPlaywrightActions = new Set();
    
    playwrightLogs.forEach(log => {
        const key = log.action;
        if (!seenPlaywrightActions.has(key)) {
            seenPlaywrightActions.add(key);
            uniquePlaywrightLogs.push(log);
        }
    });
    
    const allTableId = `playwright-table-all-${simulationType}`;
    const uniqueTableId = `playwright-table-unique-${simulationType}`;
    
    return `
        <div style="padding: 0;">
            <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h4 style="margin: 0; color: #1e293b; font-size: 1.1rem; font-weight: 600;">ü§ñ Browser Automation Analysis</h4>
                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.9rem;">${playwrightLogs.length} automation steps during ${simulationType} simulation</p>
            </div>
            
            <!-- All/Unique Tab Navigation -->
            <div style="background: #f1f5f9; border-bottom: 1px solid #e2e8f0; padding: 0; margin: 0;">
                <div style="display: flex; gap: 0;">
                    <div id="playwright-tab-all-${simulationType}" class="playwright-view-tab" onclick="switchPlaywrightView('all', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid #342e7c;">
                        All (${playwrightLogs.length})
                    </div>
                    <div id="playwright-tab-unique-${simulationType}" class="playwright-view-tab" onclick="switchPlaywrightView('unique', '${simulationType}')" 
                         style="padding: 8px 16px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border-bottom: 3px solid transparent;">
                        Unique (${uniquePlaywrightLogs.length})
                    </div>
                </div>
            </div>
            
            <!-- All Playwright Actions Table -->
            <div id="${allTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                ${generatePlaywrightTable(playwrightLogs, simulationType, 'all')}
            </div>
            
            <!-- Unique Playwright Actions Table -->
            <div id="${uniqueTableId}" style="max-height: 400px; overflow-y: auto; overflow-x: auto; display: none;">
                ${generatePlaywrightTable(uniquePlaywrightLogs, simulationType, 'unique')}
            </div>
        </div>
    `;
}

function generatePlaywrightTable(logs, simulationType, viewType) {
    // Sort logs chronologically (earliest first)
    const sortedPlaywrightLogs = [...logs].sort((a, b) => {
        if (!a.timestamp || !b.timestamp) return 0;
        return new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
    });
    
    return `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; background: white;">
                    <thead style="position: sticky; top: 0; z-index: 10;">
                        <tr style="background: rgb(52, 46, 124); color: white;">
                            ${viewType === 'unique' ? '' : '<th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">TIMESTAMP</th>'}
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">ACTION</th>
                            <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 0.85rem;">DETAILS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedPlaywrightLogs.map((log, index) => {
                            const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('en-US', { 
                                hour12: false, 
                                hour: '2-digit', 
                                minute: '2-digit', 
                                second: '2-digit',
                                fractionalSecondDigits: 3
                            }) : 'N/A';
                            
                            // Handle long details with expandable functionality
                            let details = log.details || '-';
                            
                            // Fix quadruple-escaped SVG attributes with advanced pattern recognition
                            if (details.includes('svg') || details.includes('SVG')) {
                                // Step 1: Fix the most complex quadruple-escaped patterns first
                                details = details
                                    .replace(/\\\\\\"/g, '"')  // Fix quadruple-escaped quotes (\\\\\" -> ")
                                    .replace(/\\\\\\\\\"/g, '"') // Fix quintuple-escaped quotes (\\\\\\" -> ")
                                    .replace(/="\\\\\\"/g, '="') // Fix quadruple-escaped attribute starts
                                    .replace(/\\\\\\">/g, '">') // Fix quadruple-escaped attribute ends
                                    
                                // Step 2: Fix triple-escaped patterns
                                    .replace(/\\\\\"/g, '"')  // Fix triple-escaped quotes (\\\" -> ")
                                    .replace(/="\\\\"/g, '="') // Fix triple-escaped attribute starts
                                    .replace(/\\\\">/g, '">') // Fix triple-escaped attribute ends
                                    
                                // Step 3: Fix double-escaped patterns
                                    .replace(/\\"/g, '"')  // Fix double-escaped quotes
                                    .replace(/\\""/g, '"') // Fix mixed escaped quotes
                                    .replace(/="\\"/g, '="') // Fix double-escaped attribute starts
                                    .replace(/\\">/g, '">') // Fix double-escaped attribute ends
                                    
                                // Step 4: Fix complex attribute value patterns
                                    .replace(/="\\\\\\\"([^"]*)\\\\\\\\""/g, '="$1"') // Fix ="\\\"value\\\\"" -> ="value"
                                    .replace(/="\\\\\\"([^"]*)\\\\\\""/g, '="$1"') // Fix ="\\"value\\"" -> ="value"
                                    .replace(/="\\"([^"]*)\\""/g, '="$1"') // Fix ="\"value\"" -> ="value"
                                    .replace(/"\\\\\\"([^"]*)\\\\\\""/g, '"$1"') // Fix "\\\"value\\\"" -> "value"
                                    .replace(/"\\\\"([^"]*)\\\\""/g, '"$1"') // Fix "\\\"value\\\"" -> "value"
                                    .replace(/"\\"([^"]*)\\""/g, '"$1"') // Fix "\"value\"" -> "value"
                                    
                                // Step 5: Fix numeric values with various escaping levels
                                    .replace(/="\\\\\\\\"(\d+|\d+\.\d+|\d+em|\d+px)\\\\\\\\""/g, '="$1"') // Quadruple-escaped numbers
                                    .replace(/="\\\\\\"(\d+|\d+\.\d+|\d+em|\d+px)\\\\\\""/g, '="$1"') // Triple-escaped numbers
                                    .replace(/="\\\\"(\d+|\d+\.\d+|\d+em|\d+px)\\\\""/g, '="$1"') // Double-escaped numbers
                                    .replace(/="\\"(\d+|\d+\.\d+|\d+em|\d+px)\\""/g, '="$1"') // Single-escaped numbers
                                    
                                // Step 6: Fix path data with various escaping levels
                                    .replace(/d="\\\\\\\\"([^"]*)\\\\\\\\""/g, 'd="$1"') // Quadruple-escaped path data
                                    .replace(/d="\\\\\\"([^"]*)\\\\\\""/g, 'd="$1"') // Triple-escaped path data
                                    .replace(/d="\\\\"([^"]*)\\\\""/g, 'd="$1"') // Double-escaped path data
                                    .replace(/d="\\"([^"]*)\\""/g, 'd="$1"') // Single-escaped path data
                                    
                                // Step 7: Fix viewBox with various escaping levels
                                    .replace(/viewBox="\\\\\\\\"([^"]*)\\\\\\\\""/g, 'viewBox="$1"') // Quadruple-escaped viewBox
                                    .replace(/viewBox="\\\\\\"([^"]*)\\\\\\""/g, 'viewBox="$1"') // Triple-escaped viewBox
                                    .replace(/viewBox="\\\\"([^"]*)\\\\""/g, 'viewBox="$1"') // Double-escaped viewBox
                                    .replace(/viewBox="\\"([^"]*)\\""/g, 'viewBox="$1"') // Single-escaped viewBox
                                    
                                // Step 8: Fix HTML entities
                                    .replace(/&quot;/g, '"') // Fix HTML entity quotes
                                    .replace(/&#34;/g, '"') // Fix numeric HTML entity quotes
                                    .replace(/\\&quot;/g, '"') // Fix escaped HTML entity quotes
                                    
                                // Step 9: Fix remaining backslashes
                                    .replace(/\\\\\\\\/g, '\\') // Fix quadruple backslashes
                                    .replace(/\\\\\\/g, '\\') // Fix triple backslashes
                                    .replace(/\\\\/g, '\\'); // Fix double backslashes
                            }
                            
                            const maxLength = 150;
                            let detailsDisplay = details;
                            
                            if (details && details !== '-' && details.length > maxLength) {
                                const detailId = `pw-detail-${simulationType}-${index}`;
                                const truncated = details.substring(0, maxLength);
                                const remaining = details.substring(maxLength);
                                
                                detailsDisplay = `
                                    <div>
                                        <span id="${detailId}-truncated">${escapeHtml(truncated)}</span>
                                        <span id="${detailId}-toggle" 
                                              style="color: #342e7c; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none;" 
                                              onclick="toggleContent('${detailId}')" 
                                              onmouseover="this.style.color='#2a2563'" 
                                              onmouseout="this.style.color='#342e7c'">
                                            ...show more
                                        </span>
                                        <span id="${detailId}-hidden" style="display: none;">${escapeHtml(remaining)}</span>
                                        <div id="${detailId}-collapse" style="display: none; margin-top: 0.5rem;">
                                            <span style="color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline; user-select: none; font-size: 0.7rem;" 
                                                  onclick="toggleContent('${detailId}')" 
                                                  onmouseover="this.style.color='#b91c1c'" 
                                                  onmouseout="this.style.color='#dc2626'">
                                                ‚Üë Show less
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};" 
                                    onmouseover="this.style.background='#f1f5f9'" 
                                    onmouseout="this.style.background='${index % 2 === 0 ? '#f8f9fa' : 'white'}'">
                                    ${viewType === 'unique' ? '' : `<td style="padding: 12px 16px; color: #6b7280; font-family: 'Consolas', monospace; font-size: 0.8rem;">${timestamp}</td>`}
                                    <td style="padding: 12px 16px;"><span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${log.action ? log.action.replace(/_/g, ' ').toUpperCase() : '-'}</span></td>
                                    <td style="padding: 12px 16px; color: #64748b; max-width: 500px; word-break: break-word; line-height: 1.4;">${details.length <= maxLength ? escapeHtml(detailsDisplay) : detailsDisplay}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
    `;
}

// Function to switch between All and Unique views for Playwright actions
function switchPlaywrightView(viewType, simulationType) {
    const allTab = document.getElementById(`playwright-tab-all-${simulationType}`);
    const uniqueTab = document.getElementById(`playwright-tab-unique-${simulationType}`);
    const allTable = document.getElementById(`playwright-table-all-${simulationType}`);
    const uniqueTable = document.getElementById(`playwright-table-unique-${simulationType}`);
    
    if (viewType === 'all') {
        allTab.style.borderBottom = '3px solid #342e7c';
        uniqueTab.style.borderBottom = '3px solid transparent';
        allTable.style.display = 'block';
        uniqueTable.style.display = 'none';
    } else {
        allTab.style.borderBottom = '3px solid transparent';
        uniqueTab.style.borderBottom = '3px solid #342e7c';
        allTable.style.display = 'none';
        uniqueTable.style.display = 'block';
    }
    
    // Update dynamic summary counts
    updateDynamicSummary(simulationType);
}

// Function to update dynamic summary counts based on current view
function updateDynamicSummary(simulationType) {
    // Get current view state for each section by checking border style
    const apiAllTab = document.getElementById(`api-tab-all-${simulationType}`);
    const apiUniqueTab = document.getElementById(`api-tab-unique-${simulationType}`);
    const networkAllTab = document.getElementById(`network-tab-all-${simulationType}`);
    const networkUniqueTab = document.getElementById(`network-tab-unique-${simulationType}`);
    const playwrightAllTab = document.getElementById(`playwright-tab-all-${simulationType}`);
    const playwrightUniqueTab = document.getElementById(`playwright-tab-unique-${simulationType}`);
    
    // Extract counts from tab labels based on which tab is active
    let apiCount = 0, networkCount = 0, playwrightCount = 0;
    
    // Check API tabs
    const apiUniqueNamesTab = document.getElementById(`api-tab-unique-names-${simulationType}`);
    if (apiAllTab && apiUniqueTab && apiUniqueNamesTab) {
        const isApiAll = apiAllTab.style.borderBottom === '3px solid rgb(52, 46, 124)' || 
                         apiAllTab.style.borderBottom === '3px solid #342e7c';
        const isApiUnique = apiUniqueTab.style.borderBottom === '3px solid rgb(52, 46, 124)' || 
                           apiUniqueTab.style.borderBottom === '3px solid #342e7c';
        const isApiUniqueNames = apiUniqueNamesTab.style.borderBottom === '3px solid rgb(52, 46, 124)' || 
                                apiUniqueNamesTab.style.borderBottom === '3px solid #342e7c';
        
        if (isApiAll) {
            apiCount = parseInt(apiAllTab.textContent.match(/\((\d+)\)/)[1]);
        } else if (isApiUnique) {
            apiCount = parseInt(apiUniqueTab.textContent.match(/\((\d+)\)/)[1]);
        } else if (isApiUniqueNames) {
            apiCount = parseInt(apiUniqueNamesTab.textContent.match(/\((\d+)\)/)[1]);
        }
    }
    
    // Check Network tabs
    if (networkAllTab && networkUniqueTab) {
        const isNetworkAll = networkAllTab.style.borderBottom === '3px solid rgb(52, 46, 124)' || 
                            networkAllTab.style.borderBottom === '3px solid #342e7c';
        if (isNetworkAll) {
            networkCount = parseInt(networkAllTab.textContent.match(/\((\d+)\)/)[1]);
        } else {
            networkCount = parseInt(networkUniqueTab.textContent.match(/\((\d+)\)/)[1]);
        }
    }
    
    // Check Playwright tabs
    if (playwrightAllTab && playwrightUniqueTab) {
        const isPlaywrightAll = playwrightAllTab.style.borderBottom === '3px solid rgb(52, 46, 124)' || 
                               playwrightAllTab.style.borderBottom === '3px solid #342e7c';
        if (isPlaywrightAll) {
            playwrightCount = parseInt(playwrightAllTab.textContent.match(/\((\d+)\)/)[1]);
        } else {
            playwrightCount = parseInt(playwrightUniqueTab.textContent.match(/\((\d+)\)/)[1]);
        }
    }
    
    // Update the dynamic summary elements with unique counts preserved
    const apiSummary = document.getElementById(`api-summary-${simulationType}`);
    const networkSummary = document.getElementById(`network-summary-${simulationType}`);
    const playwrightSummary = document.getElementById(`playwright-summary-${simulationType}`);
    
    // Get unique counts from the data
    let uniqueApis = 0, uniqueHosts = 0, uniqueActions = 0;
    if (currentSimulationData) {
        switch(simulationType) {
            case 'no':
                uniqueApis = currentSimulationData.no_activity_unique_apis || 0;
                uniqueHosts = currentSimulationData.no_activity_unique_hosts || 0;
                break;
            case 'static':
                uniqueApis = currentSimulationData.static_script_unique_apis || 0;
                uniqueHosts = currentSimulationData.static_script_unique_hosts || 0;
                uniqueActions = currentSimulationData.static_script_unique_actions || 0;
                break;
            case 'adaptive':
                uniqueApis = currentSimulationData.dynamic_script_unique_apis || 0;
                uniqueHosts = currentSimulationData.dynamic_script_unique_hosts || 0;
                uniqueActions = currentSimulationData.dynamic_script_unique_actions || 0;
                break;
        }
    }
    
    if (apiSummary && apiCount > 0) {
        apiSummary.textContent = `üîå ${apiCount} API Calls${uniqueApis > 0 ? ` (${uniqueApis} Unique)` : ''}`;
    }
    if (networkSummary && networkCount > 0) {
        networkSummary.textContent = `üåê ${networkCount} Network Requests${uniqueHosts > 0 ? ` (${uniqueHosts} Unique Hosts)` : ''}`;
    }
    if (playwrightSummary && playwrightCount > 0) {
        playwrightSummary.textContent = `ü§ñ ${playwrightCount} Automation Steps${uniqueActions > 0 ? ` (${uniqueActions} Unique Actions)` : ''}`;
    }
}

// Helper function for expand/collapse functionality
function toggleContent(contentId) {
    const truncated = document.getElementById(`${contentId}-truncated`);
    const toggle = document.getElementById(`${contentId}-toggle`);
    const hidden = document.getElementById(`${contentId}-hidden`);
    const collapse = document.getElementById(`${contentId}-collapse`);
    
    if (hidden && toggle && collapse) {
        if (hidden.style.display === 'none') {
            // Show full content
            hidden.style.display = 'inline';
            toggle.style.display = 'none';
            collapse.style.display = 'block';
        } else {
            // Show truncated content
            hidden.style.display = 'none';
            toggle.style.display = 'inline';
            collapse.style.display = 'none';
        }
    }
}

        // File details modal functionality
        function showFileDetails(filepath, filename) {
            // Show loading modal
            showModal(`
                <div class="modal-header">
                    <h3><i class="fas fa-file-code"></i> ${filename}</h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading detailed analysis...
                    </div>
                </div>
            `);

            // Use already loaded file data instead of making separate API call
            if (window.extensionAnalysisData && window.extensionAnalysisData.analysis && window.extensionAnalysisData.analysis.files) {
                const file = window.extensionAnalysisData.analysis.files.find(f => 
                    f.filename === filepath || 
                    f.filename.endsWith(filepath) ||
                    filepath.includes(f.filename) ||
                    f.filename.includes(filepath.split('/').pop())
                );
                
                if (file) {
                    closeModal(); // Close loading modal first
                    showFileDetailsModal(file);
                    return;
                }
            }
            
            // Fallback to API call if file not found in loaded data
            fetch(`/api/extension/${extensionId}/file/${encodeURIComponent(filepath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeModal(); // Close loading modal first
                        showFileDetailsModal(data.file);
                    } else {
                        closeModal(); // Close loading modal first
                        showModal(`
                            <div class="modal-header">
                                <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                                <button class="close-btn" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p>Error loading file details: ${data.message}</p>
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    closeModal(); // Close loading modal first
                    showModal(`
                        <div class="modal-header">
                            <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Error loading file details: ${error.message}</p>
                        </div>
                    `);
                });
        }

        function showFileDetailsModal(file) {
            // Check if file is obfuscated
            const obfuscationWarningHtml = file.obfuscation ? `
                <div class="obfuscation-warning">
                    <div class="obfuscation-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Obfuscated Code Detected</h3>
                        <span class="obfuscation-badge">SECURITY ALERT</span>
                    </div>
                    <p>This file contains deliberately obfuscated code that may be attempting to hide malicious functionality.</p>
                    <div class="obfuscation-details">
                        <div class="obfuscation-metric">
                            <span class="metric-label">Detection Confidence:</span>
                            <span class="metric-value">${file.obfuscation.confidence || 80}%</span>
                        </div>
                        <div class="obfuscation-technique">
                            <span class="technique-label">Detected Techniques:</span>
                            <div class="technique-name">${file.obfuscation.technique || 'Unknown technique'}</div>
                            <div class="technique-description">${file.obfuscation.description || 'Code obfuscation detected'}</div>
                        </div>
                    </div>
                </div>
            ` : '';

            // Deduplicate security issues using the same logic as backend
            let deduplicatedSecurityIssues = [];
            if (file.security_issues && file.security_issues.length > 0) {
                const uniqueIssues = new Set();
                file.security_issues.forEach(issue => {
                    // Create unique key based on line + rule + description (same as backend logic)
                    const rule_id = issue.rule_id || issue.type || 'unknown';
                    const line_number = issue.line || issue.line_number || 0;
                    const description = issue.description || issue.vulnerability || '';
                    const uniqueKey = `${rule_id}_${line_number}_${description}`;
                    
                    if (!uniqueIssues.has(uniqueKey)) {
                        uniqueIssues.add(uniqueKey);
                        deduplicatedSecurityIssues.push(issue);
                    }
                });
            }
            
            const securityIssuesHtml = deduplicatedSecurityIssues.length > 0 
                ? deduplicatedSecurityIssues.map(issue => {
                    const lineNumber = issue.line || issue.line_number || 1;
                    const monacoUrl = `https://extension-analysis-machine.onrender.com/monaco/${extensionId}/${file.filename}#L${lineNumber}`;
                    
                    return `
                    <div class="security-issue ${issue.severity || 'medium'}">
                        <div class="issue-header">
                            <a href="${monacoUrl}" target="_blank" class="issue-title" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #6b7280; cursor: pointer;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#6b7280'">${issue.title || issue.type}</a>
                            <span class="issue-severity ${issue.severity || 'medium'}">${issue.severity || 'medium'}</span>
                        </div>
                        <div class="issue-description">
                            <a href="${monacoUrl}" target="_blank" style="text-decoration: none; color: inherit; border-bottom: 1px dotted #9ca3af; cursor: pointer;" onmouseover="this.style.borderBottomColor='#342e7c'" onmouseout="this.style.borderBottomColor='#9ca3af'">${issue.description}</a>
                        </div>
                    </div>
                `;
                }).join('')
                : '<p class="no-issues">No security issues detected</p>';

            const functionsHtml = file.functions && file.functions.length > 0
                ? file.functions.map(func => `<span class="code-item function-item">${func}()</span>`).join('')
                : '<p class="no-data">No functions detected</p>';

            const apiCallsHtml = file.api_calls && file.api_calls.length > 0
                ? file.api_calls.map(call => `<span class="code-item api-item">${call}()</span>`).join('')
                : '<p class="no-data">No API calls detected</p>';

            const variablesHtml = file.variables && file.variables.length > 0
                ? file.variables.map(variable => `<span class="code-item variable-item">${variable}</span>`).join('')
                : '<p class="no-data">No variables detected</p>';

            showModal(`
                <div class="modal-header">
                    <h3><i class="fas fa-file-code"></i> ${file.filename}</h3>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    ${obfuscationWarningHtml}
                    <div class="file-details-grid">
                        <div class="detail-section">
                            <h4><i class="fas fa-chart-bar"></i> Code Metrics</h4>
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <span class="metric-value">${file.function_count || 0}</span>
                                    <span class="metric-label">Functions</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">${file.api_call_count || 0}</span>
                                    <span class="metric-label">API Calls</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">${file.variable_count || 0}</span>
                                    <span class="metric-label">Variables</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">${file.loops_count || 0}</span>
                                    <span class="metric-label">Loops</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">${file.conditionals_count || 0}</span>
                                    <span class="metric-label">Conditionals</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-shield-alt"></i> Security Issues</h4>
                            <div class="security-issues">
                                ${securityIssuesHtml}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-code"></i> Functions (${file.function_count || 0})</h4>
                            <div class="code-items-container">
                                ${functionsHtml}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-link"></i> API Calls (${file.api_call_count || 0})</h4>
                            <div class="code-items-container">
                                ${apiCallsHtml}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-variable"></i> Variables (${file.variable_count || 0})</h4>
                            <div class="code-items-container">
                                ${variablesHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showModal(content) {
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-container" onclick="event.stopPropagation()">
                        ${content}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function showError(message) {
            document.body.innerHTML = `
                <div class="header">
                    <div class="header-inner">
                        <div class="header-left">
                            <h1><a href="/">Extension Analysis Machine</a></h1>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; padding: 4rem; margin-top: 80px;">
                    <h2 style="color: #dc2626;">${message}</h2>
                    <a href="/" style="color: #342e7c; text-decoration: none; margin-top: 1rem; display: inline-block;">‚Üê Back to Home</a>
                </div>
            `;
        }

        function toggleFileList(fileId) {
            const toggleElement = document.getElementById(`${fileId}-toggle`);
            const hiddenElement = document.getElementById(`${fileId}-hidden`);
            const collapseElement = document.getElementById(`${fileId}-collapse`);
            
            if (!toggleElement || !hiddenElement || !collapseElement) return;
            
            const isExpanded = hiddenElement.style.display !== 'none';
            
            if (isExpanded) {
                // Collapse - hide additional files
                hiddenElement.style.display = 'none';
                collapseElement.style.display = 'none';
                toggleElement.style.display = 'inline';
                const moreCount = hiddenElement.textContent.split(',').length;
                toggleElement.textContent = `+${moreCount} more`;
            } else {
                // Expand - show all files
                hiddenElement.style.display = 'block';
                collapseElement.style.display = 'block';
                toggleElement.style.display = 'none';
            }
        }

        function toggleArguments(argId) {
            const toggleElement = document.getElementById(`${argId}-toggle`);
            const hiddenElement = document.getElementById(`${argId}-hidden`);
            const collapseElement = document.getElementById(`${argId}-collapse`);
            
            if (!toggleElement || !hiddenElement || !collapseElement) return;
            
            const isExpanded = hiddenElement.style.display !== 'none';
            
            if (isExpanded) {
                // Collapse - hide additional JSON
                hiddenElement.style.display = 'none';
                collapseElement.style.display = 'none';
                toggleElement.style.display = 'inline';
                toggleElement.textContent = '...show more';
            } else {
                // Expand - show full JSON
                hiddenElement.style.display = 'inline';
                collapseElement.style.display = 'block';
                toggleElement.style.display = 'none';
            }
        }

        async function lookupIPLocation(ip, element) {
            // Change button to loading state
            element.innerHTML = '‚è≥ Looking up...';
            element.style.background = '#6b7280';
            element.style.cursor = 'not-allowed';
            
            try {
                // Use a free IP geolocation API
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.reason);
                }
                
                // Display location information
                const location = [data.city, data.region, data.country_name].filter(x => x).join(', ');
                const org = data.org || 'Unknown ISP';
                
                element.innerHTML = `üåç ${location}`;
                element.style.background = '#059669';
                element.title = `${ip}\nLocation: ${location}\nISP: ${org}\nTimezone: ${data.timezone || 'Unknown'}`;
                
                // Add click to show more details
                element.onclick = () => {
                    alert(`IP Address: ${ip}\n\nLocation: ${location}\nISP/Organization: ${org}\nTimezone: ${data.timezone || 'Unknown'}\nLatitude: ${data.latitude || 'Unknown'}\nLongitude: ${data.longitude || 'Unknown'}`);
                };
                
            } catch (error) {
                element.innerHTML = '‚ùå Lookup failed';
                element.style.background = '#dc2626';
                element.title = `Failed to lookup ${ip}: ${error.message}`;
                element.onclick = () => lookupIPLocation(ip, element);
            }
        }

        // ===== FILE VIEW TAB FUNCTIONALITY =====
        
        let currentFileTree = null;
        let currentSelectedFile = null;
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Add notification animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // File Viewer Functions
        function updateFileViewerTab(analysis) {
            const filesList = document.getElementById('viewerFilesList');
            
            // Show loading
            filesList.innerHTML = `
                <div class="loading" style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    Loading all extension files...
                </div>
            `;
            
            // Wait for JSZip to be fully ready, then load files from GCS
            setTimeout(() => {
                loadFilesFromGCS(extensionId)
                    .catch(error => {
                        console.error('GCS loading failed:', error);
                    // Show error message
                    document.getElementById('viewerFilesList').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc2626;">
                            <p>‚ùå Failed to load files from GCS API</p>
                            <p style="font-size: 0.8rem; color: #6b7280;">${error.message}</p>
                        </div>
                    `;
                });
            }, 3000); // Wait 3 seconds for JSZip CDN fallbacks
        }
        
        // Global extension ID for GCS API access
        let currentExtensionId = null;
        
        // Wait for JSZip to be loaded with enhanced checking
        function waitForJSZip() {
            return new Promise((resolve, reject) => {
                // Enhanced check for JSZip availability
                function isJSZipAvailable() {
                    return (typeof window.JSZip !== 'undefined' && window.JSZip) || 
                           (typeof JSZip !== 'undefined' && JSZip);
                }
                
                // If already loaded, resolve immediately
                if (isJSZipAvailable()) {
                    console.log('‚úÖ JSZip already available');
                    // Ensure it's on window object
                    if (typeof window.JSZip === 'undefined' && typeof JSZip !== 'undefined') {
                        window.JSZip = JSZip;
                        console.log('üîß JSZip assigned to window object');
                    }
                    resolve();
                    return;
                }
                
                console.log('‚è≥ JSZip not ready, starting wait sequence...');
                
                // Check for JSZip every 200ms, timeout after 15 seconds
                let attempts = 0;
                const maxAttempts = 75; // 15 seconds total
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (isJSZipAvailable()) {
                        clearInterval(checkInterval);
                        
                        // Ensure it's on window object
                        if (typeof window.JSZip === 'undefined' && typeof JSZip !== 'undefined') {
                            window.JSZip = JSZip;
                            console.log('üîß JSZip assigned to window object during wait');
                        }
                        
                        console.log('‚úÖ JSZip is now available');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.error('‚ùå JSZip loading timeout after 15 seconds');
                        reject(new Error('JSZip failed to load within 15 seconds'));
                    }
                }, 200);
            });
        }
        
        async function loadFilesFromGCS(extensionId) {
            console.log('üöÄ Loading files from GCS ZIP bucket with signed URL...');
            currentExtensionId = extensionId;
            
            // Wait for JSZip to load if not ready
            await waitForJSZip();
            
            const JSZipLib = window.JSZip;
            console.log('‚úÖ JSZip is ready for use');
            
            try {
                // Get signed URL from backend
                console.log('üîê Getting signed ZIP URL...');
                const zipInfoResponse = await fetch(`/api/extension/${extensionId}/zip-info`);
                if (!zipInfoResponse.ok) {
                    throw new Error(`ZIP info failed: HTTP ${zipInfoResponse.status}`);
                }
                
                const zipInfo = await zipInfoResponse.json();
                if (!zipInfo.success) {
                    throw new Error(`ZIP info error: ${zipInfo.message}`);
                }
                
                const zipUrl = zipInfo.zip_url;
                const isSignedUrl = zipInfo.signed_url;
                console.log(`üì¶ Downloading ZIP ${isSignedUrl ? 'with signed URL' : 'with public URL'}: ${zipUrl.substring(0, 100)}...`);
                
                const response = await fetch(zipUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const zipBuffer = await response.arrayBuffer();
                console.log(`‚úÖ ZIP downloaded from GCS: ${zipBuffer.byteLength} bytes (${isSignedUrl ? 'signed' : 'public'} URL)`);
                
                // Extract with JSZip
                const zip = await JSZipLib.loadAsync(zipBuffer);
                extensionZipCache = zip;
                
                // Get all files from ZIP
                const files = [];
                zip.forEach((path, zipEntry) => {
                    if (!zipEntry.dir) {
                        const filename = path.split('/').pop();
                        files.push({
                            filename: filename,
                            relative_path: path,
                            file_size: zipEntry._data ? zipEntry._data.uncompressedSize : 0,
                            file_type: '.' + filename.split('.').pop(),
                            is_analyzed: filename.endsWith('.js')
                        });
                    }
                });
                
                console.log(`‚úÖ ${files.length} files extracted from GCS ZIP`);
                displayAllFiles(files, files.length, files.filter(f => f.is_analyzed).length);
                return files;
                
            } catch (error) {
                console.error('‚ùå GCS ZIP loading failed:', error);
                throw error;
            }
        }
        
        
        function getMimeType(extension) {
            const mimeTypes = {
                '.js': 'text/javascript',
                '.json': 'application/json',
                '.html': 'text/html',
                '.css': 'text/css',
                '.png': 'image/png',
                '.jpg': 'image/jpeg',
                '.jpeg': 'image/jpeg',
                '.svg': 'image/svg+xml',
                '.woff2': 'font/woff2',
                '.woff': 'font/woff',
                '.ttf': 'font/ttf'
            };
            return mimeTypes[extension] || 'text/plain';
        }
        
        function getSecurityTags(file) {
            // No security tags - just return empty
            return [];
        }
        
        function getTagStyle(type) {
            const styles = {
                'obfuscated': 'background: #dc2626; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;',
                'vulnerability': 'background: #f59e0b; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;',
                'security': 'background: #ef4444; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;',
                'high-risk': 'background: #991b1b; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;',
                'critical': 'background: #7f1d1d; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600; animation: pulse 2s infinite;',
                'suspicious': 'background: #ea580c; color: white; padding: 0.15rem 0.4rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600;'
            };
            return styles[type] || styles['security'];
        }
        
        async function loadFileFromZip(relativePath) {
            if (!extensionZipCache) {
                throw new Error('ZIP cache not available');
            }
            
            
            // Get file directly by relative path
            const zipEntry = extensionZipCache.file(relativePath);
            
            if (!zipEntry) {
                throw new Error(`File not found in ZIP: ${relativePath}`);
            }
            
            console.log('‚úÖ Found file in GCS ZIP:', relativePath);
            
            // Extract content as text
            const content = await zipEntry.async('text');
            return content;
        }
        
        // Store original files data globally for filtering
        let originalFilesData = [];
        
        function displayAllFiles(files, totalFiles, analyzedFiles) {
            const filesList = document.getElementById('viewerFilesList');
            
            if (!files || files.length === 0) {
                filesList.innerHTML = `<div style="text-align: center; padding: 2rem; color: #6b7280;"><p>No files found for this extension.</p></div>`;
                return;
            }
            
            // Store original data for filtering
            originalFilesData = files;
            
            // Render files
            renderFilteredFiles(files, totalFiles);
        }
        
        function renderFilteredFiles(files, totalFiles) {
            const filesList = document.getElementById('viewerFilesList');
            
            // Group files by directory for better organization
            const groupedFiles = {};
            files.forEach(file => {
                let dir = file.relative_path.includes('/') ? 
                    file.relative_path.substring(0, file.relative_path.lastIndexOf('/')) : 
                    'Root';
                
                // Clean up directory path - remove extension ID prefix
                if (dir !== 'Root') {
                    const parts = dir.split('/');
                    // Remove extension ID (32 character alphanumeric) from the beginning
                    if (parts[0] && parts[0].length === 32 && /^[a-z0-9]+$/.test(parts[0])) {
                        parts.shift(); // Remove first part (extension ID)
                        dir = parts.length > 0 ? parts.join('/') : 'Root';
                    }
                }
                    
                if (!groupedFiles[dir]) {
                    groupedFiles[dir] = [];
                }
                groupedFiles[dir].push(file);
            });
            
            // Sort directories and files
            const sortedDirs = Object.keys(groupedFiles).sort();
            
            let html = `
                <div style="padding: 1rem; background: #f8fafc; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <strong>${files.length}</strong> ${files.length === originalFilesData.length ? 'total files' : 'matching files'}
                    </div>
                </div>
            `;
            
            sortedDirs.forEach(dir => {
                const dirFiles = groupedFiles[dir].sort((a, b) => a.filename.localeCompare(b.filename));
                const dirId = `dir-${dir.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                html += `
                    <div style="margin-bottom: 0.25rem;">
                        <div class="folder-header" onclick="toggleFolder('${dirId}')" style="padding: 0.25rem 0.5rem; background: transparent; font-weight: 500; color: #374151; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: background-color 0.15s ease;">
                            <span id="chevron-${dirId}" style="font-size: 0.8rem; color: #6b7280;">‚ñ∂</span>
                            ${dir} (${dirFiles.length} files)
                        </div>
                        <div id="${dirId}" class="folder-content" style="display: none; margin-left: 1rem;">
                `;
                
                dirFiles.forEach(file => {
                    const sizeText = formatFileSize(file.file_size);
                    
                    // Generate security tags based on actual data
                    const securityTags = getSecurityTags(file);
                    const tagsHtml = securityTags.map(tag => {
                        const tagStyle = getTagStyle(tag.type);
                        return `<span style="${tagStyle}">${tag.label}</span>`;
                    }).join(' ');
                    
                    // Split long filenames into two lines, only truncate if extremely long
                    let filenameDisplay;
                    if (file.filename.length > 50) {
                        // Only truncate if extremely long (50+ chars)
                        filenameDisplay = `<div style="font-weight: 500; color: #1f2937; font-size: 0.85rem; line-height: 1.3;" title="${file.filename}">${file.filename.substring(0, 40)}...</div>`;
                    } else if (file.filename.length > 15) {
                        // Split into two lines for medium length names (15-50 chars)
                        const midPoint = Math.ceil(file.filename.length / 2);
                        const firstHalf = file.filename.substring(0, midPoint);
                        const secondHalf = file.filename.substring(midPoint);
                        filenameDisplay = `
                            <div style="font-weight: 500; color: #1f2937; font-size: 0.85rem; line-height: 1.2;" title="${file.filename}">
                                <div>${firstHalf}</div>
                                <div>${secondHalf}</div>
                            </div>
                        `;
                    } else {
                        // Short names display normally
                        filenameDisplay = `<div style="font-weight: 500; color: #1f2937; font-size: 0.9rem;" title="${file.filename}">${file.filename}</div>`;
                    }
                    
                    html += `
                        <div class="file-item" onclick="loadFileContent('${file.relative_path}')" 
                             style="padding: 0.75rem 1rem; margin-bottom: 0.25rem; background: white; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: all 0.2s ease;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
                                <div style="flex: 1; min-width: 0;">
                                    ${tagsHtml ? `<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">${tagsHtml}</div>` : ''}
                                    ${filenameDisplay}
                                </div>
                                <div style="flex-shrink: 0; font-size: 0.75rem; color: #6b7280; font-weight: 500; text-align: right; margin-top: 0.1rem;">${sizeText}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            filesList.innerHTML = html;
            
            // Add hover effects for file items
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f8fafc';
                    this.style.borderColor = '#3b82f6';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                    this.style.borderColor = '#f3f4f6';
                });
            });
            
            // Add hover effects for folder headers (VS Code style)
            document.querySelectorAll('.folder-header').forEach(header => {
                header.addEventListener('mouseenter', function() {
                    this.style.background = '#f3f4f6';
                });
                header.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                });
            });
        }
        
        function displayAnalysisFiles(analysis) {
            // Fallback function for old analysis data
            const filesList = document.getElementById('viewerFilesList');
            
            if (!analysis || !analysis.files || analysis.files.length === 0) {
                filesList.innerHTML = `<div style="text-align: center; padding: 2rem; color: #6b7280;"><p>No files found for this extension.</p></div>`;
                return;
            }
            
            // Group files and get unique filenames
            const filesMap = new Map();
            
            analysis.files.forEach(file => {
                // Use the relative_path first, then full_path, then filename
                let displayPath = file.relative_path || file.full_path || file.filename || 'Unknown';
                
                // Clean up the path for display
                if (displayPath.startsWith('./')) {
                    displayPath = displayPath.substring(2);
                }
                
                // Use full path as key to properly deduplicate
                const fullPath = file.full_path || file.filename || 'Unknown';
                
                // Use full path as key to remove duplicates
                if (!filesMap.has(fullPath)) {
                    filesMap.set(fullPath, {
                        name: displayPath,
                        fullPath: fullPath,
                        size: file.file_size || 0,
                        functions: file.function_count || 0,
                        variables: file.variable_count || 0,
                        apiCalls: file.api_call_count || 0
                    });
                }
            });
            
            // Convert map to array
            const files = Array.from(filesMap.values());
            
            // Sort files by name
            files.sort((a, b) => a.name.localeCompare(b.name));
            
            let html = '';
            files.forEach(file => {
                const sizeText = formatFileSize(file.size);
                const isObfuscated = file.name.includes('min.js') || file.functions > 50;
                
                html += `
                    <div class="file-item" onclick="loadFileContent('${file.fullPath}')" 
                         style="padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #e5e7eb; transition: all 0.2s ease;">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    ${isObfuscated ? '<span style="background: #fef2f2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; flex-shrink: 0;">OBFUSCATED</span>' : ''}
                                </div>
                                <div style="font-weight: 600; color: #1f2937; font-size: 0.9rem; word-break: break-all; line-height: 1.3; margin-bottom: 0.25rem;" title="${file.name}">${file.name}</div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ${sizeText} ‚Ä¢ ${file.functions} functions ‚Ä¢ ${file.variables} variables ‚Ä¢ ${file.apiCalls} API calls
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            filesList.innerHTML = html;
            
            // Add hover effects
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f3f4f6';
                    this.style.borderColor = '#342e7c';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                    this.style.borderColor = '#e5e7eb';
                });
            });
        }
        
        // File Viewer with Monaco Editor - Official VS Code Syntax Highlighting

                
                
                
                
                
                
        function getLanguageFromFilename(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const lowerFilename = filename.toLowerCase();
            
            // Check for common extension development files
            if (lowerFilename === 'manifest.json') return 'json';
            if (lowerFilename.includes('package.json')) return 'json';
            if (lowerFilename.includes('tsconfig.json')) return 'json';
            if (lowerFilename.includes('.d.ts')) return 'typescript';
            
            switch (ext) {
                // JavaScript & TypeScript
                case 'js': return 'javascript';
                case 'jsx': return 'javascript';
                case 'mjs': return 'javascript';
                case 'cjs': return 'javascript';
                case 'ts': return 'typescript';
                case 'tsx': return 'typescript';
                
                // Web Technologies
                case 'json': return 'json';
                case 'html': return 'html';
                case 'htm': return 'html';
                case 'xhtml': return 'html';
                case 'css': return 'css';
                case 'scss': return 'scss';
                case 'sass': return 'scss';
                case 'less': return 'less';
                case 'styl': return 'stylus';
                
                // Markup & Config
                case 'xml': return 'xml';
                case 'svg': return 'xml';
                case 'yaml': return 'yaml';
                case 'yml': return 'yaml';
                case 'md': return 'markdown';
                case 'markdown': return 'markdown';
                case 'txt': return 'plaintext';
                
                // Programming Languages (for extension development)
                case 'py': return 'python';
                case 'php': return 'php';
                case 'java': return 'java';
                case 'c': return 'c';
                case 'cpp': return 'cpp';
                case 'h': return 'c';
                case 'hpp': return 'cpp';
                case 'cs': return 'csharp';
                case 'go': return 'go';
                case 'rs': return 'rust';
                case 'rb': return 'ruby';
                case 'swift': return 'swift';
                case 'kt': return 'kotlin';
                case 'dart': return 'dart';
                
                // Shell & Config
                case 'sh': return 'shell';
                case 'bash': return 'shell';
                case 'zsh': return 'shell';
                case 'fish': return 'shell';
                case 'ps1': return 'powershell';
                case 'bat': return 'bat';
                case 'cmd': return 'bat';
                
                // Data formats
                case 'toml': return 'toml';
                case 'ini': return 'ini';
                case 'cfg': return 'ini';
                case 'conf': return 'ini';
                case 'env': return 'shell';
                
                default: 
                    // Try to detect by content patterns
                    if (filename.includes('Dockerfile')) return 'dockerfile';
                    if (filename.includes('Makefile')) return 'makefile';
                    if (filename.includes('LICENSE')) return 'plaintext';
                    if (filename.includes('README')) return 'markdown';
                    return 'plaintext';
            }
        }
        
        function applySyntaxHighlighting(element, filename) {
            // Basic syntax highlighting for JavaScript files
            if (filename.endsWith('.js') || filename.endsWith('.jsx')) {
                let content = element.textContent;
                
                // Add line numbers
                const lines = content.split('\\n');
                const lineCount = lines.length;
                const maxDigits = lineCount.toString().length;
                
                let numberedContent = lines.map((line, index) => {
                    const lineNum = (index + 1).toString().padStart(maxDigits, ' ');
                    return `<span style="color: #9ca3af; user-select: none; margin-right: 1rem;">${lineNum}</span>${escapeHtml(line)}`;
                }).join('\\n');
                
                element.innerHTML = numberedContent;
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const lowerFilename = filename.toLowerCase();
            
            // Special files
            if (lowerFilename === 'manifest.json') return '<span style="color: #10b981;">üìã</span>';
            if (lowerFilename.includes('package.json')) return '<span style="color: #ef4444;">üì¶</span>';
            if (lowerFilename.includes('readme')) return '<span style="color: #3b82f6;">üìñ</span>';
            if (lowerFilename.includes('license')) return '<span style="color: #6b7280;">üìú</span>';
            
            switch (ext) {
                // JavaScript & TypeScript - Yellow/Blue
                case 'js':
                case 'jsx':
                case 'mjs':
                case 'cjs':
                    return '<span style="color: #f59e0b;">üìÑ</span>';
                case 'ts':
                case 'tsx':
                    return '<span style="color: #3b82f6;">üìò</span>';
                
                // Web Technologies
                case 'json':
                    return '<span style="color: #10b981;">‚öôÔ∏è</span>';
                case 'html':
                case 'htm':
                case 'xhtml':
                    return '<span style="color: #ef4444;">üåê</span>';
                case 'css':
                    return '<span style="color: #06b6d4;">üé®</span>';
                case 'scss':
                case 'sass':
                    return '<span style="color: #ec4899;">üé®</span>';
                case 'less':
                    return '<span style="color: #1d4ed8;">üé®</span>';
                
                // Images
                case 'png':
                case 'jpg':
                case 'jpeg':
                case 'gif':
                case 'svg':
                case 'ico':
                    return '<span style="color: #8b5cf6;">üñºÔ∏è</span>';
                
                // Programming Languages
                case 'py':
                    return '<span style="color: #3b82f6;">üêç</span>';
                case 'php':
                    return '<span style="color: #8b5cf6;">üêò</span>';
                case 'java':
                    return '<span style="color: #ef4444;">‚òï</span>';
                case 'c':
                case 'h':
                    return '<span style="color: #6b7280;">‚ö°</span>';
                case 'cpp':
                case 'hpp':
                    return '<span style="color: #3b82f6;">‚ö°</span>';
                case 'cs':
                    return '<span style="color: #8b5cf6;">üíé</span>';
                case 'go':
                    return '<span style="color: #06b6d4;">üêπ</span>';
                case 'rs':
                    return '<span style="color: #ef4444;">ü¶Ä</span>';
                case 'rb':
                    return '<span style="color: #ef4444;">üíé</span>';
                case 'swift':
                    return '<span style="color: #f59e0b;">üê¶</span>';
                case 'kt':
                    return '<span style="color: #8b5cf6;">üÖ∫</span>';
                case 'dart':
                    return '<span style="color: #06b6d4;">üéØ</span>';
                
                // Markup & Config
                case 'xml':
                    return '<span style="color: #10b981;">üìä</span>';
                case 'yaml':
                case 'yml':
                    return '<span style="color: #ef4444;">üìù</span>';
                case 'md':
                case 'markdown':
                    return '<span style="color: #374151;">üìñ</span>';
                case 'txt':
                    return '<span style="color: #6b7280;">üìÑ</span>';
                
                // Shell & Config
                case 'sh':
                case 'bash':
                case 'zsh':
                case 'fish':
                    return '<span style="color: #374151;">‚ö°</span>';
                case 'ps1':
                    return '<span style="color: #3b82f6;">üíª</span>';
                case 'bat':
                case 'cmd':
                    return '<span style="color: #6b7280;">üíª</span>';
                
                // Data formats
                case 'toml':
                case 'ini':
                case 'cfg':
                case 'conf':
                    return '<span style="color: #6b7280;">‚öôÔ∏è</span>';
                case 'env':
                    return '<span style="color: #10b981;">üîê</span>';
                
                // Archives & Others
                case 'zip':
                case 'tar':
                case 'gz':
                case 'rar':
                    return '<span style="color: #f59e0b;">üì¶</span>';
                case 'pdf':
                    return '<span style="color: #ef4444;">üìï</span>';
                
                default:
                    if (filename.includes('Dockerfile')) return '<span style="color: #06b6d4;">üê≥</span>';
                    if (filename.includes('Makefile')) return '<span style="color: #374151;">üî®</span>';
                    return '<span style="color: #6b7280;">üìÑ</span>';
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function copyCodeToClipboard() {
            if (window.currentFileContent) {
                navigator.clipboard.writeText(window.currentFileContent).then(() => {
                    const btn = document.getElementById('copyCodeBtn');
                    const originalText = btn.textContent;
                    btn.textContent = '‚úÖ Copied!';
                    btn.style.background = '#059669';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#342e7c';
                    }, 2000);
                }).catch(err => {
                });
            }
        }
        
        function toggleFolder(folderId) {
            const folderContent = document.getElementById(folderId);
            const chevron = document.getElementById(`chevron-${folderId}`);
            
            if (folderContent.style.display === 'none') {
                // Expand folder
                folderContent.style.display = 'block';
                chevron.textContent = '‚ñº';
            } else {
                // Collapse folder
                folderContent.style.display = 'none';
                chevron.textContent = '‚ñ∂';
            }
        }
        
        function filterFiles(searchTerm) {
            if (!originalFilesData || originalFilesData.length === 0) {
                return;
            }
            
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // If search is empty, hide button and show all files in folder structure
            if (!searchTerm.trim()) {
                clearBtn.style.display = 'none';
                renderFilteredFiles(originalFilesData, originalFilesData.length);
                return;
            }
            
            // Show clear button only when there's actual text
            clearBtn.style.display = 'flex';
            
            // Filter files based on search term
            const filteredFiles = originalFilesData.filter(file => {
                const searchLower = searchTerm.toLowerCase();
                const filename = file.filename.toLowerCase();
                const relativePath = file.relative_path.toLowerCase();
                const fileType = (file.file_type || '').toLowerCase();
                
                // Search in filename, path, and file type
                return filename.includes(searchLower) || 
                       relativePath.includes(searchLower) || 
                       fileType.includes(searchLower);
            });
            
            // Render filtered results as flat list (no folders)
            renderSearchResults(filteredFiles, originalFilesData.length);
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('fileSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // Clear input and hide button
            searchInput.value = '';
            clearBtn.style.display = 'none';
            
            // Show all files in folder structure
            renderFilteredFiles(originalFilesData, originalFilesData.length);
        }
        
        function hideClearButtonIfEmpty() {
            const searchInput = document.getElementById('fileSearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // Only hide if search is empty
            if (!searchInput.value.trim()) {
                clearBtn.style.display = 'none';
            }
        }
        
        function renderSearchResults(files, totalFiles) {
            const filesList = document.getElementById('viewerFilesList');
            
            let html = `
                <div style="padding: 1rem; background: #f8fafc; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; color: #6b7280;">
                        <strong>${files.length}</strong> matching files
                    </div>
                </div>
            `;
            
            if (files.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <p>No files found matching your search.</p>
                    </div>
                `;
            } else {
                // Sort files by name for better search results
                const sortedFiles = files.sort((a, b) => a.filename.localeCompare(b.filename));
                
                sortedFiles.forEach(file => {
                    const sizeText = formatFileSize(file.file_size);
                    
                    // Generate security tags based on actual data
                    const securityTags = getSecurityTags(file);
                    const tagsHtml = securityTags.map(tag => {
                        const tagStyle = getTagStyle(tag.type);
                        return `<span style="${tagStyle}">${tag.label}</span>`;
                    }).join(' ');
                    
                    // Split long filenames into two lines for search results
                    let filenameDisplay;
                    if (file.filename.length > 50) {
                        // Only truncate if extremely long (50+ chars)
                        filenameDisplay = `<div style="font-weight: 500; color: #1f2937; font-size: 0.85rem; line-height: 1.3; margin-bottom: 0.25rem;" title="${file.filename}">${file.filename.substring(0, 40)}...</div>`;
                    } else if (file.filename.length > 15) {
                        // Split into two lines for medium length names (15-50 chars)
                        const midPoint = Math.ceil(file.filename.length / 2);
                        const firstHalf = file.filename.substring(0, midPoint);
                        const secondHalf = file.filename.substring(midPoint);
                        filenameDisplay = `
                            <div style="font-weight: 500; color: #1f2937; font-size: 0.85rem; line-height: 1.2; margin-bottom: 0.25rem;" title="${file.filename}">
                                <div>${firstHalf}</div>
                                <div>${secondHalf}</div>
                            </div>
                        `;
                    } else {
                        // Short names display normally
                        filenameDisplay = `<div style="font-weight: 500; color: #1f2937; font-size: 0.9rem; margin-bottom: 0.25rem;" title="${file.filename}">${file.filename}</div>`;
                    }
                    
                    // Truncate relative path for display
                    const maxPathLength = 40;
                    const displayPath = file.relative_path.length > maxPathLength 
                        ? '...' + file.relative_path.substring(file.relative_path.length - maxPathLength)
                        : file.relative_path;
                    
                    html += `
                        <div class="file-item" onclick="loadFileContent('${file.relative_path}')" 
                             style="padding: 0.75rem 1rem; margin-bottom: 0.5rem; background: white; cursor: pointer; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s ease;">
                            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
                                <div style="flex: 1; min-width: 0;">
                                    ${tagsHtml ? `<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">${tagsHtml}</div>` : ''}
                                    ${filenameDisplay}
                                    <div style="font-size: 0.75rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.relative_path}">${displayPath}</div>
                                </div>
                                <div style="flex-shrink: 0; font-size: 0.75rem; color: #6b7280; font-weight: 500; text-align: right; margin-top: 0.1rem;">${sizeText}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            filesList.innerHTML = html;
            
            // Add hover effects for file items
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f8fafc';
                    this.style.borderColor = '#3b82f6';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                    this.style.borderColor = '#e5e7eb';
                });
            });
        }

        
        // Check authentication status and show user info
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (data.authenticated) {
                    // Show user info in navbar
                    document.getElementById('userEmail').textContent = data.email;
                    document.getElementById('userInfo').style.display = 'flex';
                    
                    // Show extension list button only for admin users
                    if (data.is_admin) {
                        document.getElementById('extensionListBtn').style.display = 'inline-flex';
                    }
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
            loadExtensionData();
        });
        
        // CodeMirror is ready to use immediately - no initialization needed

        // Verdict modal functions
        function showVerdictModal(event, simulationType, verdict) {
            // Get reasoning from the clicked element's data attribute
            const element = event.target;
            let reasoning = element.getAttribute('data-reasoning');
            
            if (reasoning) {
                // Decode HTML entities
                reasoning = reasoning
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/\\n/g, '\n');
            }
            
            // Process reasoning to extract clean data
            let displayReasoning = reasoning || 'No reasoning available';
            
            // If reasoning contains JSON format, extract just the reasoning text
            const jsonPattern = '```json';
            if (reasoning && typeof reasoning === 'string' && reasoning.indexOf(jsonPattern) !== -1) {
                try {
                    // Extract JSON from markdown format
                    const start = reasoning.indexOf('{');
                    const end = reasoning.lastIndexOf('}') + 1;
                    
                    if (start !== -1 && end !== 0) {
                        const jsonStr = reasoning.substring(start, end);
                        
                        // Try to extract verdict and reasoning using regex (more reliable for malformed JSON)
                        const verdictMatch = jsonStr.match(/"verdict":\s*"([^"]+)"/);
                        const reasoningMatch = jsonStr.match(/"reasoning":\s*"([\s\S]*?)"\s*\n?\s*\}\s*$/);
                        
                        if (verdictMatch && reasoningMatch) {
                            const extractedVerdict = verdictMatch[1];
                            let extractedReasoning = reasoningMatch[1];
                            
                            // Clean up the reasoning text
                            extractedReasoning = extractedReasoning
                                .replace(/\\n/g, '\n')
                                .replace(/\\"/g, '"')
                                .replace(/\\\\/g, '\\')
                                .replace(/\\t/g, '\t');
                            
                            // Use the clean reasoning
                            displayReasoning = extractedReasoning;
                            
                            // Show conflict warning if verdicts don't match
                            if (extractedVerdict !== verdict) {
                                displayReasoning = `‚ö†Ô∏è VERDICT CONFLICT DETECTED!\n\nDatabase verdict: ${verdict.toUpperCase()}\nAnalysis verdict: ${extractedVerdict.toUpperCase()}\n\n${extractedReasoning}`;
                            }
                        } else {
                            // Fall back to original reasoning
                            displayReasoning = reasoning;
                        }
                    }
                } catch (e) {
                    // If JSON parsing fails, use original reasoning
                    displayReasoning = reasoning;
                }
            }
            
            // Escape HTML in displayReasoning to prevent XSS and syntax errors
            const escapedReasoning = displayReasoning
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            // Create simple modal HTML with proper text alignment
            const modalHtml = `
                <div id="verdictModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 10000; display: table;">
                    <div style="display: table-cell; vertical-align: middle; text-align: center;">
                        <div style="display: inline-block; background: white; border-radius: 8px; max-width: 600px; width: 90%; margin: 0 auto; text-align: left; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
                            <div style="padding: 20px; border-bottom: 1px solid #e0e0e0;">
                                <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600; float: left;">
                                    ${simulationType.charAt(0).toUpperCase() + simulationType.slice(1)} Simulation Verdict
                                </h3>
                                <button onclick="closeVerdictModal()" style="float: right; background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 0; line-height: 1;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">
                                    √ó
                                </button>
                                <div style="clear: both;"></div>
                            </div>
                            <div style="padding: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <span style="display: inline-block; padding: 6px 12px; border-radius: 4px; font-weight: 600; font-size: 14px; ${verdict === 'benign' ? 'background: #d1fae5; color: #059669;' : 'background: #dc2626; color: white;'}">
                                        ${verdict.toUpperCase()}
                                    </span>
                                </div>
                                <div id="verdictReasoningContainer" style="color: #333; line-height: 1.5; font-size: 14px; max-height: 300px; overflow-y: auto; padding: 15px; background: #f8f8f8; border-radius: 6px; border: 1px solid #ddd; text-align: left; margin: 0;">
                                    ${escapedReasoning.replace(/\n/g, '<br>').replace(/‚ö†Ô∏è.*?DETECTED!/g, '<div style="color: #dc2626; font-weight: 600; margin-bottom: 10px;">‚ö†Ô∏è VERDICT CONFLICT DETECTED!</div>').replace(/Database verdict:/g, '<strong style="color: #dc2626;">Database verdict:</strong>').replace(/Analysis verdict:/g, '<strong style="color: #059669;">Analysis verdict:</strong>')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Ensure the reasoning text container scrolls to top
                setTimeout(() => {
                    const reasoningContainer = document.getElementById('verdictReasoningContainer');
                    if (reasoningContainer) {
                        reasoningContainer.scrollTop = 0;
                    }
                }, 50);
                
                // Prevent body scroll
                document.body.style.overflow = 'hidden';
            } catch (e) {
                console.error('Error creating modal:', e);
                alert('Error opening verdict modal: ' + e.message);
            }
        }

        function closeVerdictModal() {
            const modal = document.getElementById('verdictModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('verdictModal');
            if (modal && event.target === modal) {
                closeVerdictModal();
            }
        });
function showAnalysisDetails(summary, prevVersion, currVersion) {
    try {
        // Decode HTML entities
        let decodedSummary = summary;
        if (typeof summary === 'string') {
            decodedSummary = summary
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&');
        }

        const popupHtml = `
            <div class="details-popup-overlay" onclick="closeAnalysisDetails()">
                <div class="details-popup-container" onclick="event.stopPropagation()">
                    <div class="details-popup-header">
                        <h3>üìä Analysis Details</h3>
                        <button class="details-popup-close" onclick="closeAnalysisDetails()">&times;</button>
                    </div>
                    <div class="details-popup-body">
                        <h4 style="margin-top: 0; color: #374151;">Version Comparison: ${prevVersion || 'Unknown'} ‚Üí ${currVersion || 'Unknown'}</h4>
                        <pre>${decodedSummary || 'No analysis summary available'}</pre>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', popupHtml);
    } catch (error) {
        console.error('Error showing analysis details:', error);
        alert('Error displaying analysis details: ' + error.message);
    }
}

// Close analysis details popup
function closeAnalysisDetails() {
    const popup = document.querySelector('.details-popup-overlay');
    if (popup) {
        popup.remove();
    }
}

// Close popup on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAnalysisDetails();
    }
});
// Helper function to escape text for JavaScript

    </script>
    
</body>
</html>
